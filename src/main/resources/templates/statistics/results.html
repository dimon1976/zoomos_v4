<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        'Результаты статистики',
        ~{::section},
        ~{::script},
        ~{::style},
        'Результаты статистики',
        ~{::.page-actions}
      )}">
<head>
    <title>Результаты статистики</title>
    <style>
        :root {
            /* Цвета Bootstrap-совместимой палитры */
            --bs-gray-100: #f8f9fa;
            --bs-gray-200: #e9ecef;
            --bs-gray-300: #dee2e6;
            --bs-gray-600: #6c757d;
            --bs-warning-bg: #fff3cd; /* предупреждение */
            --bs-warning-text: #664d03;
            --bs-danger-bg: #f8d7da;   /* критическое */
            --bs-danger-text: #842029;
            --bs-success-bg: #d1e7dd; /* положительное изменение */
            --bs-success-strong-bg: #badbcc; /* сильный рост */
            --bs-success-text: #0f5132;
        }

        /* ===== Фильтры быстрого доступа ===== */
        .filter-controls {
            background-color: var(--bs-gray-100);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--bs-gray-300);
        }

        .filter-controls .btn-group .btn {
            border-radius: 0.375rem;
            margin-right: 2px;
            transition: all 0.2s ease-in-out;
        }

        .filter-controls .btn-group .btn:last-child {
            margin-right: 0;
        }

        .filter-controls .btn-group .btn.active {
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            transform: translateY(-1px);
        }

        .filter-controls .btn-group .btn:hover:not(.active) {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-status {
            font-size: 0.9rem;
            white-space: nowrap;
            font-weight: 500;
        }

        .filter-status span {
            font-weight: 600;
            color: var(--bs-primary);
        }

        /* Скрытие групп */
        .group-hidden {
            display: none !important;
        }

        /* Анимация фильтрации */
        .statistics-table tbody tr {
            transition: opacity 0.3s ease-in-out;
        }

        .statistics-table tbody tr.filtering {
            opacity: 0.5;
        }

        /* ===== Таблица статистики ===== */
        .statistics-table { font-size: 0.9rem; }

        .statistics-table th {
            background-color: var(--bs-gray-100);
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            border: 1px solid var(--bs-gray-300);
        }

        .statistics-table td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid var(--bs-gray-300);
        }

        .statistics-table tbody tr { border-top: 1px solid var(--bs-gray-300); }
        .statistics-table tbody tr:hover { background-color: #f5f5f5; }

        /* Ячейка группы */
        .statistics-table td[rowspan] {
            background-color: var(--bs-gray-200) !important;
            border-right: 2px solid var(--bs-gray-300) !important;
        }
        .statistics-table .group-header {
            background-color: var(--bs-gray-200);
            font-weight: bold;
            vertical-align: middle !important;
            text-align: left;
            padding: 10px;
        }
        /* Визуальное начало группы (JS добавляет .group-start на строку) */
        .statistics-table tbody tr.group-start { border-top: 2px solid var(--bs-gray-600); }

        /* Метрика всегда во 2-й колонке */
        .statistics-table tbody tr td:nth-child(2) { background-color: var(--bs-gray-100); }

        /* Цветовое выделение для одинаковых метрик */
        .metric-highlight-date {
            background-color: #f8d7da !important; /* розовый */
            font-weight: 600;
            border-left: 3px solid #dc3545;
        }
        .metric-highlight-price {
            background-color: #d1ecf1 !important; /* голубой - приоритетный */
            font-weight: 600;
            border-left: 3px solid #17a2b8;
        }
        .metric-highlight-promo {
            background-color: #fff3cd !important; /* желтый */
            font-weight: 600;
            border-left: 3px solid #ffc107;
        }

        /* Подсветка значений для выделенных метрик */
        .metric-highlight-date ~ td {
            background-color: #fff5f5 !important; /* очень светло-розовый */
        }
        .metric-highlight-price ~ td {
            background-color: #e6f7ff !important; /* очень светло-голубой */
        }
        .metric-highlight-promo ~ td {
            background-color: #fffbf0 !important; /* очень светло-желтый */
        }

        .align-middle { vertical-align: middle !important; }

        /* Карточки/панели */
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; }
        .metric-card { transition: transform 0.2s ease; }
        .metric-card:hover { transform: translateY(-2px); }

        .settings-panel { background-color: var(--bs-gray-100); border-radius: 8px; padding: 15px; margin-bottom: 20px; }

        /* Легенда */
        .legend { display: flex; gap: 15px; align-items: center; font-size: 0.9rem; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 16px; height: 16px; border-radius: 3px; border: 1px solid var(--bs-gray-300); }

        /* Состояния метрик (унифицированы под легенду) */
        .metric-value { font-weight: 600; font-size: 1.1rem; }
        .metric-change { font-size: 0.8rem; margin-top: 2px; }
        .change-up   { color: #28a745; }
        .change-down { color: #dc3545; }

        .metric-stable { background-color: var(--bs-gray-100) !important; color: #6c757d; }
        .metric-increase-warning { background-color: var(--bs-success-bg) !important; color: var(--bs-success-text); }
        .metric-increase-critical { background-color: var(--bs-success-strong-bg) !important; color: var(--bs-success-text); }
        .metric-decrease-warning { background-color: var(--bs-warning-bg) !important; color: var(--bs-warning-text); }
        .metric-decrease-critical { background-color: var(--bs-danger-bg) !important; color: var(--bs-danger-text); }

        /* Вертикальные заголовки операций */
        .operation-header { writing-mode: vertical-rl; text-orientation: mixed; min-width: 120px; max-width: 120px; }

        /* Плавающая кнопка экспорта */
        .export-button { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }

        /* Статистика изменений дат */
        .date-mod-normal { background-color: var(--bs-gray-100) !important; color: #6c757d; }
        .date-mod-warning { background-color: var(--bs-warning-bg) !important; color: var(--bs-warning-text); }
        .date-mod-critical { background-color: var(--bs-danger-bg) !important; color: var(--bs-danger-text); }

        /* Итоговая строка "ОБЩЕЕ КОЛИЧЕСТВО" */
        .total-summary-row {
            background-color: #fff3cd !important;
            font-weight: 600;
            border-top: 3px solid #ffc107 !important;
            border-bottom: 3px solid #ffc107 !important;
        }

        .total-summary-header {
            background-color: #ffc107 !important;
            font-size: 1.1rem;
            color: #000 !important;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-right: 3px solid #e0a800 !important;
            padding: 12px !important;
        }

        .total-summary-row td {
            background-color: #fff9e6 !important;
            color: #000 !important;
            border-color: #ffe69c !important;
            padding: 10px !important;
        }

        .total-summary-row td:nth-child(2) {
            background-color: #ffecb3 !important;
            font-weight: 700;
            font-size: 0.95rem;
        }

        /* Подсветка значений для итоговой строки */
        .total-summary-row .metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #000 !important;
        }

        .total-summary-row .metric-change {
            color: #000 !important;
            font-weight: 600;
        }

        /* Отступ между итоговой строкой и остальными группами */
        .statistics-table tbody tr.total-summary-row ~ tr:first-of-type td {
            border-top: 15px solid transparent !important;
        }

        /* ===== Стили для исторических графиков ===== */
        #metricTabs .nav-link {
            font-weight: 600;
            transition: all 0.2s ease;
        }

        #metricTabs .nav-link:hover {
            background-color: var(--bs-gray-100);
        }

        #metricTabs .nav-link.active {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            min-height: 400px;
        }

        /* Карточки графиков */
        .card.shadow-sm {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .card.shadow-sm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Загрузчик графиков */
        .chart-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

    </style>
</head>
<body>
<div class="page-actions">
    <button type="button" class="btn btn-outline-secondary me-2" onclick="toggleSettings()">
        <i class="fas fa-cog me-1"></i>Настройки
    </button>
    <button type="button" class="btn btn-outline-success me-2" onclick="exportToExcel()">
        <i class="fas fa-file-excel me-1"></i>Экспорт в Excel
    </button>
    <a th:href="@{/statistics/client/{id}(id=${clientId})}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Назад
    </a>
</div>

<section>
    <!-- Панель настроек (скрыта классом d-none) -->
    <div id="settingsPanel" class="settings-panel d-none">
        <div class="row align-items-center">
            <div class="col-md-3">
                <label class="form-label">Предупреждение (%):</label>
                <input type="number" id="warningThreshold" class="form-control"
                       th:value="${warningPercentage}" min="1" max="100"
                       onchange="updateThresholds()">
            </div>
            <div class="col-md-3">
                <label class="form-label">Критическое (%):</label>
                <input type="number" id="criticalThreshold" class="form-control"
                       th:value="${criticalPercentage}" min="1" max="100"
                       onchange="updateThresholds()">
            </div>
            <div class="col-md-4">
                <div class="legend">
                    <div class="legend-color" style="background-color: var(--bs-success-bg);"></div>
                    <span>Рост</span>
                        <span>Критическое</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--bs-warning-bg);"></div>
                        <span>Падение (предупреждение)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--bs-danger-bg);"></div>
                        <span>Падение (критическое)</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-primary btn-sm" onclick="applyThresholds()">
                    <i class="fas fa-check me-1"></i>Применить
                </button>
            </div>
        </div>
    </div>

    <!-- Сводная информация -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card summary-card metric-card">
                <div class="card-body text-center">
                    <div class="h4" th:text="${#lists.size(comparison)}">0</div>
                    <div>Групп данных</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white metric-card">
                <div class="card-body text-center">
                    <div class="h4" id="totalOperationsCount">0</div>
                    <div>Операций</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white metric-card">
                <div class="card-body text-center">
                    <div class="h4" id="warningChangesCount">0</div>
                    <div>Предупреждений</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white metric-card">
                <div class="card-body text-center">
                    <div class="h4" id="criticalChangesCount">0</div>
                    <div>Критических</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Компактная статистика изменений дат -->
    <div th:unless="${#lists.isEmpty(comparison)}" id="dateModificationsPanel" class="mb-3">
        <div class="alert alert-info mb-3" style="background-color: #e3f2fd; border-color: #81d4fa; padding: 10px 15px;">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="fas fa-calendar-alt text-info me-2"></i>
                    <strong class="me-2">Изменения дат:</strong>
                    <span id="dateModificationsSummary" class="text-muted">Загрузка...</span>
                </div>
                <div>
                    <button type="button" class="btn btn-link btn-sm p-0 text-info" 
                            data-bs-toggle="collapse" data-bs-target="#dateModificationsDetails" 
                            aria-expanded="false" aria-controls="dateModificationsDetails"
                            title="Показать детали">
                        <i class="fas fa-chevron-down"></i> Детали
                    </button>
                </div>
            </div>
            
            <!-- Развертываемые детали -->
            <div class="collapse mt-2" id="dateModificationsDetails">
                <div id="dateModificationsContent" class="row">
                    <!-- Содержимое будет добавлено через JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Пустое состояние -->
    <div th:if="${#lists.isEmpty(comparison)}" class="text-center py-5">
        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
        <h3>Нет данных для отображения</h3>
        <p class="text-muted">Проверьте выбранные операции и настройки фильтров</p>
    </div>

    <!-- Быстрые фильтры -->
    <div th:unless="${#lists.isEmpty(comparison)}" class="filter-controls mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="btn-group" role="group" aria-label="Фильтры быстрого доступа">
                <button type="button" class="btn btn-outline-warning" id="filterWarning" title="Показать только группы с предупреждениями">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Только предупреждения (<span id="warningCount">0</span>)
                </button>
                <button type="button" class="btn btn-outline-danger" id="filterCritical" title="Показать только группы с критическими отклонениями">
                    <i class="fas fa-exclamation-circle me-1"></i>
                    Только критические (<span id="criticalCount">0</span>)
                </button>
                <button type="button" class="btn btn-outline-dark" id="filterBoth" title="Показать группы с любыми отклонениями">
                    <i class="fas fa-filter me-1"></i>
                    Все отклонения (<span id="bothCount">0</span>)
                </button>
                <button type="button" class="btn btn-outline-secondary" id="filterReset" title="Показать все группы">
                    <i class="fas fa-times me-1"></i>
                    Сброс (<span id="totalCount">0</span>)
                </button>
            </div>
            <div class="filter-status text-muted" id="filterStatus">
                Показано: <span id="visibleGroups">0</span> из <span id="totalGroups">0</span> групп
            </div>
        </div>
    </div>

    <!-- Панель фильтров по полям (показывается если есть поля фильтрации в шаблоне) -->
    <div th:unless="${#lists.isEmpty(comparison)}" id="fieldFilterPanel" class="filter-controls mb-3" style="display: none;">
        <h6 class="mb-3"><i class="fas fa-filter me-2"></i>Фильтрация по полям данных</h6>
        <div class="row align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-bold">Поле фильтрации:</label>
                <select id="filterFieldSelect" class="form-select" onchange="onFilterFieldChange()">
                    <option value="">Выберите поле...</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">Значение:</label>
                <select id="filterValueSelect" class="form-select" disabled onchange="onFilterValueChange()">
                    <option value="">Сначала выберите поле</option>
                </select>
            </div>
            <div class="col-md-4">
                <button type="button" class="btn btn-primary me-2" onclick="applyFilter()" disabled id="applyFilterBtn">
                    <i class="fas fa-check me-1"></i>Применить
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetFilter()">
                    <i class="fas fa-times me-1"></i>Сбросить
                </button>
            </div>
        </div>

        <!-- Индикатор активного фильтра -->
        <div id="activeFilterIndicator" class="alert alert-info mt-3" style="display: none; margin-bottom: 0;">
            <i class="fas fa-filter me-2"></i>
            <strong>Активный фильтр:</strong> <span id="activeFilterText"></span>
            <button type="button" class="btn btn-sm btn-outline-info ms-3" onclick="resetFilter()">
                <i class="fas fa-times me-1"></i>Сбросить
            </button>
        </div>
    </div>

    <!-- Таблица статистики -->
    <div th:unless="${#lists.isEmpty(comparison)}" class="table-responsive">
        <table class="table table-bordered statistics-table">
            <thead>
            <tr>
                <th rowspan="2" style="width: 200px;">Группа</th>
                <th rowspan="2" style="width: 150px;">Метрика</th>
                <th th:each="operation : ${comparison[0].operations}"
                    class="operation-header">
                    <div>
                        <div th:text="'Операция #' + ${operation.operationId}">Операция #1</div>
                        <small th:text="${#temporals.format(operation.exportDate, 'dd.MM HH:mm', T(java.time.ZoneId).systemDefault())}">
                            01.01 10:00
                        </small>
                    </div>
                </th>
            </tr>
            <tr>
                <th th:each="operation : ${comparison[0].operations}" class="text-muted">
                    <small th:text="${operation.operationName}">Операция</small>
                </th>
            </tr>
            </thead>
            <tbody>
            <!-- Итоговая строка "ОБЩЕЕ КОЛИЧЕСТВО" (первый элемент, если это итог) -->
            <th:block th:if="${!#lists.isEmpty(comparison) and comparison[0].groupFieldValue == 'ОБЩЕЕ КОЛИЧЕСТВО'}">
                <th:block th:with="totalGroup=${comparison[0]}, metricsMap=${totalGroup.operations[0].metrics}">
                    <tr th:each="metric, iterStat : ${metricsMap}"
                        th:class="${iterStat.first ? 'total-summary-row group-start' : 'total-summary-row'}">

                        <td th:if="${iterStat.first}"
                            th:rowspan="${metricsMap.size()}"
                            class="total-summary-header"
                            th:text="${totalGroup.groupFieldValue}">ОБЩЕЕ КОЛИЧЕСТВО</td>

                        <!-- Название метрики -->
                        <td class="fw-bold" th:text="${metric.key}">metricName</td>

                        <!-- Значения метрик по операциям -->
                        <td th:each="colOperation : ${comparison[0].operations}">
                            <!-- Находим соответствующую операцию текущей группы -->
                            <th:block th:each="groupOp : ${totalGroup.operations}">
                                <th:block th:if="${groupOp.exportSessionId == colOperation.exportSessionId}">
                                    <th:block th:with="metricValue=${groupOp.metrics[metric.key]}">
                                        <div th:class="${metricValue == null ? 'metric-stable' :
                                            (metricValue.changeType.name() == 'UP'   && metricValue.alertLevel.name() == 'WARNING')  ? 'metric-increase-warning'  :
                                            (metricValue.changeType.name() == 'UP'   && metricValue.alertLevel.name() == 'CRITICAL') ? 'metric-increase-critical' :
                                            (metricValue.changeType.name() == 'DOWN' && metricValue.alertLevel.name() == 'WARNING')  ? 'metric-decrease-warning'  :
                                            (metricValue.changeType.name() == 'DOWN' && metricValue.alertLevel.name() == 'CRITICAL') ? 'metric-decrease-critical' :
                                            'metric-stable'}">

                                            <div class="metric-value"
                                                 th:text="${metricValue != null ? metricValue.currentValue : '-'}">-
                                            </div>

                                            <div th:if="${metricValue != null and metricValue.previousValue != null}"
                                                 class="metric-change">
                                                <span th:attr="data-change=${metricValue.changePercentage}"
                                                      th:classappend="${'change-' + metricValue.changeType.name().toLowerCase()}">
                                                    <i th:class="${metricValue.changeType.name() == 'UP' ? 'fas fa-arrow-up' :
                                                                   metricValue.changeType.name() == 'DOWN' ? 'fas fa-arrow-down' :
                                                                   'fas fa-minus'}"></i>
                                                    <span th:text="${#strings.concat(#numbers.formatDecimal(T(java.lang.Math).abs(metricValue.changePercentage), 1, 1), '%')}">0.0%</span>
                                                </span>
                                            </div>
                                        </div>
                                    </th:block>
                                </th:block>
                            </th:block>
                        </td>
                    </tr>
                </th:block>
            </th:block>

            <!-- Обычные группы (пропускаем первый элемент если это "ОБЩЕЕ КОЛИЧЕСТВО") -->
            <th:block th:each="group : ${comparison}">
                <th:block th:if="${group.groupFieldValue != 'ОБЩЕЕ КОЛИЧЕСТВО' and !#lists.isEmpty(group.operations)}">
                    <th:block th:with="metricsMap=${group.operations[0].metrics}">
                        <!-- Итерируемся по метрикам -->
                        <tr th:each="metric, iterStat : ${metricsMap}">
                            <!-- Ячейка группы в первой строке (rowspan = кол-во метрик) -->
                            <td th:if="${iterStat.first}"
                                th:rowspan="${metricsMap.size()}"
                                class="group-header"
                                th:text="${group.groupFieldValue}">Группа
                            </td>

                            <!-- Название метрики -->
                            <td class="fw-bold" th:text="${metric.key}">metricName</td>

                            <!-- Значения метрик по операциям -->
                            <td th:each="colOperation : ${comparison[0].operations}">
                                <!-- Находим соответствующую операцию текущей группы -->
                                <th:block th:each="groupOp : ${group.operations}">
                                    <th:block th:if="${groupOp.exportSessionId == colOperation.exportSessionId}">
                                        <th:block th:with="metricValue=${groupOp.metrics[metric.key]}">
                                            <!-- Для DATE_MODIFICATIONS инвертируем логику цветов -->
                                            <div th:class="${metricValue == null ? 'metric-stable' :
                                                (metric.key == 'DATE_MODIFICATIONS' ?
                                                    (metricValue.changeType.name() == 'UP'   && metricValue.alertLevel.name() == 'WARNING')  ? 'metric-decrease-warning'  :
                                                    (metricValue.changeType.name() == 'UP'   && metricValue.alertLevel.name() == 'CRITICAL') ? 'metric-decrease-critical' :
                                                    (metricValue.changeType.name() == 'DOWN' && metricValue.alertLevel.name() == 'WARNING')  ? 'metric-increase-warning'  :
                                                    (metricValue.changeType.name() == 'DOWN' && metricValue.alertLevel.name() == 'CRITICAL') ? 'metric-increase-critical' :
                                                    'metric-stable'
                                                :
                                                    (metricValue.changeType.name() == 'UP'   && metricValue.alertLevel.name() == 'WARNING')  ? 'metric-increase-warning'  :
                                                    (metricValue.changeType.name() == 'UP'   && metricValue.alertLevel.name() == 'CRITICAL') ? 'metric-increase-critical' :
                                                    (metricValue.changeType.name() == 'DOWN' && metricValue.alertLevel.name() == 'WARNING')  ? 'metric-decrease-warning'  :
                                                    (metricValue.changeType.name() == 'DOWN' && metricValue.alertLevel.name() == 'CRITICAL') ? 'metric-decrease-critical' :
                                                    'metric-stable'
                                                )}">

                                                <div class="metric-value"
                                                     th:text="${metricValue != null ? metricValue.currentValue : '-'}">-
                                                </div>

                                                <div th:if="${metricValue != null and metricValue.previousValue != null}"
                                                     class="metric-change">
                                                    <!--
                                                      ВАЖНО: data-change содержит числовое значение с точкой (для JS),
                                                      текст может быть локализован (запятая, знак и пр.)
                                                    -->
                                                    <span th:attr="data-change=${metricValue.changePercentage}"
                                                          th:classappend="${'change-' + metricValue.changeType.name().toLowerCase()}">
                                                        <i th:class="${metricValue.changeType.name() == 'UP' ? 'fas fa-arrow-up' :
                                                                       metricValue.changeType.name() == 'DOWN' ? 'fas fa-arrow-down' :
                                                                       'fas fa-minus'}"></i>
                                                        <span th:text="${#strings.concat(#numbers.formatDecimal(T(java.lang.Math).abs(metricValue.changePercentage), 1, 1), '%')}">0.0%</span>
                                                    </span>
                                                </div>
                                            </div>
                                        </th:block>
                                    </th:block>
                                </th:block>
                            </td>
                        </tr>
                    </th:block>
                </th:block>
            </th:block>
            </tbody>
        </table>
    </div>

    <!-- Исторические тренды -->
    <div th:unless="${#lists.isEmpty(comparison)}" class="mt-5">
        <h5 class="mb-4">
            <i class="fas fa-chart-line me-2"></i>Исторические тренды
            <small class="text-muted">(по всем сохраненным операциям)</small>
        </h5>

        <!-- Вкладки для метрик -->
        <ul class="nav nav-tabs" id="metricTabs" role="tablist">
            <!-- Вкладки будут созданы динамически через JavaScript -->
        </ul>

        <!-- Содержимое вкладок -->
        <div class="tab-content mt-4" id="metricTabsContent">
            <!-- Контент вкладок будет создан динамически через JavaScript -->
        </div>
    </div>
</section>

<!-- Плавающая кнопка экспорта -->
<button type="button" class="btn btn-success export-button rounded-circle"
        onclick="exportToExcel()" title="Экспорт в Excel">
    <i class="fas fa-file-excel fa-lg"></i>
</button>

<script src="/js/statistics-results.js"></script>
<script src="/js/statistics-charts.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // Инициализация данных из Thymeleaf
    const statisticsDataFromTemplate = /*[[${comparison}]]*/ [];
    const warningThresholdFromTemplate = /*[[${warningPercentage}]]*/ 10;
    const criticalThresholdFromTemplate = /*[[${criticalPercentage}]]*/ 20;
    const templateId = /*[[${request.templateId}]]*/ null;
    const sessionIds = /*[[${request.exportSessionIds}]]*/ [];
    const activeFilterField = /*[[${filterField}]]*/ null;
    const activeFilterValue = /*[[${filterValue}]]*/ null;

    // Глобальные переменные для хранения данных фильтров
    let filterFieldsData = {};

    document.addEventListener('DOMContentLoaded', () => {
        // Инициализируем данные в загруженном скрипте
        initializeStatisticsData(statisticsDataFromTemplate, warningThresholdFromTemplate, criticalThresholdFromTemplate);

        // Загружаем фильтры если есть templateId и sessionIds
        if (templateId && sessionIds && sessionIds.length > 0) {
            loadFilterFields();
        }

        // Проверяем активный фильтр при загрузке
        checkActiveFilter();

        // Инициализируем графики трендов
        if (templateId && statisticsDataFromTemplate && statisticsDataFromTemplate.length > 0) {
            initializeHistoricalCharts();
        }
    });

    /**
     * Загружает доступные поля фильтрации и их значения с сервера
     */
    async function loadFilterFields() {
        try {
            // Формируем URL для запроса
            const sessionIdsParam = sessionIds.join(',');
            const url = `/statistics/filter-values?templateId=${templateId}&sessionIds=${sessionIdsParam}`;

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Ошибка загрузки фильтров');
            }

            filterFieldsData = await response.json();

            // Если есть поля фильтрации - показываем панель
            if (Object.keys(filterFieldsData).length > 0) {
                document.getElementById('fieldFilterPanel').style.display = 'block';

                // Заполняем select полей фильтрации
                const filterFieldSelect = document.getElementById('filterFieldSelect');
                filterFieldSelect.innerHTML = '<option value="">Выберите поле...</option>';

                for (const [fieldName, values] of Object.entries(filterFieldsData)) {
                    const option = document.createElement('option');
                    option.value = fieldName;
                    option.textContent = fieldName;
                    filterFieldSelect.appendChild(option);
                }

                // Если есть активный фильтр - восстанавливаем его
                if (activeFilterField && filterFieldsData[activeFilterField]) {
                    filterFieldSelect.value = activeFilterField;
                    onFilterFieldChange();
                }
            }
        } catch (error) {
            console.error('Ошибка загрузки фильтров:', error);
        }
    }

    /**
     * Обработчик изменения поля фильтрации
     */
    function onFilterFieldChange() {
        const filterFieldSelect = document.getElementById('filterFieldSelect');
        const filterValueSelect = document.getElementById('filterValueSelect');
        const selectedField = filterFieldSelect.value;

        if (!selectedField) {
            // Сброс выбора
            filterValueSelect.innerHTML = '<option value="">Сначала выберите поле</option>';
            filterValueSelect.disabled = true;
            document.getElementById('applyFilterBtn').disabled = true;
            return;
        }

        // Заполняем select значений
        const values = filterFieldsData[selectedField] || [];
        filterValueSelect.innerHTML = '<option value="">Выберите значение...</option>';

        values.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            filterValueSelect.appendChild(option);
        });

        filterValueSelect.disabled = false;

        // Если есть активное значение - восстанавливаем его
        if (activeFilterField === selectedField && activeFilterValue) {
            filterValueSelect.value = activeFilterValue;
            document.getElementById('applyFilterBtn').disabled = false;
        }
    }

    /**
     * Обработчик изменения значения фильтра
     */
    function onFilterValueChange() {
        const filterValueSelect = document.getElementById('filterValueSelect');
        const selectedValue = filterValueSelect.value;

        // Активируем кнопку "Применить" только если выбрано значение
        document.getElementById('applyFilterBtn').disabled = !selectedValue;
    }

    /**
     * Применяет выбранный фильтр (отправляет POST-запрос с формой)
     */
    function applyFilter() {
        const filterField = document.getElementById('filterFieldSelect').value;
        const filterValue = document.getElementById('filterValueSelect').value;

        if (!filterField || !filterValue) {
            alert('Пожалуйста, выберите поле и значение фильтра');
            return;
        }

        // Создаём форму для POST-запроса
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/statistics/analyze';

        // Добавляем существующие параметры из request
        const addHiddenField = (name, value) => {
            if (value !== null && value !== undefined) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            }
        };

        // Передаём templateId
        addHiddenField('templateId', templateId);

        // Передаём exportSessionIds (массив)
        if (sessionIds && sessionIds.length > 0) {
            sessionIds.forEach(id => {
                addHiddenField('exportSessionIds', id);
            });
        }

        // Передаём пороги предупреждений
        addHiddenField('warningPercentage', warningThresholdFromTemplate);
        addHiddenField('criticalPercentage', criticalThresholdFromTemplate);

        // Добавляем параметры фильтра
        addHiddenField('filterField', filterField);
        addHiddenField('filterValue', filterValue);

        // Отправляем форму
        document.body.appendChild(form);
        form.submit();
    }

    /**
     * Сбрасывает фильтр (отправляет POST-запрос без параметров фильтра)
     */
    function resetFilter() {
        // Создаём форму для POST-запроса
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/statistics/analyze';

        // Добавляем существующие параметры из request
        const addHiddenField = (name, value) => {
            if (value !== null && value !== undefined) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            }
        };

        // Передаём templateId
        addHiddenField('templateId', templateId);

        // Передаём exportSessionIds (массив)
        if (sessionIds && sessionIds.length > 0) {
            sessionIds.forEach(id => {
                addHiddenField('exportSessionIds', id);
            });
        }

        // Передаём пороги предупреждений
        addHiddenField('warningPercentage', warningThresholdFromTemplate);
        addHiddenField('criticalPercentage', criticalThresholdFromTemplate);

        // НЕ добавляем filterField и filterValue - это и есть сброс

        // Отправляем форму
        document.body.appendChild(form);
        form.submit();
    }

    /**
     * Проверяет и показывает индикатор активного фильтра при загрузке
     */
    function checkActiveFilter() {
        if (activeFilterField && activeFilterValue) {
            const indicator = document.getElementById('activeFilterIndicator');
            const indicatorText = document.getElementById('activeFilterText');

            indicatorText.textContent = `${activeFilterField} = "${activeFilterValue}"`;
            indicator.style.display = 'block';
        }
    }

    /**
     * Инициализирует исторические графики трендов
     */
    async function initializeHistoricalCharts() {
        try {
            console.log('Инициализация исторических графиков...');

            // Получаем список доступных метрик с сервера
            const metricsResponse = await fetch(`/statistics/metrics?templateId=${templateId}`);
            if (!metricsResponse.ok) {
                throw new Error('Ошибка загрузки списка метрик');
            }
            const metrics = await metricsResponse.json();

            if (!metrics || metrics.length === 0) {
                console.warn('Нет доступных метрик для отображения графиков');
                return;
            }

            console.log('Найдено метрик:', metrics.length, metrics);

            // Создаем вкладки для каждой метрики
            const metricTabs = document.getElementById('metricTabs');
            const metricTabsContent = document.getElementById('metricTabsContent');

            if (!metricTabs || !metricTabsContent) {
                console.error('Контейнеры для вкладок не найдены');
                return;
            }

            // Очищаем контейнеры
            metricTabs.innerHTML = '';
            metricTabsContent.innerHTML = '';

            // Создаем вкладку для каждой метрики
            metrics.forEach((metricName, index) => {
                const isFirst = index === 0;
                const metricId = `metric-${metricName.replace(/[^a-zA-Z0-9]/g, '-')}`;

                // Создаем таб
                const tab = document.createElement('li');
                tab.className = 'nav-item';
                tab.innerHTML = `
                    <button class="nav-link ${isFirst ? 'active' : ''}"
                            id="${metricId}-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#${metricId}"
                            type="button"
                            role="tab"
                            aria-controls="${metricId}"
                            aria-selected="${isFirst}">
                        ${metricName}
                    </button>
                `;
                metricTabs.appendChild(tab);

                // Создаем контент вкладки
                const tabPane = document.createElement('div');
                tabPane.className = `tab-pane fade ${isFirst ? 'show active' : ''}`;
                tabPane.id = metricId;
                tabPane.setAttribute('role', 'tabpanel');
                tabPane.setAttribute('aria-labelledby', `${metricId}-tab`);
                tabPane.innerHTML = `
                    <div class="row" id="${metricId}-charts">
                        <!-- Графики будут загружены здесь -->
                    </div>
                `;
                metricTabsContent.appendChild(tabPane);

                // Загружаем графики при переключении на вкладку
                const tabButton = tab.querySelector('.nav-link');
                tabButton.addEventListener('shown.bs.tab', async () => {
                    const chartsContainer = document.getElementById(`${metricId}-charts`);
                    // Проверяем, не загружены ли уже графики
                    if (chartsContainer.children.length === 0) {
                        await loadMetricCharts(metricName, `#${metricId}-charts`);
                    }
                });

                // Загружаем графики для первой вкладки сразу
                if (isFirst) {
                    setTimeout(() => {
                        loadMetricCharts(metricName, `#${metricId}-charts`);
                    }, 100);
                }
            });

        } catch (error) {
            console.error('Ошибка инициализации исторических графиков:', error);
        }
    }

    /**
     * Загружает графики для конкретной метрики
     */
    async function loadMetricCharts(metricName, containerSelector) {
        try {
            console.log(`Загрузка графиков для метрики: ${metricName}`);

            // Показываем индикатор загрузки
            const container = document.querySelector(containerSelector);
            if (!container) {
                console.error('Container not found:', containerSelector);
                return;
            }

            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка графиков...</span>
                    </div>
                    <p class="text-muted mt-2">Загрузка исторических данных...</p>
                </div>
            `;

            // Загружаем графики в сеточном виде - отдельный график для каждой группы
            await loadAllGroupsCharts(
                containerSelector,
                templateId,
                metricName,
                activeFilterField,
                activeFilterValue,
                50 // лимит точек на график
            );

        } catch (error) {
            console.error('Ошибка загрузки графиков метрики:', error);
            const container = document.querySelector(containerSelector);
            if (container) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Ошибка загрузки графиков: ${error.message}
                        </div>
                    </div>
                `;
            }
        }
    }

    /*]]>*/
</script>

</body>
</html>