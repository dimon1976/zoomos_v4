<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        'Результаты статистики',
        ~{::section},
        ~{::script},
        ~{::style},
        'Результаты статистики',
        ~{::.page-actions}
      )}">
<head>
    <title>Результаты статистики</title>
    <style>
        :root {
            /* Цвета Bootstrap-совместимой палитры */
            --bs-gray-100: #f8f9fa;
            --bs-gray-200: #e9ecef;
            --bs-gray-300: #dee2e6;
            --bs-gray-600: #6c757d;
            --bs-warning-bg: #fff3cd; /* предупреждение */
            --bs-warning-text: #664d03;
            --bs-danger-bg: #f8d7da;   /* критическое */
            --bs-danger-text: #842029;
        }

        /* ===== Таблица статистики ===== */
        .statistics-table { font-size: 0.9rem; }

        .statistics-table th {
            background-color: var(--bs-gray-100);
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            border: 1px solid var(--bs-gray-300);
        }

        .statistics-table td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid var(--bs-gray-300);
        }

        .statistics-table tbody tr { border-top: 1px solid var(--bs-gray-300); }
        .statistics-table tbody tr:hover { background-color: #f5f5f5; }

        /* Ячейка группы */
        .statistics-table td[rowspan] {
            background-color: var(--bs-gray-200) !important;
            border-right: 2px solid var(--bs-gray-300) !important;
        }
        .statistics-table .group-header {
            background-color: var(--bs-gray-200);
            font-weight: bold;
            vertical-align: middle !important;
            text-align: left;
            padding: 10px;
        }
        /* Визуальное начало группы (JS добавляет .group-start на строку) */
        .statistics-table tbody tr.group-start { border-top: 2px solid var(--bs-gray-600); }

        /* Метрика всегда во 2-й колонке */
        .statistics-table tbody tr td:nth-child(2) { background-color: var(--bs-gray-100); }

        .align-middle { vertical-align: middle !important; }

        /* Карточки/панели */
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; }
        .metric-card { transition: transform 0.2s ease; }
        .metric-card:hover { transform: translateY(-2px); }

        .settings-panel { background-color: var(--bs-gray-100); border-radius: 8px; padding: 15px; margin-bottom: 20px; }

        /* Легенда */
        .legend { display: flex; gap: 15px; align-items: center; font-size: 0.9rem; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 16px; height: 16px; border-radius: 3px; border: 1px solid var(--bs-gray-300); }

        /* Состояния метрик (унифицированы под легенду) */
        .metric-value { font-weight: 600; font-size: 1.1rem; }
        .metric-change { font-size: 0.8rem; margin-top: 2px; }
        .change-up   { color: #28a745; }
        .change-down { color: #dc3545; }

        .metric-stable { background-color: var(--bs-gray-100) !important; color: #6c757d; }
        .metric-increase-warning,
        .metric-decrease-warning { background-color: var(--bs-warning-bg) !important; color: var(--bs-warning-text); }
        .metric-increase-critical,
        .metric-decrease-critical { background-color: var(--bs-danger-bg) !important; color: var(--bs-danger-text); }

        /* Вертикальные заголовки операций */
        .operation-header { writing-mode: vertical-rl; text-orientation: mixed; min-width: 120px; max-width: 120px; }

        /* Плавающая кнопка экспорта */
        .export-button { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    </style>
</head>
<body>
<div class="page-actions">
    <button type="button" class="btn btn-outline-secondary me-2" onclick="toggleSettings()">
        <i class="fas fa-cog me-1"></i>Настройки
    </button>
    <button type="button" class="btn btn-outline-success me-2" onclick="exportToExcel()">
        <i class="fas fa-file-excel me-1"></i>Экспорт в Excel
    </button>
    <a th:href="@{/statistics/client/{id}(id=${clientId})}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Назад
    </a>
</div>

<section>
    <!-- Панель настроек (скрыта классом d-none) -->
    <div id="settingsPanel" class="settings-panel d-none">
        <div class="row align-items-center">
            <div class="col-md-3">
                <label class="form-label">Предупреждение (%):</label>
                <input type="number" id="warningThreshold" class="form-control"
                       th:value="${warningPercentage}" min="1" max="100"
                       onchange="updateThresholds()">
            </div>
            <div class="col-md-3">
                <label class="form-label">Критическое (%):</label>
                <input type="number" id="criticalThreshold" class="form-control"
                       th:value="${criticalPercentage}" min="1" max="100"
                       onchange="updateThresholds()">
            </div>
            <div class="col-md-4">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--bs-warning-bg);"></div>
                        <span>Предупреждение</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--bs-danger-bg);"></div>
                        <span>Критическое</span>
                    </div>
                    <div class="legend-item">
                        <i class="fas fa-arrow-up change-up"></i>
                        <span>Рост</span>
                    </div>
                    <div class="legend-item">
                        <i class="fas fa-arrow-down change-down"></i>
                        <span>Падение</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-primary btn-sm" onclick="applyThresholds()">
                    <i class="fas fa-check me-1"></i>Применить
                </button>
            </div>
        </div>
    </div>

    <!-- Сводная информация -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card summary-card metric-card">
                <div class="card-body text-center">
                    <div class="h4" th:text="${#lists.size(comparison)}">0</div>
                    <div>Групп данных</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white metric-card">
                <div class="card-body text-center">
                    <div class="h4" id="totalOperationsCount">0</div>
                    <div>Операций</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white metric-card">
                <div class="card-body text-center">
                    <div class="h4" id="warningChangesCount">0</div>
                    <div>Предупреждений</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white metric-card">
                <div class="card-body text-center">
                    <div class="h4" id="criticalChangesCount">0</div>
                    <div>Критических</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Пустое состояние -->
    <div th:if="${#lists.isEmpty(comparison)}" class="text-center py-5">
        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
        <h3>Нет данных для отображения</h3>
        <p class="text-muted">Проверьте выбранные операции и настройки фильтров</p>
    </div>

    <!-- Таблица статистики -->
    <div th:unless="${#lists.isEmpty(comparison)}" class="table-responsive">
        <table class="table table-bordered statistics-table">
            <thead>
            <tr>
                <th rowspan="2" style="width: 200px;">Группа</th>
                <th rowspan="2" style="width: 150px;">Метрика</th>
                <th th:each="operation : ${comparison[0].operations}"
                    class="operation-header">
                    <div>
                        <div th:text="'Экспорт #' + ${operation.exportSessionId}">Экспорт #1</div>
                        <small th:text="${#temporals.format(operation.exportDate, 'dd.MM HH:mm')}">
                            01.01 10:00
                        </small>
                    </div>
                </th>
            </tr>
            <tr>
                <th th:each="operation : ${comparison[0].operations}" class="text-muted">
                    <small th:text="${operation.operationName}">Операция</small>
                </th>
            </tr>
            </thead>
            <tbody>
            <th:block th:each="group : ${comparison}">
                <th:block th:if="${!#lists.isEmpty(group.operations)}">
                    <th:block th:with="metricsMap=${group.operations[0].metrics}">
                        <!-- Итерируемся по метрикам -->
                        <tr th:each="metric, iterStat : ${metricsMap}">
                            <!-- Ячейка группы в первой строке (rowspan = кол-во метрик) -->
                            <td th:if="${iterStat.first}"
                                th:rowspan="${metricsMap.size()}"
                                class="group-header"
                                th:text="${group.groupFieldValue}">Группа
                            </td>

                            <!-- Название метрики -->
                            <td class="fw-bold" th:text="${metric.key}">metricName</td>

                            <!-- Значения метрик по операциям -->
                            <td th:each="colOperation : ${comparison[0].operations}">
                                <!-- Находим соответствующую операцию текущей группы -->
                                <th:block th:each="groupOp : ${group.operations}">
                                    <th:block th:if="${groupOp.exportSessionId == colOperation.exportSessionId}">
                                        <th:block th:with="metricValue=${groupOp.metrics[metric.key]}">
                                            <div th:class="${metricValue == null ? 'metric-stable' :
                                                (metricValue.changeType.name() == 'UP'   && metricValue.alertLevel.name() == 'WARNING')  ? 'metric-increase-warning'  :
                                                (metricValue.changeType.name() == 'UP'   && metricValue.alertLevel.name() == 'CRITICAL') ? 'metric-increase-critical' :
                                                (metricValue.changeType.name() == 'DOWN' && metricValue.alertLevel.name() == 'WARNING')  ? 'metric-decrease-warning'  :
                                                (metricValue.changeType.name() == 'DOWN' && metricValue.alertLevel.name() == 'CRITICAL') ? 'metric-decrease-critical' :
                                                'metric-stable'}">

                                                <div class="metric-value"
                                                     th:text="${metricValue != null ? metricValue.currentValue : '-'}">-
                                                </div>

                                                <div th:if="${metricValue != null and metricValue.previousValue != null}"
                                                     class="metric-change">
                                                    <!--
                                                      ВАЖНО: data-change содержит числовое значение с точкой (для JS),
                                                      текст может быть локализован (запятая, знак и пр.)
                                                    -->
                                                    <span th:attr="data-change=${metricValue.changePercentage}"
                                                          th:classappend="${'change-' + metricValue.changeType.name().toLowerCase()}">
                                                        <i th:class="${metricValue.changeType.name() == 'UP' ? 'fas fa-arrow-up' :
                                                                       metricValue.changeType.name() == 'DOWN' ? 'fas fa-arrow-down' :
                                                                       'fas fa-minus'}"></i>
                                                        <span th:text="${#strings.concat(#numbers.formatDecimal(T(java.lang.Math).abs(metricValue.changePercentage), 1, 1), '%')}">0.0%</span>
                                                    </span>
                                                </div>
                                            </div>
                                        </th:block>
                                    </th:block>
                                </th:block>
                            </td>
                        </tr>
                    </th:block>
                </th:block>
            </th:block>
            </tbody>
        </table>
    </div>

    <!-- Детальная информация (аккордеон) -->
    <div th:unless="${#lists.isEmpty(comparison)}" class="mt-4">
        <h5>Детальная информация</h5>
        <div class="accordion" id="detailsAccordion">
            <div th:each="group, groupStat : ${comparison}" class="accordion-item">
                <h2 class="accordion-header" th:id="'heading' + ${groupStat.index}">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            th:data-bs-target="'#collapse' + ${groupStat.index}"
                            th:aria-controls="'collapse' + ${groupStat.index}">
                        <strong th:text="${group.groupFieldValue}">Группа</strong>
                        <span class="ms-auto me-3">
                            <small class="text-muted" th:text="${#lists.size(group.operations)} + ' операций'">3 операции</small>
                        </span>
                    </button>
                </h2>
                <div th:id="'collapse' + ${groupStat.index}"
                     class="accordion-collapse collapse"
                     th:aria-labelledby="'heading' + ${groupStat.index}">
                    <div class="accordion-body">
                        <div class="row">
                            <div th:each="operation : ${group.operations}" class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Экспорт #<span th:text="${operation.exportSessionId}">1</span></h6>
                                        <small class="text-muted"
                                               th:text="${#temporals.format(operation.exportDate, 'dd.MM.yyyy HH:mm')}">01.01.2025 10:00</small>
                                    </div>
                                    <div class="card-body">
                                        <div th:each="metric : ${operation.metrics}" class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <span th:text="${metric.key}">Метрика:</span>
                                                <strong th:text="${metric.value.currentValue}">100</strong>
                                            </div>
                                            <div th:if="${metric.value.previousValue != null}" class="text-muted small">
                                                Изменение:
                                                <span th:classappend="${'change-' + metric.value.changeType.name().toLowerCase()}"
                                                      th:text="${#numbers.formatDecimal(metric.value.changePercentage, 1, 1)} + '%'">+5.0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Плавающая кнопка экспорта -->
<button type="button" class="btn btn-success export-button rounded-circle"
        onclick="exportToExcel()" title="Экспорт в Excel">
    <i class="fas fa-file-excel fa-lg"></i>
</button>

<script th:inline="javascript">
    /*<![CDATA[*/
    const statisticsData = /*[[${comparison}]]*/ [];
    let currentWarningThreshold = /*[[${warningPercentage}]]*/ 10;
    let currentCriticalThreshold = /*[[${criticalPercentage}]]*/ 20;

    document.addEventListener('DOMContentLoaded', () => {
        addGroupStartClass();
        updateSummaryCounters();
    });

    function toggleSettings() {
        const panel = document.getElementById('settingsPanel');
        panel.classList.toggle('d-none');
    }

    function validateThresholdValue(val, fallback) {
        const n = Number.parseInt(String(val), 10);
        return Number.isFinite(n) ? Math.min(100, Math.max(1, n)) : fallback;
    }

    function updateThresholds() {
        const warningEl = document.getElementById('warningThreshold');
        const criticalEl = document.getElementById('criticalThreshold');
        const warning = validateThresholdValue(warningEl.value, currentWarningThreshold);
        const critical = validateThresholdValue(criticalEl.value, currentCriticalThreshold);

        if (warning >= critical) {
            alert('Процент предупреждения должен быть меньше критического');
            warningEl.value = currentWarningThreshold;
            criticalEl.value = currentCriticalThreshold;
        }
    }

    function applyThresholds() {
        const warning = validateThresholdValue(document.getElementById('warningThreshold').value, currentWarningThreshold);
        const critical = validateThresholdValue(document.getElementById('criticalThreshold').value, currentCriticalThreshold);

        if (warning >= critical) {
            alert('Процент предупреждения должен быть меньше критического');
            return;
        }

        currentWarningThreshold = warning;
        currentCriticalThreshold = critical;

        recalculateAlertLevels();
        updateSummaryCounters();
        showNotification('Пороги отклонений обновлены', 'success');
    }

    function recalculateAlertLevels() {
        const cells = document.querySelectorAll('.statistics-table tbody td');
        cells.forEach(cell => {
            cell.classList.remove(
                'metric-increase-warning','metric-increase-critical',
                'metric-decrease-warning','metric-decrease-critical',
                'metric-stable'
            );

            const changeWrapper = cell.querySelector('.metric-change span');
            if (!changeWrapper) { cell.classList.add('metric-stable'); return; }

            // Берём числовое значение из data-change, чтобы не зависеть от локали
            const raw = changeWrapper.getAttribute('data-change');
            const val = raw === null ? NaN : Number(raw);
            if (!Number.isFinite(val) || val === 0) { cell.classList.add('metric-stable'); return; }

            const abs = Math.abs(val);
            const isUp = val > 0;

            if (abs >= currentCriticalThreshold) {
                cell.classList.add(isUp ? 'metric-increase-critical' : 'metric-decrease-critical');
            } else if (abs >= currentWarningThreshold) {
                cell.classList.add(isUp ? 'metric-increase-warning' : 'metric-decrease-warning');
            } else {
                cell.classList.add('metric-stable');
            }
        });
    }

    function updateSummaryCounters() {
        const warningCells = document.querySelectorAll('.metric-increase-warning, .metric-decrease-warning').length;
        const criticalCells = document.querySelectorAll('.metric-increase-critical, .metric-decrease-critical').length;
        const fromData = statisticsData && statisticsData[0] && Array.isArray(statisticsData[0].operations)
            ? statisticsData[0].operations.length
            : null;
        const fromDom = document.querySelectorAll('thead .operation-header').length;
        const totalOperations = fromData ?? fromDom;

        const totalEl = document.getElementById('totalOperationsCount');
        if (totalEl) totalEl.textContent = String(totalOperations);
        const warnEl = document.getElementById('warningChangesCount');
        if (warnEl) warnEl.textContent = String(warningCells);
        const critEl = document.getElementById('criticalChangesCount');
        if (critEl) critEl.textContent = String(criticalCells);
    }

    function exportToExcel() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/statistics/export/excel';
        form.style.display = 'none';

        const dataInput = document.createElement('input');
        dataInput.name = 'statisticsData';
        try { dataInput.value = JSON.stringify(statisticsData); } catch (_) { dataInput.value = '[]'; }
        form.appendChild(dataInput);

        const settingsInput = document.createElement('input');
        settingsInput.name = 'settings';
        settingsInput.value = JSON.stringify({
            warningThreshold: currentWarningThreshold,
            criticalThreshold: currentCriticalThreshold
        });
        form.appendChild(settingsInput);

        document.body.appendChild(form);
        form.submit();
        form.remove();

        showNotification('Экспорт в Excel запущен', 'info');
    }

    function showNotification(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.setAttribute('role', 'alert');
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" aria-label="Закрыть" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => { if (alert.parentElement) alert.remove(); }, 5000);
    }

    function addGroupStartClass() {
        document.querySelectorAll('.statistics-table tbody tr').forEach(tr => {
            if (tr.querySelector('td[rowspan]')) tr.classList.add('group-start');
        });
    }
    /*]]>*/
</script>
</body>
</html>