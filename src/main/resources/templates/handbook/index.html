<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        title='Справочник штрихкодов',
        content=~{::content},
        scripts=~{::scripts},
        styles=~{::styles},
        pageTitle='Справочник штрихкодов',
        pageActions=~{::pageActions}
      )}">
<head><title>Справочник штрихкодов</title></head>

<th:block th:fragment="styles">
    <style>
        .match-badge { font-size: 0.7em; vertical-align: middle; }
        #searchResults td { vertical-align: top; font-size: 0.85em; }
        .url-cell { max-width: 320px; word-break: break-all; }
    </style>
</th:block>
<th:block th:fragment="pageActions"></th:block>
<th:block th:fragment="scripts">
<script>
    const lookupInput   = document.getElementById('lookupInput');
    const lookupBtn     = document.getElementById('lookupBtn');
    const lookupClear   = document.getElementById('lookupClear');
    const lookupStatus  = document.getElementById('lookupStatus');
    const resultsWrap   = document.getElementById('lookupResultsWrap');
    const resultsBody   = document.getElementById('searchResults');

    const matchLabels = { barcode: 'ШК', name: 'Наим.', url: 'URL' };
    const matchColors = { barcode: 'primary', name: 'success', url: 'info' };

    function doSearch() {
        const q = lookupInput.value.trim();
        if (!q) return;

        lookupBtn.disabled = true;
        lookupStatus.textContent = 'Поиск...';
        lookupStatus.classList.remove('d-none');
        resultsWrap.classList.add('d-none');

        fetch('/handbook/lookup?q=' + encodeURIComponent(q))
            .then(r => r.json())
            .then(data => {
                resultsBody.innerHTML = '';
                if (data.length === 0) {
                    lookupStatus.textContent = 'Ничего не найдено.';
                } else {
                    lookupStatus.textContent = 'Найдено: ' + data.length + ' продукт(ов)';
                    data.forEach(p => {
                        const urls = p.urls || [];
                        const rowCount = Math.max(urls.length, 1);
                        urls.forEach((u, ui) => {
                            const tr = document.createElement('tr');
                            if (ui === 0) {
                                const label = matchLabels[p.matchedBy] || p.matchedBy;
                                const color = matchColors[p.matchedBy] || 'secondary';
                                tr.innerHTML = `
                                    <td rowspan="${rowCount}">${p.barcode || '<span class="text-muted">—</span>'}</td>
                                    <td rowspan="${rowCount}">${p.brand || '<span class="text-muted">—</span>'}</td>
                                    <td rowspan="${rowCount}">${(p.names || []).join('<br>')}</td>
                                    <td class="url-cell">${u.domain ? '<span class="text-muted small">' + u.domain + '</span><br>' : ''}<a href="${u.url}" target="_blank" rel="noopener">${u.url}</a></td>
                                    <td rowspan="${rowCount}"><span class="badge bg-${color} match-badge">${label}</span></td>`;
                            } else {
                                tr.innerHTML = `<td class="url-cell">${u.domain ? '<span class="text-muted small">' + u.domain + '</span><br>' : ''}<a href="${u.url}" target="_blank" rel="noopener">${u.url}</a></td>`;
                            }
                            resultsBody.appendChild(tr);
                        });
                        if (urls.length === 0) {
                            const label = matchLabels[p.matchedBy] || p.matchedBy;
                            const color = matchColors[p.matchedBy] || 'secondary';
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${p.barcode || '<span class="text-muted">—</span>'}</td>
                                <td>${p.brand || '<span class="text-muted">—</span>'}</td>
                                <td>${(p.names || []).join('<br>')}</td>
                                <td class="text-muted small">Ссылок нет</td>
                                <td><span class="badge bg-${color} match-badge">${label}</span></td>`;
                            resultsBody.appendChild(tr);
                        }
                    });
                    resultsWrap.classList.remove('d-none');
                }
            })
            .catch(() => { lookupStatus.textContent = 'Ошибка запроса.'; })
            .finally(() => { lookupBtn.disabled = false; });
    }

    lookupBtn.addEventListener('click', doSearch);
    lookupInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
    lookupClear.addEventListener('click', () => {
        lookupInput.value = '';
        lookupStatus.classList.add('d-none');
        resultsWrap.classList.add('d-none');
        resultsBody.innerHTML = '';
        lookupInput.focus();
    });
</script>
</th:block>

<th:block th:fragment="content">
<div class="container-fluid">

    <!-- Статистика -->
    <div class="row mb-4" th:if="${stats}">
        <div class="col-6 col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body py-2">
                    <div class="fs-4 fw-bold text-primary" th:text="${stats.products}">0</div>
                    <small class="text-muted">Продуктов</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-success">
                <div class="card-body py-2">
                    <div class="fs-4 fw-bold text-success" th:text="${stats.names}">0</div>
                    <small class="text-muted">Наименований</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-info">
                <div class="card-body py-2">
                    <div class="fs-4 fw-bold text-info" th:text="${stats.urls}">0</div>
                    <small class="text-muted">Ссылок</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body py-2">
                    <div class="fs-4 fw-bold text-warning" th:text="${stats.domains}">0</div>
                    <small class="text-muted">Доменов</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Поиск по справочнику -->
    <div class="card mb-4">
        <div class="card-header"><i class="fas fa-search me-2"></i>Проверка данных в справочнике</div>
        <div class="card-body">
            <div class="input-group mb-3">
                <input type="text" id="lookupInput" class="form-control"
                       placeholder="Штрихкод, наименование (часть) или URL (часть)..."
                       autocomplete="off">
                <button class="btn btn-primary" id="lookupBtn" type="button">
                    <i class="fas fa-search me-1"></i>Найти
                </button>
                <button class="btn btn-outline-secondary" id="lookupClear" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="lookupStatus" class="text-muted small mb-2 d-none"></div>
            <div class="table-responsive d-none" id="lookupResultsWrap">
                <table class="table table-sm table-hover table-bordered mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Штрихкод</th>
                            <th>Бренд</th>
                            <th>Наименования</th>
                            <th>Домен / URL</th>
                            <th style="width:80px">Найдено по</th>
                        </tr>
                    </thead>
                    <tbody id="searchResults"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Действия -->
    <div class="row g-3">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-file-import me-2 text-primary"></i>Импорт данных</h5>
                    <p class="card-text text-muted">Добавление штрихкодов, наименований и ссылок через стандартный механизм импорта.</p>
                    <a th:href="@{/handbook/import}" class="btn btn-primary">
                        <i class="fas fa-info-circle me-1"></i>Инструкция по импорту
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-search me-2 text-success"></i>Поиск по справочнику</h5>
                    <p class="card-text text-muted">Загрузите файл с ID и штрихкодами/наименованиями — получите ссылки из справочника.</p>
                    <a th:href="@{/handbook/search}" class="btn btn-success">
                        <i class="fas fa-search me-1"></i>Начать поиск
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-globe me-2 text-warning"></i>Управление доменами</h5>
                    <p class="card-text text-muted">Просмотр и управление доменами сайтов. Включение/отключение доменов для фильтрации.</p>
                    <a th:href="@{/handbook/domains}" class="btn btn-warning">
                        <i class="fas fa-globe me-1"></i>Управление доменами
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>
</th:block>
</html>
