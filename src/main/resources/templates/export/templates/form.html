<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(${template.id != null ? 'Редактирование шаблона экспорта' : 'Новый шаблон экспорта'}, ~{::section}, ~{::script}, ~{::style}, ${template.id != null ? 'Редактирование шаблона' : 'Новый шаблон'}, ~{::.page-actions})}">
<head>
    <title th:text="${template.id != null ? 'Редактирование шаблона экспорта' : 'Новый шаблон экспорта'}">Шаблон экспорта</title>
    <style></style>
</head>
<body>
<div class="page-actions">
    <a th:href="${template.id != null} ? @{/export/templates/{id}(id=${template.id})} : @{/clients/{id}(id=${clientId})}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Назад
    </a>
</div>

<section>
    <form th:action="${template.id != null} ? @{/export/templates/{id}/edit(id=${template.id})} : @{/export/templates/create}"
          th:object="${template}" method="post">
        <input type="hidden" th:field="*{id}"/>
        <input type="hidden" th:field="*{clientId}"/>
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Основные параметры</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label required-field">Название шаблона</label>
                        <input type="text" id="name" class="form-control" th:field="*{name}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="entityType" class="form-label required-field">Тип сущности</label>
                        <select id="entityType" class="form-select" th:field="*{entityType}" required>
                            <option value="">-- Выберите тип --</option>
                            <option th:each="type : ${T(com.java.model.enums.EntityType).values()}"
                                    th:value="${type}" th:text="${type.displayName}">Тип</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="exportStrategy" class="form-label required-field">Стратегия экспорта</label>
                        <select id="exportStrategy" class="form-select" th:field="*{exportStrategy}" required>
                            <option value="">-- Выберите стратегию --</option>
                            <option th:each="strategy : ${T(com.java.model.enums.ExportStrategy).values()}"
                                    th:value="${strategy}" th:text="${strategy.displayName}">Стратегия</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="fileFormat" class="form-label required-field">Формат файла</label>
                        <select id="fileFormat" class="form-select" th:field="*{fileFormat}" required>
                            <option value="CSV">CSV</option>
                            <option value="XLSX">XLSX</option>
                            <option value="XLS">XLS</option>
                            <option value="TXT">TXT</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <div id="csvSettings" class="row g-3 mt-0">
                            <div class="col-md-4">
                                <label for="csvEncoding" class="form-label">Кодировка</label>
                                <select id="csvEncoding" class="form-select" th:field="*{csvEncoding}">
                                    <option value="UTF-8">UTF-8</option>
                                    <option value="Windows-1251">Windows-1251</option>
                                    <option value="ISO-8859-1">ISO-8859-1</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="csvDelimiter" class="form-label">Разделитель</label>
                                <select id="csvDelimiter" class="form-select" th:field="*{csvDelimiter}">
                                    <option value=";">; (точка с запятой)</option>
                                    <option value=",">, (запятая)</option>
                                    <option value="\t">Tab</option>
                                    <option value="|">|</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="csvQuoteChar" class="form-label">Символ кавычек</label>
                                <input type="text" id="csvQuoteChar" class="form-control" th:field="*{csvQuoteChar}"/>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" th:field="*{csvIncludeHeader}">
                                    <label class="form-check-label">Заголовок</label>
                                </div>
                            </div>
                        </div>
                        <div id="xlsxSettings" class="row g-3 mt-0">
                            <div class="col-md-6">
                                <label for="xlsxSheetName" class="form-label">Имя листа</label>
                                <input type="text" id="xlsxSheetName" class="form-control" th:field="*{xlsxSheetName}"/>
                            </div>
                            <div class="col-md-6 d-flex align-items-center">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" th:field="*{xlsxAutoSizeColumns}">
                                    <label class="form-check-label">Автоширина</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="maxRowsPerFile" class="form-label">Макс. строк в файле</label>
                        <input type="number" id="maxRowsPerFile" class="form-control" th:field="*{maxRowsPerFile}" min="0">
                    </div>
                    <div class="col-12">
                        <label for="description" class="form-label">Описание</label>
                        <textarea id="description" class="form-control" th:field="*{description}" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Поля</h5>
                <button type="submit" name="addField" class="btn btn-sm btn-secondary">Добавить поле</button>
            </div>
            <div class="card-body">
                <div th:if="${#lists.isEmpty(template.fields)}" class="text-center text-muted">Полей нет</div>
                <div th:each="field, iterStat : *{fields}" class="row g-3 mb-3">
                    <input type="hidden" th:field="*{fields[__${iterStat.index}__].id}" />
                    <div class="col-md-4">
                        <label class="form-label required-field">Поле сущности</label>
                        <select class="form-select" th:field="*{fields[__${iterStat.index}__].entityFieldName}" required>
                            <option value="">-- Поле --</option>
                            <option th:each="f : ${availableFields}" th:value="${f}" th:text="${f}"></option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label required-field">Колонка экспорта</label>
                        <input type="text" class="form-control" th:field="*{fields[__${iterStat.index}__].exportColumnName}" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label required-field">Порядок</label>
                        <input type="number" class="form-control" th:field="*{fields[__${iterStat.index}__].fieldOrder}" required>
                    </div>
                    <div class="col-md-1 d-flex align-items-center">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" th:field="*{fields[__${iterStat.index}__].isIncluded}">
                            <label class="form-check-label">Вкл.</label>
                        </div>
                    </div>
                    <div class="col-md-1 d-flex align-items-center">
                        <button type="submit" name="removeField" th:value="${iterStat.index}" class="btn btn-sm btn-danger mt-4">&times;</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Фильтры</h5>
                <button type="submit" name="addFilter" class="btn btn-sm btn-secondary">Добавить фильтр</button>
            </div>
            <div class="card-body">
                <div th:if="${#lists.isEmpty(template.filters)}" class="text-center text-muted">Фильтров нет</div>
                <div th:each="filter, iterStat : *{filters}" class="row g-3 mb-3">
                    <input type="hidden" th:field="*{filters[__${iterStat.index}__].id}" />
                    <div class="col-md-4">
                        <label class="form-label required-field">Поле</label>
                        <select class="form-select" th:field="*{filters[__${iterStat.index}__].fieldName}" required>
                            <option value="">-- Поле --</option>
                            <option th:each="f : ${availableFields}" th:value="${f}" th:text="${f}"></option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label required-field">Тип</label>
                        <select class="form-select" th:field="*{filters[__${iterStat.index}__].filterType}" required>
                            <option value="">-- Тип --</option>
                            <option th:each="type : ${T(com.java.model.enums.FilterType).values()}"
                                    th:value="${type}" th:text="${type.displayName}">Тип</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label required-field">Значение</label>
                        <input type="text" class="form-control" th:field="*{filters[__${iterStat.index}__].filterValue}" required>
                    </div>
                    <div class="col-md-1 d-flex align-items-center">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" th:field="*{filters[__${iterStat.index}__].isActive}">
                            <label class="form-check-label">Вкл.</label>
                        </div>
                    </div>
                    <div class="col-md-1 d-flex align-items-center">
                        <button type="submit" name="removeFilter" th:value="${iterStat.index}" class="btn btn-sm btn-danger mt-4">&times;</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Настройки статистики -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableStatistics"
                           th:field="*{enableStatistics}" onchange="toggleStatisticsSettings()">
                    <label class="form-check-label" for="enableStatistics">
                        <h5 class="mb-0">Включить статистику для этого шаблона</h5>
                    </label>
                </div>
                <small class="text-muted">Позволяет сравнивать результаты экспортов и отслеживать изменения</small>
            </div>
            <div class="card-body" id="statisticsSettings" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Настройки статистики</strong> позволяют создавать сводные таблицы для анализа данных.
                    Выберите поля для подсчета, группировки и фильтрации.
                </div>

                <div class="row">
                    <!-- Поля для подсчета -->
                    <div class="col-md-4">
                        <label class="form-label">Поля для подсчета</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div th:each="field : ${availableFields}" class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       name="statisticsCountFields" th:value="${field}"
                                       th:id="${'countField_' + field}">
                                <label class="form-check-label" th:for="${'countField_' + field}" th:text="${field}">
                                    Поле
                                </label>
                            </div>
                        </div>
                        <small class="text-muted">Поля, для которых будет подсчитываться количество непустых значений</small>
                    </div>

                    <!-- Поле для группировки -->
                    <div class="col-md-4">
                        <label for="statisticsGroupField" class="form-label">Поле для группировки</label>
                        <select class="form-select" id="statisticsGroupField" name="statisticsGroupField">
                            <option value="">-- Выберите поле --</option>
                            <option th:each="field : ${availableFields}" th:value="${field}" th:text="${field}">
                                Поле
                            </option>
                        </select>
                        <small class="text-muted">Данные будут сгруппированы по значениям этого поля</small>

                        <div class="mt-3">
                            <label class="form-label">Пример группировки:</label>
                            <div class="bg-light p-2 rounded">
                                <small class="text-muted">
                                    При выборе поля "product_additional4" данные будут сгруппированы по значениям
                                    типа: "OZON", "Wildberries", "Yandex.Market" и т.д.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Поля для фильтрации -->
                    <div class="col-md-4">
                        <label class="form-label">Поля для фильтрации</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div th:each="field : ${availableFields}" class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       name="statisticsFilterFields" th:value="${field}"
                                       th:id="${'filterField_' + field}">
                                <label class="form-check-label" th:for="${'filterField_' + field}" th:text="${field}">
                                    Поле
                                </label>
                            </div>
                        </div>
                        <small class="text-muted">Поля, которые можно использовать для фильтрации при анализе</small>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="bg-light p-3 rounded">
                            <h6>Пример настройки:</h6>
                            <ul class="mb-0">
                                <li><strong>Поля для подсчета:</strong> competitor_price, competitorPromotionalPrice</li>
                                <li><strong>Группировка:</strong> product_additional4 (коды магазинов)</li>
                                <li><strong>Фильтрация:</strong> competitorStockStatus (статус товара)</li>
                            </ul>
                            <p class="mt-2 mb-0">
                                <small class="text-muted">
                                    Результат: таблица с количеством цен по каждому магазину,
                                    с возможностью фильтрации по статусу товара
                                </small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-end">
            <button type="submit" class="btn btn-primary">
                <span th:text="${template.id != null ? 'Сохранить' : 'Создать'}">Сохранить</span>
            </button>
        </div>
    </form>
</section>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const formatSelect = document.getElementById('fileFormat');
        const csvSettings = document.getElementById('csvSettings');
        const xlsxSettings = document.getElementById('xlsxSettings');

        function toggleSettings() {
            const format = formatSelect.value;
            if (csvSettings) {
                csvSettings.classList.toggle('d-none', format !== 'CSV');
            }
            if (xlsxSettings) {
                xlsxSettings.classList.toggle('d-none', format !== 'XLSX');
            }
        }

        formatSelect.addEventListener('change', toggleSettings);
        toggleSettings();
    });
</script>
</body>
</html>