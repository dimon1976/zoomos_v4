<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(${template.id != null ? 'Редактирование шаблона экспорта' : 'Новый шаблон экспорта'}, ~{::section}, ~{::script}, ~{::style}, ${template.id != null ? 'Редактирование шаблона' : 'Новый шаблон'}, ~{::.page-actions})}">
<head>
    <title th:text="${template.id != null ? 'Редактирование шаблона экспорта' : 'Новый шаблон экспорта'}">Шаблон экспорта</title>
    <style></style>
</head>
<body>
<div class="page-actions">
    <a th:href="${template.id != null} ? @{/clients/{clientId}/export/templates/{id}(clientId=${template.clientId},id=${template.id})} : @{/clients/{id}(id=${clientId})}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Назад
    </a>
</div>

<section>
    <form th:action="${template.id != null} ? @{/clients/{clientId}/export/templates/{id}/edit(clientId=${template.clientId},id=${template.id})} : @{/clients/{clientId}/export/templates/create(clientId=${template.clientId})}"
          th:object="${template}" method="post">
        <input type="hidden" th:field="*{id}"/>
        <input type="hidden" th:field="*{clientId}"/>
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Основные параметры</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label required-field">Название шаблона</label>
                        <input type="text" id="name" class="form-control" th:field="*{name}" required>
                    </div>
                    <div class="col-md-6">
                        <label for="entityType" class="form-label required-field">Тип сущности</label>
                        <select id="entityType" class="form-select" th:field="*{entityType}" required>
                            <option value="">-- Выберите тип --</option>
                            <option th:each="type : ${T(com.java.model.enums.EntityType).values()}"
                                    th:value="${type}" th:text="${type.displayName}">Тип</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="exportStrategy" class="form-label required-field">Стратегия экспорта</label>
                        <select id="exportStrategy" class="form-select" th:field="*{exportStrategy}" required>
                            <option value="">-- Выберите стратегию --</option>
                            <option th:each="strategy : ${T(com.java.model.enums.ExportStrategy).values()}"
                                    th:value="${strategy}" th:text="${strategy.displayName}">Стратегия</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="fileFormat" class="form-label required-field">Формат файла</label>
                        <select id="fileFormat" class="form-select" th:field="*{fileFormat}" required>
                            <option value="CSV">CSV</option>
                            <option value="XLSX">XLSX</option>
                            <option value="XLS">XLS</option>
                            <option value="TXT">TXT</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <div id="csvSettings" class="row g-3 mt-0">
                            <div class="col-md-4">
                                <label for="csvEncoding" class="form-label">Кодировка</label>
                                <select id="csvEncoding" class="form-select" th:field="*{csvEncoding}">
                                    <option value="UTF-8">UTF-8</option>
                                    <option value="Windows-1251">Windows-1251</option>
                                    <option value="ISO-8859-1">ISO-8859-1</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="csvDelimiter" class="form-label">Разделитель</label>
                                <select id="csvDelimiter" class="form-select" th:field="*{csvDelimiter}">
                                    <option value=";">; (точка с запятой)</option>
                                    <option value=",">, (запятая)</option>
                                    <option value="\t">Tab</option>
                                    <option value="|">|</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="csvQuoteChar" class="form-label">Символ кавычек</label>
                                <input type="text" id="csvQuoteChar" class="form-control" th:field="*{csvQuoteChar}"/>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" th:field="*{csvIncludeHeader}">
                                    <label class="form-check-label">Заголовок</label>
                                </div>
                            </div>
                        </div>
                        <div id="xlsxSettings" class="row g-3 mt-0">
                            <div class="col-md-6">
                                <label for="xlsxSheetName" class="form-label">Имя листа</label>
                                <input type="text" id="xlsxSheetName" class="form-control" th:field="*{xlsxSheetName}"/>
                            </div>
                            <div class="col-md-6 d-flex align-items-center">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" th:field="*{xlsxAutoSizeColumns}">
                                    <label class="form-check-label">Автоширина</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="maxRowsPerFile" class="form-label">Макс. строк в файле</label>
                        <input type="number" id="maxRowsPerFile" class="form-control" th:field="*{maxRowsPerFile}" min="0">
                    </div>
                    <div class="col-12">
                        <label for="description" class="form-label">Описание</label>
                        <textarea id="description" class="form-control" th:field="*{description}" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Поля</h5>
                <button type="submit" name="addField" class="btn btn-sm btn-secondary">Добавить поле</button>
            </div>
            <div class="card-body">
                <div th:if="${#lists.isEmpty(template.fields)}" class="text-center text-muted">Полей нет</div>
                <div th:each="field, iterStat : *{fields}" class="row g-3 mb-3 p-3 border rounded">
                    <input type="hidden" th:field="*{fields[__${iterStat.index}__].id}" />
                    <!-- Основные настройки поля -->
                    <div class="col-md-3">
                        <label class="form-label required-field">Поле сущности</label>
                        <select class="form-select" th:field="*{fields[__${iterStat.index}__].entityFieldName}">
                            <option value="">-- Поле --</option>
                            <option th:each="f : ${availableFields}" th:value="${f}" th:text="${f}"></option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label required-field">Колонка экспорта</label>
                        <input type="text" class="form-control" th:field="*{fields[__${iterStat.index}__].exportColumnName}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label required-field">Порядок</label>
                        <input type="number" class="form-control" th:field="*{fields[__${iterStat.index}__].fieldOrder}">
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" th:field="*{fields[__${iterStat.index}__].isIncluded}">
                            <label class="form-check-label">Вкл.</label>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-center justify-content-end">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2 mt-4" 
                                th:onclick="|toggleNormalization(${iterStat.index})|">
                            <i class="fas fa-magic"></i> Нормализация
                        </button>
                        <button type="submit" name="removeField" th:value="${iterStat.index}" class="btn btn-sm btn-danger mt-4">&times;</button>
                    </div>
                    
                    <!-- Настройки нормализации -->
                    <div class="col-12" th:id="|normalization-${iterStat.index}|" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-magic text-primary me-2"></i>Настройки нормализации
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Тип нормализации</label>
                                        <select class="form-select" th:field="*{fields[__${iterStat.index}__].normalizationType}"
                                                th:onchange="|updateNormalizationPreview(${iterStat.index})|">
                                            <option value="">-- Без нормализации --</option>
                                            <option th:each="type : ${T(com.java.model.enums.NormalizationType).values()}"
                                                    th:value="${type}" th:text="${type.displayName}">Тип</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            <strong>VOLUME:</strong> нормализует объемы (0.7л → 0.7)<br>
                                            <strong>BRAND:</strong> нормализует бренды (The Macallan → Macallan)
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Правила нормализации (JSON)
                                            <button type="button" class="btn btn-sm btn-outline-info ms-2" 
                                                    onclick="showNormalizationHelp()">
                                                <i class="fas fa-question-circle"></i> Справка
                                            </button>
                                        </label>
                                        <textarea class="form-control" th:field="*{fields[__${iterStat.index}__].normalizationRule}"
                                                  rows="3" placeholder='{"customRules": ["rule1", "rule2"]}'
                                                  th:onchange="|updateNormalizationPreview(${iterStat.index})|"></textarea>
                                        <small class="form-text text-muted">
                                            Оставьте пустым для использования правил по умолчанию
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Предварительный просмотр</label>
                                        <div class="border rounded p-2 bg-light" th:id="|preview-${iterStat.index}|" style="min-height: 80px;">
                                            <small class="text-muted">Выберите тип нормализации для просмотра примеров</small>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2"
                                                th:onclick="|testNormalization(${iterStat.index})|">
                                            <i class="fas fa-flask"></i> Тест
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Быстрые настройки -->
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button type="button" class="btn btn-sm btn-outline-info"
                                                    th:onclick="|setQuickNormalization(${iterStat.index}, 'VOLUME')|">
                                                <i class="fas fa-wine-bottle"></i> Объемы
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info"
                                                    th:onclick="|setQuickNormalization(${iterStat.index}, 'BRAND')|">
                                                <i class="fas fa-tag"></i> Бренды
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                    th:onclick="|clearNormalization(${iterStat.index})|">
                                                <i class="fas fa-times"></i> Сбросить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Фильтры</h5>
                <button type="submit" name="addFilter" class="btn btn-sm btn-secondary">Добавить фильтр</button>
            </div>
            <div class="card-body">
                <div th:if="${#lists.isEmpty(template.filters)}" class="text-center text-muted">Фильтров нет</div>
                <div th:each="filter, iterStat : *{filters}" class="row g-3 mb-3">
                    <input type="hidden" th:field="*{filters[__${iterStat.index}__].id}" />
                    <div class="col-md-4">
                        <label class="form-label required-field">Поле</label>
                        <select class="form-select" th:field="*{filters[__${iterStat.index}__].fieldName}" required>
                            <option value="">-- Поле --</option>
                            <option th:each="f : ${availableFields}" th:value="${f}" th:text="${f}"></option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label required-field">Тип</label>
                        <select class="form-select" th:field="*{filters[__${iterStat.index}__].filterType}" required>
                            <option value="">-- Тип --</option>
                            <option th:each="type : ${T(com.java.model.enums.FilterType).values()}"
                                    th:value="${type}" th:text="${type.displayName}">Тип</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label required-field">Значение</label>
                        <input type="text" class="form-control" th:field="*{filters[__${iterStat.index}__].filterValue}" required>
                    </div>
                    <div class="col-md-1 d-flex align-items-center">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" th:field="*{filters[__${iterStat.index}__].isActive}">
                            <label class="form-check-label">Вкл.</label>
                        </div>
                    </div>
                    <div class="col-md-1 d-flex align-items-center">
                        <button type="submit" name="removeFilter" th:value="${iterStat.index}" class="btn btn-sm btn-danger mt-4">&times;</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Настройки статистики -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableStatistics"
                           th:field="*{enableStatistics}" onchange="toggleStatisticsSettings()">
                    <label class="form-check-label" for="enableStatistics">
                        <h5 class="mb-0">Включить статистику для этого шаблона</h5>
                    </label>
                </div>
                <small class="text-muted">Позволяет сравнивать результаты экспортов и отслеживать изменения</small>
            </div>
            <div class="card-body" id="statisticsSettings" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Настройки статистики</strong> позволяют создавать сводные таблицы для анализа данных.
                    Выберите поля для подсчета, группировки и фильтрации.
                </div>

                <div class="row">
                    <!-- Поля для подсчета -->
                    <div class="col-md-4">
                        <label class="form-label">Поля для подсчета</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div th:each="field : ${availableFields}" class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       th:field="*{statisticsCountFields}"
                                       th:value="${field}"
                                       th:id="${'countField_' + field}">
                                <label class="form-check-label" th:for="${'countField_' + field}" th:text="${field}">
                                    Поле
                                </label>
                            </div>
                        </div>
                        <small class="text-muted">Поля, для которых будет подсчитываться количество непустых значений</small>
                    </div>

                    <!-- Поле для группировки -->
                    <div class="col-md-4">
                        <label for="statisticsGroupField" class="form-label">Поле для группировки</label>
                        <select class="form-select" id="statisticsGroupField" th:field="*{statisticsGroupField}">
                            <option value="">-- Выберите поле --</option>
                            <option th:each="field : ${availableFields}" th:value="${field}" th:text="${field}">
                                Поле
                            </option>
                        </select>
                        <small class="text-muted">Данные будут сгруппированы по значениям этого поля</small>

                        <div class="mt-3">
                            <label class="form-label">Пример группировки:</label>
                            <div class="bg-light p-2 rounded">
                                <small class="text-muted">
                                    При выборе поля "product_additional4" данные будут сгруппированы по значениям
                                    типа: "OZON", "Wildberries", "Yandex.Market" и т.д.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Поля для фильтрации -->
                    <div class="col-md-4">
                        <label class="form-label">Поля для фильтрации</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div th:each="field : ${availableFields}" class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       th:field="*{statisticsFilterFields}"
                                       th:value="${field}"
                                       th:id="${'filterField_' + field}">
                                <label class="form-check-label" th:for="${'filterField_' + field}" th:text="${field}">
                                    Поле
                                </label>
                            </div>
                        </div>
                        <small class="text-muted">Поля, которые можно использовать для фильтрации при анализе</small>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="bg-light p-3 rounded">
                            <h6>Пример настройки:</h6>
                            <ul class="mb-0">
                                <li><strong>Поля для подсчета:</strong> competitor_price, competitorPromotionalPrice</li>
                                <li><strong>Группировка:</strong> product_additional4 (коды магазинов)</li>
                                <li><strong>Фильтрация:</strong> competitorStockStatus (статус товара)</li>
                            </ul>
                            <p class="mt-2 mb-0">
                                <small class="text-muted">
                                    Результат: таблица с количеством цен по каждому магазину,
                                    с возможностью фильтрации по статусу товара
                                </small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Настройки именования файлов</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="filenameTemplate" class="form-label">Шаблон имени файла</label>
                        <input type="text" id="filenameTemplate" class="form-control"
                               th:field="*{filenameTemplate}"
                               placeholder="Например: {client}_{week}_{date}_{time}">
                        <small class="form-text text-muted">
                            Доступные плейсхолдеры: {client}, {date}, {time}, {week}, {type}, {task}
                        </small>
                    </div>

                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" th:field="*{includeClientName}">
                            <label class="form-check-label">Включать имя клиента</label>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" th:field="*{includeExportType}">
                            <label class="form-check-label">Включать тип экспорта</label>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" th:field="*{includeTaskNumber}">
                            <label class="form-check-label">Включать номер задания</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="exportTypeLabel" class="form-label">Метка типа экспорта</label>
                        <input type="text" id="exportTypeLabel" class="form-control"
                               th:field="*{exportTypeLabel}" placeholder="Например: Report">
                    </div>

                    <div class="col-md-6">
                        <label for="operationNameSource" class="form-label">Источник названия для статистики</label>
                        <select class="form-select" th:field="*{operationNameSource}">
                            <option value="">По умолчанию (ID экспорта)</option>
                            <option value="TASK_NUMBER">Номер задания</option>
                            <option value="FILE_NAME">Имя файла</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-end">
            <button type="submit" class="btn btn-primary">
                <span th:text="${template.id != null ? 'Сохранить' : 'Создать'}">Сохранить</span>
            </button>
        </div>
    </form>
</section>
<script>
    function toggleStatisticsSettings() {
        const checkbox = document.getElementById('enableStatistics');
        const settings = document.getElementById('statisticsSettings');
        if (checkbox && settings) {
            settings.style.display = checkbox.checked ? 'block' : 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const formatSelect = document.getElementById('fileFormat');
        const csvSettings = document.getElementById('csvSettings');
        const xlsxSettings = document.getElementById('xlsxSettings');

        function toggleSettings() {
            const format = formatSelect.value;
            if (csvSettings) {
                csvSettings.classList.toggle('d-none', format !== 'CSV');
            }
            if (xlsxSettings) {
                xlsxSettings.classList.toggle('d-none', format !== 'XLSX');
            }
        }

        formatSelect.addEventListener('change', toggleSettings);
        toggleSettings();
        toggleStatisticsSettings();

        // Автозаполнение порядкового номера при добавлении поля
        autoFillFieldOrder();

        // Отслеживаем кнопку "Добавить поле" через MutationObserver
        const observer = new MutationObserver(function(mutations) {
            autoFillFieldOrder();
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    });

    // Функция для автозаполнения порядкового номера нового поля
    function autoFillFieldOrder() {
        const fieldOrderInputs = document.querySelectorAll('input[name$="].fieldOrder"]');
        if (fieldOrderInputs.length === 0) return;

        // Находим максимальный порядковый номер
        let maxOrder = 0;
        fieldOrderInputs.forEach(input => {
            const value = parseInt(input.value);
            if (!isNaN(value) && value > maxOrder) {
                maxOrder = value;
            }
        });

        // Проставляем следующий номер для пустых полей
        fieldOrderInputs.forEach(input => {
            if (!input.value || input.value === '' || input.value === '0') {
                input.value = maxOrder + 1;
                maxOrder++;
            }
        });
    }

    // Функции для управления нормализацией
    function toggleNormalization(index) {
        const panel = document.getElementById(`normalization-${index}`);
        if (panel) {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
    }

    function updateNormalizationPreview(index) {
        const typeSelect = document.querySelector(`select[name="fields[${index}].normalizationType"]`);
        const rulesTextarea = document.querySelector(`textarea[name="fields[${index}].normalizationRule"]`);
        const preview = document.getElementById(`preview-${index}`);
        
        if (!typeSelect || !preview) return;
        
        const type = typeSelect.value;
        let examples = '';
        
        switch (type) {
            case 'VOLUME':
                examples = `
                    <strong>Примеры нормализации объемов:</strong><br>
                    <small class="text-success">0.7л → 0.7</small><br>
                    <small class="text-success">0,7 л. → 0.7</small><br>
                    <small class="text-success">500мл → 500</small><br>
                    <small class="text-success">1л → 1</small>
                `;
                break;
            case 'BRAND':
                examples = `
                    <strong>Примеры нормализации брендов:</strong><br>
                    <small class="text-success">The Macallan → Macallan</small><br>
                    <small class="text-success">JAMESON → Jameson</small><br>
                    <small class="text-success">jameson irish whiskey → Jameson</small><br>
                    <small class="text-success">Macallan, Edition №5 → Macallan</small>
                `;
                break;
            case 'CURRENCY':
                examples = `
                    <strong>Примеры нормализации валют:</strong><br>
                    <small class="text-muted">Функция в разработке</small><br>
                    <small class="text-success">$100 → 100</small><br>
                    <small class="text-success">100USD → 100</small>
                `;
                break;
            case 'CUSTOM':
                examples = `
                    <strong>Пользовательские правила:</strong><br>
                    <small class="text-muted">Укажите JSON правила в поле слева</small><br>
                    <small class="text-info">Примеры правил будут зависеть от вашей конфигурации</small>
                `;
                break;
            default:
                examples = '<small class="text-muted">Выберите тип нормализации для просмотра примеров</small>';
        }
        
        preview.innerHTML = examples;
        
        // Показать панель нормализации если выбран тип
        if (type && type !== '') {
            const panel = document.getElementById(`normalization-${index}`);
            if (panel && panel.style.display === 'none') {
                panel.style.display = 'block';
            }
        }
    }

    function setQuickNormalization(index, type) {
        const typeSelect = document.querySelector(`select[name="fields[${index}].normalizationType"]`);
        const rulesTextarea = document.querySelector(`textarea[name="fields[${index}].normalizationRule"]`);
        
        if (typeSelect) {
            typeSelect.value = type;
            updateNormalizationPreview(index);
        }
        
        if (rulesTextarea) {
            rulesTextarea.value = ''; // Используем правила по умолчанию
        }
    }

    function clearNormalization(index) {
        const typeSelect = document.querySelector(`select[name="fields[${index}].normalizationType"]`);
        const rulesTextarea = document.querySelector(`textarea[name="fields[${index}].normalizationRule"]`);
        
        if (typeSelect) {
            typeSelect.value = '';
        }
        
        if (rulesTextarea) {
            rulesTextarea.value = '';
        }
        
        updateNormalizationPreview(index);
    }

    async function testNormalization(index) {
        const typeSelect = document.querySelector(`select[name="fields[${index}].normalizationType"]`);
        const rulesTextarea = document.querySelector(`textarea[name="fields[${index}].normalizationRule"]`);
        
        if (!typeSelect || !typeSelect.value) {
            alert('Выберите тип нормализации для тестирования');
            return;
        }
        
        const testInput = prompt('Введите значение для тестирования нормализации:');
        if (!testInput) return;
        
        try {
            const response = await fetch('/api/normalization/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    value: testInput,
                    type: typeSelect.value,
                    rule: rulesTextarea ? rulesTextarea.value : null
                })
            });
            
            if (response.ok) {
                const result = await response.text();
                alert(`Результат нормализации:\nВход: "${testInput}"\nВыход: "${result}"`);
            } else {
                alert('Ошибка тестирования нормализации');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка подключения к серверу');
        }
    }

    // Справка по нормализации
    function showNormalizationHelp() {
        // Проверяем, есть ли уже модальное окно
        let modal = document.getElementById('normalizationHelpModal');
        if (!modal) {
            // Создаем модальное окно динамически
            modal = createNormalizationHelpModal();
            document.body.appendChild(modal);
        }
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
    }

    function createNormalizationHelpModal() {
        const modalHTML = `
<div class="modal fade" id="normalizationHelpModal" tabindex="-1" aria-labelledby="normalizationHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="normalizationHelpModalLabel">
                    <i class="fas fa-magic text-primary me-2"></i>Справка по нормализации данных
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Нормализация данных</strong> позволяет автоматически преобразовывать значения при экспорте.
                    Выберите подходящий тип или создайте собственные правила.
                </div>

                <!-- Навигация по типам -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#volume-help">
                            <i class="fas fa-wine-bottle me-1"></i>Объемы
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#brand-help">
                            <i class="fas fa-tag me-1"></i>Бренды
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#currency-help">
                            <i class="fas fa-dollar-sign me-1"></i>Валюты
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#custom-help">
                            <i class="fas fa-cog me-1"></i>Пользовательские
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Справка по VOLUME -->
                    <div class="tab-pane fade show active" id="volume-help">
                        <h6><i class="fas fa-wine-bottle text-info me-2"></i>Нормализация объемов</h6>
                        <p>Преобразует различные форматы записи объемов в числовое значение.</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Примеры преобразований:</h6>
                                <ul class="list-unstyled">
                                    <li><code>0.7л</code> → <code>0.7</code></li>
                                    <li><code>0,7 л.</code> → <code>0.7</code></li>
                                    <li><code>500мл</code> → <code>500</code></li>
                                    <li><code>1 литр</code> → <code>1</code></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Настройки по умолчанию:</h6>
                                <div class="bg-light p-2 rounded">
                                    <code>
{<br>
&nbsp;&nbsp;"extractNumeric": true,<br>
&nbsp;&nbsp;"replaceCommaWithDot": true,<br>
&nbsp;&nbsp;"removeUnits": ["л", "л.", "мл", "ml", " ", "."]<br>
}
                                    </code>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" 
                                        onclick='copyToClipboard("{\\"extractNumeric\\": true, \\"replaceCommaWithDot\\": true, \\"removeUnits\\": [\\"л\\", \\"л.\\", \\"мл\\", \\"ml\\", \\" \\", \\".\\"]}")'>
                                    <i class="fas fa-copy"></i> Копировать
                                </button>
                            </div>
                        </div>
                        
                        <h6 class="mt-3">Параметры конфигурации:</h6>
                        <ul>
                            <li><code>extractNumeric</code> - извлекать числовые значения</li>
                            <li><code>replaceCommaWithDot</code> - заменять запятые на точки</li>
                            <li><code>removeUnits</code> - список единиц измерения для удаления</li>
                        </ul>
                    </div>

                    <!-- Справка по BRAND -->
                    <div class="tab-pane fade" id="brand-help">
                        <h6><i class="fas fa-tag text-success me-2"></i>Нормализация брендов</h6>
                        <p>Приводит названия брендов к единому формату.</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Примеры преобразований:</h6>
                                <ul class="list-unstyled">
                                    <li><code>The Macallan</code> → <code>Macallan</code></li>
                                    <li><code>JAMESON</code> → <code>Jameson</code></li>
                                    <li><code>jameson irish whiskey</code> → <code>Jameson Irish Whiskey</code></li>
                                    <li><code>Macallan, Edition №5</code> → <code>Macallan</code></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Настройки по умолчанию:</h6>
                                <div class="bg-light p-2 rounded">
                                    <code>
{<br>
&nbsp;&nbsp;"removeArticles": ["The", "A", "An"],<br>
&nbsp;&nbsp;"extractMainBrand": true,<br>
&nbsp;&nbsp;"extractMainBrandSplitBy": ",",<br>
&nbsp;&nbsp;"caseNormalization": "PROPER_CASE"<br>
}
                                    </code>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" 
                                        onclick='copyToClipboard("{\\"removeArticles\\": [\\"The\\", \\"A\\", \\"An\\"], \\"extractMainBrand\\": true, \\"extractMainBrandSplitBy\\": \\",\\", \\"caseNormalization\\": \\"PROPER_CASE\\"}")'>
                                    <i class="fas fa-copy"></i> Копировать
                                </button>
                            </div>
                        </div>
                        
                        <h6 class="mt-3">Параметры конфигурации:</h6>
                        <ul>
                            <li><code>removeArticles</code> - артикли для удаления в начале</li>
                            <li><code>extractMainBrand</code> - извлекать основной бренд (до разделителя)</li>
                            <li><code>extractMainBrandSplitBy</code> - разделитель для извлечения</li>
                            <li><code>caseNormalization</code> - нормализация регистра:
                                <ul>
                                    <li><code>UPPER_CASE</code> - ВСЕ ЗАГЛАВНЫЕ</li>
                                    <li><code>LOWER_CASE</code> - все строчные</li>
                                    <li><code>PROPER_CASE</code> - Первые Буквы Заглавные</li>
                                </ul>
                            </li>
                        </ul>
                    </div>

                    <!-- Справка по CURRENCY -->
                    <div class="tab-pane fade" id="currency-help">
                        <h6><i class="fas fa-dollar-sign text-warning me-2"></i>Нормализация валют</h6>
                        <p>Извлекает числовые значения из валютных строк, убирая символы и коды валют.</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Примеры преобразований:</h6>
                                <ul class="list-unstyled">
                                    <li><code>100USD</code> → <code>100</code></li>
                                    <li><code>50EUR</code> → <code>50</code></li>
                                    <li><code>1500RUB</code> → <code>1500</code></li>
                                    <li><code>100 dollars</code> → <code>100</code></li>
                                    <li><code>75.50 руб</code> → <code>75.50</code></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Настройки по умолчанию:</h6>
                                <div class="bg-light p-2 rounded">
                                    <code>
{<br>
&nbsp;&nbsp;"extractNumeric": true,<br>
&nbsp;&nbsp;"replaceCommaWithDot": true,<br>
&nbsp;&nbsp;"validateNumeric": true,<br>
&nbsp;&nbsp;"removeCurrencySymbols": ["$", "€", "£", "₽", "USD", "EUR", "RUB", ...]<br>
}
                                    </code>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" 
                                        onclick='copyToClipboard("{\"extractNumeric\": true, \"replaceCommaWithDot\": true, \"validateNumeric\": true, \"removeCurrencySymbols\": [\"$\", \"€\", \"£\", \"₽\", \"USD\", \"EUR\", \"RUB\", \"GBP\", \"CNY\", \"JPY\"]}")'>
                                    <i class="fas fa-copy"></i> Копировать
                                </button>
                            </div>
                        </div>
                        
                        <h6 class="mt-3">Параметры конфигурации:</h6>
                        <ul>
                            <li><code>extractNumeric</code> - извлекать числовые значения</li>
                            <li><code>replaceCommaWithDot</code> - заменять запятые на точки</li>
                            <li><code>validateNumeric</code> - проверять, что результат является числом</li>
                            <li><code>removeCurrencySymbols</code> - список валютных символов и кодов для удаления</li>
                        </ul>

                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-info-circle me-2"></i>Примечание:</h6>
                            <p class="mb-0">Некоторые валютные символы могут вызывать проблемы с кодировкой при передаче через API. 
                            В таких случаях используйте текстовые коды валют (USD, EUR, RUB) вместо символов ($, €, ₽).</p>
                        </div>
                    </div>

                    <!-- Справка по CUSTOM -->
                    <div class="tab-pane fade" id="custom-help">
                        <h6><i class="fas fa-cog text-primary me-2"></i>Пользовательские правила</h6>
                        <p>Создавайте собственные правила замены значений.</p>
                        
                        <div class="row">
                            <div class="col-12">
                                <h6>Формат 1: Список правил (пары)</h6>
                                <div class="bg-light p-2 rounded mb-2">
                                    <code>{"customRules": ["старое_значение", "новое_значение", "старое2", "новое2"]}</code>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mb-3" 
                                        onclick='copyToClipboard("{\\"customRules\\": [\\"jameson irish whiskey\\", \\"Jameson\\", \\"macallan 12\\", \\"Macallan\\"]}")'>
                                    <i class="fas fa-copy"></i> Копировать пример
                                </button>

                                <h6>Формат 2: Словарь замен</h6>
                                <div class="bg-light p-2 rounded mb-2">
                                    <code>{"replacementMap": {"старое_значение": "новое_значение", "старое2": "новое2"}}</code>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mb-3" 
                                        onclick='copyToClipboard("{\\"replacementMap\\": {\\"jameson irish whiskey\\": \\"Jameson\\", \\"macallan 12\\": \\"Macallan\\"}}")'>
                                    <i class="fas fa-copy"></i> Копировать пример
                                </button>

                                <h6>Расширенные настройки</h6>
                                <div class="bg-light p-2 rounded mb-2">
                                    <code>
{<br>
&nbsp;&nbsp;"customRules": ["jameson", "Jameson"],<br>
&nbsp;&nbsp;"caseInsensitive": true,<br>
&nbsp;&nbsp;"partialMatch": false<br>
}
                                    </code>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mb-3" 
                                        onclick='copyToClipboard("{\\"customRules\\": [\\"jameson\\", \\"Jameson\\"], \\"caseInsensitive\\": true, \\"partialMatch\\": false}")'>
                                    <i class="fas fa-copy"></i> Копировать пример
                                </button>
                            </div>
                        </div>
                        
                        <h6>Параметры конфигурации:</h6>
                        <ul>
                            <li><code>customRules</code> - массив правил [старое, новое, старое2, новое2, ...]</li>
                            <li><code>replacementMap</code> - объект с правилами замены</li>
                            <li><code>caseInsensitive</code> - игнорировать регистр при поиске</li>
                            <li><code>partialMatch</code> - искать частичные совпадения</li>
                        </ul>

                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-lightbulb me-2"></i>Примеры использования:</h6>
                            <ul class="mb-0">
                                <li><strong>Точное совпадение:</strong> <code>{"customRules": ["jameson irish whiskey", "Jameson"]}</code></li>
                                <li><strong>Без учета регистра:</strong> <code>{"customRules": ["JAMESON", "Jameson"], "caseInsensitive": true}</code></li>
                                <li><strong>Частичное совпадение:</strong> <code>{"customRules": ["jameson", "Jameson"], "partialMatch": true}</code></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <a href="/normalization/help" target="_blank" class="btn btn-primary">
                    <i class="fas fa-external-link-alt me-1"></i>Подробная документация
                </a>
            </div>
        </div>
    </div>
</div>`;

        const div = document.createElement('div');
        div.innerHTML = modalHTML;
        return div.firstElementChild;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Показать временное уведомление
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Скопировано!';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-secondary');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        });
    }
</script>
</body>
</html>