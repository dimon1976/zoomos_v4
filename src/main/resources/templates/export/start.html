<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        'Запуск экспорта',
        ~{::section},
        ~{::script},
        ~{::style},
        'Экспорт',
        ~{::.page-actions}
      )}">
<head>
    <title>Запуск экспорта</title>
    <style></style>
</head>
<body>
<div class="page-actions">
    <a th:href="@{/clients/{id}(id=${clientId})}" class="btn btn-secondary btn-back">
        <i class="fas fa-arrow-left me-1"></i>К клиенту
    </a>
</div>

<section>
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-file-export me-2"></i>Запуск экспорта
            </h5>
        </div>
        <div class="card-body">
            <form th:action="@{/export/client/{id}/start(id=${clientId})}" method="post" th:object="${request}">
                <div class="mb-3">
                    <label for="templateId" class="form-label">Шаблон</label>
                    <select id="templateId" th:field="*{templateId}" class="form-select" required>
                        <option th:each="tmpl : ${templates}"
                                th:value="${tmpl.id}"
                                th:text="${tmpl.name}">Template
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="reportDateFrom" class="form-label">Отчёт не старше чем</label>
                    <input type="date" id="reportDateFrom" name="reportDateFrom" class="form-control">
                </div>

                <div class="mb-3" th:if="${!#lists.isEmpty(recentOperations)}">
                    <label class="form-label">Последние операции</label>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                            <tr>
                                <th></th>
                                <th>ID</th>
                                <th>Файл</th>
                                <th>Загружено</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="op : ${recentOperations}">
                                <td>
                                    <input class="form-check-input" type="checkbox" name="selectedOperationIds"
                                           th:value="${op.id}">
                                </td>
                                <td th:text="${op.id}">1</td>
                                <td th:text="${op.fileName}">file.csv</td>
                                <td th:text="${#temporals.format(op.startedAt, 'dd.MM.yyyy HH:mm')}">01.01.2024 00:00</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="exportAll" name="exportAll">
                    <label class="form-check-label" for="exportAll">Экспортировать всю таблицу</label>
                </div>

                <div id="filtersContainer" class="mb-3">
                    <div th:each="tmpl : ${templates}"
                         th:attr="data-template-id=${tmpl.id},data-next-index=${#lists.size(tmpl.filters)},data-fields=''"
                         class="template-filters d-none">
                        <div class="filters">
                            <div class="filter-row mb-2" th:each="filter, iterStat : ${tmpl.filters}">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <select class="form-select"
                                                th:name="${'additionalFilters[' + iterStat.index + '].fieldName'}"
                                                th:attr="data-selected=${filter.fieldName}">
                                            <option value="">-- Поле --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select"
                                                th:name="${'additionalFilters[' + iterStat.index + '].filterType'}"
                                                th:value="${filter.filterType}">
                                            <option value="EQUALS">Равно</option>
                                            <option value="NOT_EQUALS">Не равно</option>
                                            <option value="CONTAINS">Содержит</option>
                                            <option value="STARTS_WITH">Начинается с</option>
                                            <option value="ENDS_WITH">Заканчивается на</option>
                                            <option value="GREATER_THAN">Больше</option>
                                            <option value="LESS_THAN">Меньше</option>
                                            <option value="BETWEEN">Между</option>
                                            <option value="IN">Входит в список</option>
                                            <option value="IS_NULL">Пусто</option>
                                            <option value="IS_NOT_NULL">Не пусто</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control"
                                               th:name="${'additionalFilters[' + iterStat.index + '].filterValue'}"
                                               th:value="${filter.filterValue}" placeholder="Значение"/>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeFilterRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addFilterRow(this)">
                            Добавить фильтр
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-primary-action">
                    <i class="fas fa-play me-1"></i>Начать экспорт
                </button>
            </form>
        </div>
    </div>
</section>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const templateSelect = document.getElementById('templateId');
        const filtersBlocks = document.querySelectorAll('.template-filters');
        const exportAll = document.getElementById('exportAll');
        const operationCheckboxes = document.querySelectorAll('input[name="selectedOperationIds"]');

        function updateIndexes(block) {
            const rows = block.querySelectorAll('.filter-row');
            rows.forEach((row, idx) => {
                row.querySelector('[name$=".fieldName"]').setAttribute('name', `additionalFilters[${idx}].fieldName`);
                row.querySelector('[name$=".filterType"]').setAttribute('name', `additionalFilters[${idx}].filterType`);
                const valInput = row.querySelector('[name$=".filterValue"]');
                if (valInput) {
                    valInput.setAttribute('name', `additionalFilters[${idx}].filterValue`);
                }
            });
            block.dataset.nextIndex = rows.length;
        }

        function addFilterRow(button) {
            const block = button.closest('.template-filters');
            const index = parseInt(block.dataset.nextIndex || '0');
            const fields = (block.dataset.fields || '').split(',');
            const options = fields.map(f => `<option value="${f}">${f}</option>`).join('');
            const rowHtml = `
                <div class="filter-row mb-2">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <select class="form-select" name="additionalFilters[${index}].fieldName">
                                <option value="">-- Поле --</option>${options}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" name="additionalFilters[${index}].filterType">
                                <option value="EQUALS">Равно</option>
                                <option value="NOT_EQUALS">Не равно</option>
                                <option value="CONTAINS">Содержит</option>
                                <option value="STARTS_WITH">Начинается с</option>
                                <option value="ENDS_WITH">Заканчивается на</option>
                                <option value="GREATER_THAN">Больше</option>
                                <option value="LESS_THAN">Меньше</option>
                                <option value="BETWEEN">Между</option>
                                <option value="IN">Входит в список</option>
                                <option value="IS_NULL">Пусто</option>
                                <option value="IS_NOT_NULL">Не пусто</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" name="additionalFilters[${index}].filterValue" placeholder="Значение">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeFilterRow(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            block.querySelector('.filters').insertAdjacentHTML('beforeend', rowHtml);
            block.dataset.nextIndex = index + 1;
        }

        function removeFilterRow(button) {
            const block = button.closest('.template-filters');
            button.closest('.filter-row').remove();
            updateIndexes(block);
        }

        window.addFilterRow = addFilterRow;
        window.removeFilterRow = removeFilterRow;

        function loadTemplateFields(templateId) {
            if (!templateId) return;
            fetch(`/export/template/${templateId}/fields`)
                .then(res => res.json())
                .then(fields => {
                    const block = document.querySelector(`.template-filters[data-template-id="${templateId}"]`);
                    if (!block) return;
                    block.dataset.fields = fields.join(',');
                    const options = fields.map(f => `<option value="${f}">${f}</option>`).join('');
                    block.querySelectorAll('select[name$=".fieldName"]').forEach(sel => {
                        const current = sel.dataset.selected || sel.value;
                        sel.innerHTML = `<option value="">-- Поле --</option>` + options;
                        sel.value = current;
                    });
                });
        }

        function updateFilters() {
            filtersBlocks.forEach(block => {
                const active = block.getAttribute('data-template-id') === templateSelect.value;
                block.classList.toggle('d-none', !active);
                block.querySelectorAll('input, select, button').forEach(el => el.disabled = !active);
                if (active) {
                    updateIndexes(block);
                    loadTemplateFields(block.getAttribute('data-template-id'));
                }
            });
        }

        function toggleOperations() {
            const disabled = exportAll.checked;
            operationCheckboxes.forEach(cb => cb.disabled = disabled);
        }

        templateSelect.addEventListener('change', updateFilters);
        exportAll.addEventListener('change', toggleOperations);

        updateFilters();
        toggleOperations();
    });
</script>
</body>
</html>