<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        'Новый шаблон экспорта - ' + ${client.name},
        ~{::section},
        ~{::script},
        ~{::style},
        'Новый шаблон экспорта',
        ~{::.page-actions}
      )}">
<head>
    <title>Новый шаблон экспорта</title>
    <style>
        .field-row {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            position: relative;
        }
        .filter-row {
            background-color: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .remove-btn {
            position: absolute;
            top: 15px;
            right: 15px;
        }
    </style>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <a th:href="@{/clients/{clientId}/export/templates(clientId=${clientId})}"
       class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>К списку шаблонов
    </a>
</div>

<section>
    <form th:action="@{/clients/{clientId}/export/templates/create(clientId=${clientId})}"
          th:object="${template}" method="post" class="needs-validation" novalidate>

        <input type="hidden" th:field="*{clientId}">

        <!-- Основная информация -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Основная информация</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label required-field">Название шаблона</label>
                        <input type="text" class="form-control" id="name" th:field="*{name}"
                               th:classappend="${#fields.hasErrors('name')} ? 'is-invalid'" required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}"
                             th:errors="*{name}">Ошибка</div>
                    </div>

                    <div class="col-md-6">
                        <label for="entityType" class="form-label required-field">Тип сущности</label>
                        <select class="form-select" id="entityType" th:field="*{entityType}"
                                th:classappend="${#fields.hasErrors('entityType')} ? 'is-invalid'"
                                required onchange="loadAvailableFields()">
                            <option value="">-- Выберите тип --</option>
                            <option th:each="type : ${T(com.java.model.enums.EntityType).values()}"
                                    th:value="${type}" th:text="${type.displayName}">Тип</option>
                        </select>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('entityType')}"
                             th:errors="*{entityType}">Ошибка</div>
                    </div>

                    <div class="col-md-6">
                        <label for="exportStrategy" class="form-label required-field">Стратегия экспорта</label>
                        <select class="form-select" id="exportStrategy" th:field="*{exportStrategy}" required>
                            <option value="">-- Выберите стратегию --</option>
                            <option th:each="strategy : ${T(com.java.model.enums.ExportStrategy).values()}"
                                    th:value="${strategy}" th:text="${strategy.displayName}">Стратегия</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="fileFormat" class="form-label required-field">Формат файла</label>
                        <select class="form-select" id="fileFormat" th:field="*{fileFormat}"
                                required onchange="toggleFormatSettings()">
                            <option value="CSV">CSV</option>
                            <option value="XLSX">XLSX</option>
                            <option value="XLS">XLS</option>
                            <option value="TXT">TXT</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label for="description" class="form-label">Описание</label>
                        <textarea class="form-control" id="description" th:field="*{description}" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Настройки формата -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Настройки формата</h5>
            </div>
            <div class="card-body">
                <!-- CSV настройки -->
                <div id="csvSettings" class="row g-3">
                    <div class="col-md-4">
                        <label for="csvEncoding" class="form-label">Кодировка</label>
                        <select class="form-select" id="csvEncoding" th:field="*{csvEncoding}">
                            <option value="UTF-8">UTF-8</option>
                            <option value="Windows-1251">Windows-1251</option>
                            <option value="ISO-8859-1">ISO-8859-1</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="csvDelimiter" class="form-label">Разделитель</label>
                        <select class="form-select" id="csvDelimiter" th:field="*{csvDelimiter}">
                            <option value=";">; (точка с запятой)</option>
                            <option value=",">, (запятая)</option>
                            <option value="\t">Tab</option>
                            <option value="|">|</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" th:field="*{csvIncludeHeader}">
                            <label class="form-check-label">Включать заголовки</label>
                        </div>
                    </div>
                </div>

                <!-- XLSX настройки -->
                <div id="xlsxSettings" class="row g-3" style="display: none;">
                    <div class="col-md-6">
                        <label for="xlsxSheetName" class="form-label">Имя листа</label>
                        <input type="text" class="form-control" id="xlsxSheetName" th:field="*{xlsxSheetName}">
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" th:field="*{xlsxAutoSizeColumns}">
                            <label class="form-check-label">Автоширина колонок</label>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label for="maxRowsPerFile" class="form-label">Макс. строк в файле</label>
                        <input type="number" class="form-control" id="maxRowsPerFile" th:field="*{maxRowsPerFile}" min="0">
                        <small class="text-muted">0 = без ограничений</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Поля экспорта -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Поля экспорта</h5>
                <button type="submit" name="addField" class="btn btn-sm btn-success">
                    <i class="fas fa-plus me-1"></i>Добавить поле
                </button>
            </div>
            <div class="card-body">
                <div th:if="${#fields.hasErrors('fields')}" class="alert alert-danger">
                    <span th:errors="*{fields}">Ошибка полей</span>
                </div>

                <div id="fieldMappings">
                    <div th:each="field, stat : ${template.fields}" class="field-row">
                        <input type="hidden" th:field="*{fields[__${stat.index}__].id}">

                        <button type="submit" name="removeField" th:value="${stat.index}"
                                class="btn btn-sm btn-danger remove-btn">
                            <i class="fas fa-times"></i>
                        </button>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label required-field">Поле сущности</label>
                                <select class="form-select entity-field-select"
                                        th:field="*{fields[__${stat.index}__].entityFieldName}" required>
                                    <option value="">-- Поле --</option>
                                    <option th:each="f : ${availableFields}" th:value="${f}" th:text="${f}"></option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required-field">Название колонки</label>
                                <input type="text" class="form-control"
                                       th:field="*{fields[__${stat.index}__].exportColumnName}" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Порядок</label>
                                <input type="number" class="form-control"
                                       th:field="*{fields[__${stat.index}__].fieldOrder}" min="1">
                            </div>
                            <div class="col-md-2">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox"
                                           th:field="*{fields[__${stat.index}__].isIncluded}">
                                    <label class="form-check-label">Включено</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(template.fields)}" class="text-center text-muted py-3">
                    Добавьте поля для экспорта
                </div>
            </div>
        </div>

        <!-- Фильтры -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Фильтры данных</h5>
                <button type="submit" name="addFilter" class="btn btn-sm btn-success">
                    <i class="fas fa-plus me-1"></i>Добавить фильтр
                </button>
            </div>
            <div class="card-body">
                <div id="filterMappings">
                    <div th:each="filter, stat : ${template.filters}" class="filter-row">
                        <input type="hidden" th:field="*{filters[__${stat.index}__].id}">

                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Поле</label>
                                <select class="form-select" th:field="*{filters[__${stat.index}__].fieldName}">
                                    <option value="">-- Поле --</option>
                                    <option th:each="f : ${availableFields}" th:value="${f}" th:text="${f}"></option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Условие</label>
                                <select class="form-select" th:field="*{filters[__${stat.index}__].filterType}">
                                    <option th:each="type : ${T(com.java.model.enums.FilterType).values()}"
                                            th:value="${type}" th:text="${type.displayName}">Тип</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Значение</label>
                                <input type="text" class="form-control"
                                       th:field="*{filters[__${stat.index}__].filterValue}">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" name="removeFilter" th:value="${stat.index}"
                                        class="btn btn-sm btn-danger">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(template.filters)}" class="text-center text-muted py-3">
                    Фильтры не заданы - будут экспортированы все данные
                </div>
            </div>
        </div>

        <!-- Кнопки действий -->
        <div class="d-flex justify-content-between">
            <a th:href="@{/clients/{clientId}/export/templates(clientId=${clientId})}"
               class="btn btn-secondary">
                <i class="fas fa-times me-1"></i>Отмена
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Создать шаблон
            </button>
        </div>
    </form>
</section>

<script th:inline="javascript">
    /*<![CDATA[*/
    const clientId = /*[[${clientId}]]*/ 0;
    let availableFields = [];

    document.addEventListener('DOMContentLoaded', function() {
        toggleFormatSettings();
        loadAvailableFields();
    });

    function toggleFormatSettings() {
        const format = document.getElementById('fileFormat').value;
        const csvSettings = document.getElementById('csvSettings');
        const xlsxSettings = document.getElementById('xlsxSettings');

        if (format === 'CSV' || format === 'TXT') {
            csvSettings.style.display = 'flex';
            xlsxSettings.style.display = 'none';
        } else if (format === 'XLSX' || format === 'XLS') {
            csvSettings.style.display = 'none';
            xlsxSettings.style.display = 'flex';
        } else {
            csvSettings.style.display = 'flex';
            xlsxSettings.style.display = 'none';
        }
    }

    function loadAvailableFields() {
        const entityType = document.getElementById('entityType').value;
        if (!entityType) {
            availableFields = [];
            updateFieldSelects();
            return;
        }

        fetch(`/api/templates/available-fields?entityType=${entityType}`)
            .then(res => res.json())
            .then(fields => {
                availableFields = fields;
                updateFieldSelects();
            })
            .catch(err => {
                console.error('Ошибка загрузки полей:', err);
                availableFields = [];
                updateFieldSelects();
            });
    }

    function updateFieldSelects() {
        const options = availableFields.map(f => `<option value="${f}">${f}</option>`).join('');
        document.querySelectorAll('.entity-field-select').forEach(sel => {
            const current = sel.value;
            sel.innerHTML = '<option value="">-- Поле --</option>' + options;
            sel.value = current;
        });

        // Обновляем селекты фильтров тоже
        document.querySelectorAll('select[name$=".fieldName"]').forEach(sel => {
            const current = sel.value;
            sel.innerHTML = '<option value="">-- Поле --</option>' + options;
            sel.value = current;
        });
    }
    /*]]>*/
</script>
</body>
</html>