<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        ${client.name + ' - Управление шаблонами'},
        ~{::section},
        ~{::script},
        ~{::style},
        ${client.name},
        ~{::.page-actions}
      )}">
<head>
    <title th:text="${client.name + ' - Управление шаблонами'}">Клиент - Управление шаблонами</title>
    <style>
        .template-card {
            transition: transform 0.2s;
        }
        .template-card:hover {
            transform: translateY(-2px);
        }
        .template-item {
            border-bottom: 1px solid #dee2e6;
            padding: 10px 0;
        }
        .template-item:last-child {
            border-bottom: none;
        }
        .template-loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .info-card {
            background-color: #f8f9fa;
            border-left: 4px solid #17a2b8;
        }
        .feature-list {
            list-style: none;
            padding-left: 0;
        }
        .feature-list li {
            padding: 0.25rem 0;
        }
        .feature-list li::before {
            content: "✓";
            color: #28a745;
            font-weight: bold;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <a th:href="@{/clients/{id}(id=${client.id})}" class="btn btn-secondary btn-back">
        <i class="fas fa-arrow-left me-1"></i>К обзору клиента
    </a>
    <a th:href="@{/clients}" class="btn btn-secondary">
        <i class="fas fa-list me-1"></i>К списку клиентов
    </a>
</div>

<section>
    <!-- Заголовок страницы -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-cogs me-2 text-primary"></i>Управление шаблонами
                </h1>
                <span class="badge bg-light text-dark ms-3" th:text="${client.name}">Имя клиента</span>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="row">
        <!-- Шаблоны импорта -->
        <div class="col-md-6 mb-4">
            <div class="card template-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-import me-2"></i>Шаблоны импорта
                    </h5>
                    <a th:href="@{/clients/{clientId}/import/templates/create(clientId=${client.id})}"
                       class="btn btn-sm btn-success">
                        <i class="fas fa-plus me-1"></i>Создать
                    </a>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Настройка шаблонов для импорта данных из файлов в базу данных.</p>
                    
                    <div id="importTemplatesList">
                        <div class="template-loading">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Загрузка шаблонов...
                        </div>
                    </div>

                    <div class="alert alert-info info-card mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Возможности шаблонов импорта:</strong>
                        <ul class="feature-list mb-0 mt-2">
                            <li>Сопоставление колонок файла с полями базы данных</li>
                            <li>Настройка валидации и преобразования данных</li>
                            <li>Обработка различных форматов файлов</li>
                            <li>Настройка стратегий обработки дубликатов</li>
                        </ul>
                    </div>

                    <div class="mt-3">
                        <a th:href="@{/clients/{clientId}/import/templates(clientId=${client.id})}"
                           class="btn btn-outline-primary">
                            <i class="fas fa-list me-1"></i>Все шаблоны импорта
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Шаблоны экспорта -->
        <div class="col-md-6 mb-4">
            <div class="card template-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-export me-2"></i>Шаблоны экспорта
                    </h5>
                    <a th:href="@{/clients/{clientId}/export/templates/create(clientId=${client.id})}"
                       class="btn btn-sm btn-success">
                        <i class="fas fa-plus me-1"></i>Создать
                    </a>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Настройка шаблонов для экспорта данных из базы в файлы.</p>
                    
                    <div id="exportTemplatesList">
                        <div class="template-loading">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            Загрузка шаблонов...
                        </div>
                    </div>

                    <div class="alert alert-info info-card mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Возможности шаблонов экспорта:</strong>
                        <ul class="feature-list mb-0 mt-2">
                            <li>Выбор полей и порядка колонок для экспорта</li>
                            <li>Настройка фильтров и условий выборки</li>
                            <li>Форматирование данных для различных форматов</li>
                            <li>Применение стратегий обработки данных</li>
                        </ul>
                    </div>

                    <div class="mt-3">
                        <a th:href="@{/clients/{clientId}/export/templates(clientId=${client.id})}"
                           class="btn btn-outline-primary">
                            <i class="fas fa-list me-1"></i>Все шаблоны экспорта
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Общая информация о шаблонах -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>Как работать с шаблонами
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Создание шаблонов</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-arrow-right me-2 text-muted"></i>Выберите тип операции (импорт или экспорт)</li>
                                <li><i class="fas fa-arrow-right me-2 text-muted"></i>Настройте сопоставление полей</li>
                                <li><i class="fas fa-arrow-right me-2 text-muted"></i>Определите правила валидации</li>
                                <li><i class="fas fa-arrow-right me-2 text-muted"></i>Сохраните шаблон для многократного использования</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Использование шаблонов</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-arrow-right me-2 text-muted"></i>Выберите готовый шаблон при выполнении операций</li>
                                <li><i class="fas fa-arrow-right me-2 text-muted"></i>Редактируйте настройки при необходимости</li>
                                <li><i class="fas fa-arrow-right me-2 text-muted"></i>Просматривайте историю использования</li>
                                <li><i class="fas fa-arrow-right me-2 text-muted"></i>Копируйте и модифицируйте существующие шаблоны</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        // Загружаем списки шаблонов
        loadTemplatesList();
    });

    function loadTemplatesList() {
        const clientId = /*[[${client.id}]]*/ 0;
        
        // Загружаем шаблоны импорта
        fetch(`/api/import/templates/client/${clientId}/summary`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка загрузки');
                }
                return response.json();
            })
            .then(templates => {
                displayImportTemplates(templates);
            })
            .catch(error => {
                console.error('Ошибка загрузки шаблонов импорта:', error);
                document.getElementById('importTemplatesList').innerHTML =
                    '<div class="text-muted text-center">Ошибка загрузки шаблонов</div>';
            });

        // Загружаем шаблоны экспорта
        fetch(`/api/export/templates/client/${clientId}/summary`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка загрузки');
                }
                return response.json();
            })
            .then(templates => {
                displayExportTemplates(templates);
            })
            .catch(error => {
                console.error('Ошибка загрузки шаблонов экспорта:', error);
                document.getElementById('exportTemplatesList').innerHTML =
                    '<div class="text-muted text-center">Ошибка загрузки шаблонов</div>';
            });
    }

    function displayImportTemplates(templates) {
        const container = document.getElementById('importTemplatesList');
        
        if (!templates || templates.length === 0) {
            container.innerHTML = '<div class="text-muted text-center py-3">Нет созданных шаблонов</div>';
            return;
        }

        const html = templates.slice(0, 5).map(template => `
            <div class="template-item d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center">
                        <a href="/import/templates/${template.id}" class="text-decoration-none fw-bold">
                            ${template.name}
                        </a>
                        <span class="badge bg-light text-dark ms-2">${template.entityType}</span>
                    </div>
                    <small class="text-muted">
                        Создан: ${formatDate(template.createdAt)} | 
                        Использований: ${template.usageCount || 0}
                    </small>
                </div>
                <div class="d-flex gap-1">
                    <a href="/clients/${/*[[${client.id}]]*/ 0}/import/templates/${template.id}/edit"
                       class="btn btn-sm btn-outline-secondary" title="Редактировать">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="/clients/${/*[[${client.id}]]*/ 0}/import/templates/${template.id}"
                       class="btn btn-sm btn-outline-primary" title="Просмотр">
                        <i class="fas fa-eye"></i>
                    </a>
                </div>
            </div>
        `).join('');

        container.innerHTML = html;

        // Показываем уведомление о количестве скрытых шаблонов
        if (templates.length > 5) {
            container.innerHTML += `
                <div class="text-center mt-3">
                    <small class="text-muted">
                        Показано 5 из ${templates.length} шаблонов. 
                        <a href="/import/templates/client/${/*[[${client.id}]]*/ 0}" class="text-decoration-none">
                            Посмотреть все
                        </a>
                    </small>
                </div>
            `;
        }
    }

    function displayExportTemplates(templates) {
        const container = document.getElementById('exportTemplatesList');
        
        if (!templates || templates.length === 0) {
            container.innerHTML = '<div class="text-muted text-center py-3">Нет созданных шаблонов</div>';
            return;
        }

        const html = templates.slice(0, 5).map(template => `
            <div class="template-item d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center">
                        <a href="/export/templates/${template.id}" class="text-decoration-none fw-bold">
                            ${template.name}
                        </a>
                        <span class="badge bg-light text-dark ms-2">${template.entityType}</span>
                    </div>
                    <small class="text-muted">
                        Создан: ${formatDate(template.createdAt)} | 
                        Использований: ${template.usageCount || 0}
                    </small>
                </div>
                <div class="d-flex gap-1">
                    <a href="/clients/${/*[[${client.id}]]*/ 0}/export/templates/${template.id}/edit"
                       class="btn btn-sm btn-outline-secondary" title="Редактировать">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="/clients/${/*[[${client.id}]]*/ 0}/export/templates/${template.id}"
                       class="btn btn-sm btn-outline-primary" title="Просмотр">
                        <i class="fas fa-eye"></i>
                    </a>
                </div>
            </div>
        `).join('');

        container.innerHTML = html;

        // Показываем уведомление о количестве скрытых шаблонов
        if (templates.length > 5) {
            container.innerHTML += `
                <div class="text-center mt-3">
                    <small class="text-muted">
                        Показано 5 из ${templates.length} шаблонов. 
                        <a href="/export/templates/client/${/*[[${client.id}]]*/ 0}" class="text-decoration-none">
                            Посмотреть все
                        </a>
                    </small>
                </div>
            `;
        }
    }

    function formatDate(dateTime) {
        if (!dateTime) {
            return 'Неизвестно';
        }
        
        let date;
        if (Array.isArray(dateTime)) {
            const [y, m, d] = dateTime;
            date = new Date(y, (m || 1) - 1, d || 1);
        } else if (typeof dateTime === 'number') {
            date = new Date(dateTime < 1e12 ? dateTime * 1000 : dateTime);
        } else if (typeof dateTime === 'string' && /^\d+$/.test(dateTime)) {
            const num = parseInt(dateTime, 10);
            date = new Date(num < 1e12 ? num * 1000 : num);
        } else {
            date = new Date(dateTime);
        }
        
        if (isNaN(date.getTime())) {
            return 'Неизвестно';
        }
        
        return date.toLocaleDateString('ru-RU');
    }
    /*]]>*/
</script>
</body>
</html>