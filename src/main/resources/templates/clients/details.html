<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        ${client.name + ' - Обработка файлов'},
        ~{::section},
        ~{::script},
        ~{::style},
        ${client.name},
        ~{::.page-actions}
      )}">
<head>
    <title th:text="${client.name + ' - Обработка файлов'}">Клиент - Обработка файлов</title>
    <style>
        .tab-content {
            padding: 20px 0;
        }
        .status-badge {
            font-size: 0.875rem;
        }
        .operation-row:hover {
            background-color: #f8f9fa;
        }
        /* Стили для компактного progress bar */
        .progress-compact {
            height: 20px;
            border-radius: 10px;
        }
        .progress-compact .progress-bar {
            line-height: 20px;
            font-size: 11px;
        }
    </style>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <a th:href="@{/clients/{id}/edit(id=${client.id})}" class="btn btn-primary btn-primary-action">
        <i class="fas fa-edit me-1"></i>Редактировать
    </a>
    <button type="button" class="btn btn-danger btn-secondary-action" data-bs-toggle="modal" data-bs-target="#deleteClientModal">
        <i class="fas fa-trash-alt me-1"></i>Удалить
    </button>
    <a th:href="@{/clients}" class="btn btn-secondary btn-back">
        <i class="fas fa-arrow-left me-1"></i>К списку
    </a>
</div>

<section>
    <!-- Детали клиента -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><strong>Код региона:</strong>
                        <span th:text="${client.regionCode != null && !client.regionCode.isEmpty() ? client.regionCode : 'Не указан'}">77</span>
                    </p>
                    <p class="mb-1"><strong>Регион:</strong>
                        <span th:text="${client.regionName != null && !client.regionName.isEmpty() ? client.regionName : 'Не указан'}">Москва</span>
                    </p>
                    <p class="mb-1"><strong>Файловые операции:</strong>
                        <span th:text="${client.fileOperationsCount != null ? client.fileOperationsCount : 0}">0</span>
                    </p>
                </div>
                <div class="col-md-6">
                    <p><strong>Описание:</strong></p>
                    <p th:text="${client.description != null && !client.description.isEmpty() ? client.description : 'Описание отсутствует'}">
                        Описание клиента.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Навигация по разделам клиента -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-sitemap me-2"></i>Разделы клиента
                    </h6>
                    <div class="row">
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <button class="btn btn-primary" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview"
                                        type="button" role="tab" aria-controls="overview" aria-selected="true">
                                    <i class="fas fa-chart-line me-1"></i>Обзор
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <a th:href="@{/clients/{id}/import(id=${client.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-import me-1"></i>Импорт
                                </a>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <a th:href="@{/clients/{id}/export(id=${client.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-export me-1"></i>Экспорт
                                </a>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates"
                                        type="button" role="tab" aria-controls="templates" aria-selected="false">
                                    <i class="fas fa-cogs me-1"></i>Шаблоны
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <a th:href="@{/clients/{id}/operations(id=${client.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-history me-1"></i>История
                                </a>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <a th:href="@{/clients/{id}/statistics(id=${client.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-chart-bar me-1"></i>Статистика
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="clientTabsContent">
        <!-- Вкладка обзора (бывшие операции) -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>История операций
                    </h5>
                </div>
                <div class="card-body">
                    <form id="operationsFilter" class="row g-3 mb-3" onsubmit="return false;">
                        <div class="col-md-3">
                            <label for="filterType" class="form-label">Тип операции</label>
                            <select id="filterType" class="form-select">
                                <option value="">Все</option>
                                <option value="IMPORT">Импорт</option>
                                <option value="EXPORT">Экспорт</option>
                                <option value="PROCESS">Обработка</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterStatus" class="form-label">Статус</label>
                            <select id="filterStatus" class="form-select">
                                <option value="">Все</option>
                                <option value="PENDING">Ожидание</option>
                                <option value="PROCESSING">В процессе</option>
                                <option value="COMPLETED">Завершено</option>
                                <option value="FAILED">Ошибка</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterFrom" class="form-label">Дата с</label>
                            <input type="date" id="filterFrom" class="form-control"/>
                        </div>
                        <div class="col-md-2">
                            <label for="filterTo" class="form-label">Дата по</label>
                            <input type="date" id="filterTo" class="form-control"/>
                        </div>
                        <div class="col-md-2">
                            <label for="filterSize" class="form-label">На странице</label>
                            <select id="filterSize" class="form-select">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div class="col-md-2 align-self-end">
                            <button type="button" class="btn btn-primary" onclick="applyOperationFilters()">Применить</button>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-hover" id="operationsTable">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Тип</th>
                                <th>Файл</th>
                                <th>Статус</th>
                                <th>Прогресс</th>
                                <th>Время запуска</th>
                                <th>Записей</th>
                                <th>Действия</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Операции будут загружены через AJAX -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noOperations" class="text-center text-muted py-4" style="display: none;">
                        Нет операций для отображения
                    </div>
                    <div id="operationsPagination" class="mt-3"></div>
                </div>
            </div>
        </div>



        <!-- Новая вкладка шаблонов - объединенная -->
        <div class="tab-pane fade" id="templates" role="tabpanel" aria-labelledby="templates-tab">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-file-import me-2"></i>Шаблоны импорта
                            </h6>
                            <a th:href="@{/import/templates/client/{clientId}/create(clientId=${client.id})}"
                               class="btn btn-sm btn-success">
                                <i class="fas fa-plus me-1"></i>Создать
                            </a>
                        </div>
                        <div class="card-body">
                            <div id="importTemplatesList">
                                <div class="template-loading">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    Загрузка...
                                </div>
                            </div>
                            <div class="mt-3">
                                <a th:href="@{/import/templates/client/{clientId}(clientId=${client.id})}"
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-list me-1"></i>Все шаблоны
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-file-export me-2"></i>Шаблоны экспорта
                            </h6>
                            <a th:href="@{/export/templates/client/{clientId}/create(clientId=${client.id})}"
                               class="btn btn-sm btn-success">
                                <i class="fas fa-plus me-1"></i>Создать
                            </a>
                        </div>
                        <div class="card-body">
                            <div id="exportTemplatesList">
                                <div class="template-loading">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    Загрузка...
                                </div>
                            </div>
                            <div class="mt-3">
                                <a th:href="@{/export/templates/client/{clientId}(clientId=${client.id})}"
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-list me-1"></i>Все шаблоны
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div class="modal fade" id="deleteClientModal" tabindex="-1" aria-labelledby="deleteClientModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteClientModalLabel">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить клиента <strong th:text="${client.name}">Имя клиента</strong>?</p>
                    <p class="text-danger"><strong>Внимание:</strong> Это действие нельзя отменить. Все файлы и операции
                        этого клиента будут удалены.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <form th:action="@{/clients/{id}/delete(id=${client.id})}" method="post">
                        <button type="submit" class="btn btn-danger">Удалить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stomp-websocket@2.3.4-next/lib/stomp.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        // Загружаем операции клиента
        loadOperations();


        // Обработка якоря в URL для переключения на нужную вкладку
        if (window.location.hash === '#operations') {
            const tab = new bootstrap.Tab(document.getElementById('overview-tab'));
            tab.show();
        } else if (window.location.hash === '#templates') {
            const tab = new bootstrap.Tab(document.getElementById('templates-tab'));
            tab.show();
        }

        // Автообновление операций каждые 5 секунд если есть активные операции
        setInterval(function() {
            if (hasActiveOperations) {
                loadOperations();
            }
        }, 5000);
    });

    let hasActiveOperations = false;
    let currentPage = 0;

    function applyOperationFilters() {
        currentPage = 0;
        loadOperations();
    }

    function loadOperations(page = currentPage) {
        const clientId = /*[[${client.id}]]*/ 0;
        const params = new URLSearchParams();
        params.append('page', page);
        params.append('size', document.getElementById('filterSize').value);

        const type = document.getElementById('filterType').value;
        if (type) params.append('operationType', type);
        const status = document.getElementById('filterStatus').value;
        if (status) params.append('status', status);
        const from = document.getElementById('filterFrom').value;
        if (from) params.append('from', from);
        const to = document.getElementById('filterTo').value;
        if (to) params.append('to', to);

        console.log('Запрос операций для клиента', clientId, 'страница', page);

        fetch(`/api/clients/${clientId}/operations?` + params.toString())
            .then(response => {
                console.log('Ответ сервера по операциям статус', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Ошибка ответа сервера');
                    });
                }
                return response.json();
            })
            .then(pageData => {
                console.log('Получены данные страницы операций', pageData);
                currentPage = pageData.page;
                displayOperations(pageData.operations);
                updatePagination(pageData);
            })
            .catch(error => {
                console.error('Ошибка загрузки операций:', error);
                document.getElementById('noOperations').style.display = 'block';
                document.querySelector('#operationsTable tbody').innerHTML = '';
                document.getElementById('operationsPagination').innerHTML = '';
            });
    }

    function displayOperations(operations) {
        const tbody = document.querySelector('#operationsTable tbody');
        const noOps = document.getElementById('noOperations');

        if (!operations || operations.length === 0) {
            console.log('Операции не найдены для отображения');
            tbody.innerHTML = '';
            noOps.style.display = 'block';
            hasActiveOperations = false;
            return;
        }

        console.debug('Загружены операции:', operations);
        operations.forEach(op => console.debug('Операция', op.id, 'статус', op.status, 'прогресс', op.processingProgress));

        noOps.style.display = 'none';
        hasActiveOperations = operations.some(op =>
            op.status === 'PROCESSING' || op.status === 'PENDING'
        );

        tbody.innerHTML = operations.map(op => `
            <tr class="operation-row">
                <td>${op.id}</td>
                <td>
                    <i class="fas fa-${getOperationIcon(op.operationType)} me-1"></i>
                    ${getOperationTypeDisplay(op.operationType)}
                </td>
                <td class="text-truncate" style="max-width: 200px;" title="${op.fileName}">
                    ${op.fileName}
                </td>
                <td>
                    <span class="badge status-badge ${getStatusClass(op.status)}">
                        ${getStatusDisplay(op.status)}
                    </span>
                </td>
                <td>
                    ${op.status === 'PROCESSING'
            ? `<div class="progress progress-compact">
                             <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                  role="progressbar"
                                  style="width: ${op.processingProgress || 0}%"
                                  aria-valuenow="${op.processingProgress || 0}"
                                  aria-valuemin="0"
                                  aria-valuemax="100">
                               <small class="text-white fw-bold">${op.processingProgress || 0}%</small>
                             </div>
                           </div>`
            : (op.processingProgress != null ? op.processingProgress + '%' : '-')}
                </td>
                <td>${formatDateTime(op.startedAt)}</td>
                <td>${op.recordCount || '-'}</td>
                <td>
                    <a href="/import/status/${op.id}" class="btn btn-sm btn-outline-primary me-1">
                        <i class="fas fa-eye me-1"></i>Детали
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            onclick="deleteOperation(${op.id})">
                        <i class="fas fa-trash-alt me-1"></i>Удалить
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function updatePagination(pageData) {
        const container = document.getElementById('operationsPagination');
        if (!pageData || pageData.totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        const prevDisabled = pageData.page === 0 ? 'disabled' : '';
        const nextDisabled = pageData.page >= pageData.totalPages - 1 ? 'disabled' : '';
        container.innerHTML = `
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item ${prevDisabled}">
                        <a class="page-link" href="#" onclick="changeOperationsPage(${pageData.page - 1}); return false;">Предыдущая</a>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">${pageData.page + 1} / ${pageData.totalPages}</span>
                    </li>
                    <li class="page-item ${nextDisabled}">
                        <a class="page-link" href="#" onclick="changeOperationsPage(${pageData.page + 1}); return false;">Следующая</a>
                    </li>
                </ul>
            </nav>`;
    }

    function changeOperationsPage(page) {
        if (page < 0) return;
        loadOperations(page);
    }

    function deleteOperation(operationId) {
        if (!confirm('Вы действительно хотите удалить эту операцию?')) {
            return;
        }
        if (!confirm('Все связанные данные будут удалены безвозвратно. Продолжить?')) {
            return;
        }

        fetch(`/api/operations/${operationId}`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка удаления');
                }
                loadOperations();
            })
            .catch(error => {
                console.error('Ошибка удаления операции:', error);
                alert('Не удалось удалить операцию');
            });
    }


    // Загрузка списков шаблонов для вкладки "Шаблоны"
    function loadTemplatesList() {
        const clientId = /*[[${client.id}]]*/ 0;

        // Загружаем шаблоны импорта
        fetch(`/api/import/templates/client/${clientId}/summary`)
            .then(response => response.json())
            .then(templates => {
                displayImportTemplates(templates);
            })
            .catch(error => {
                document.getElementById('importTemplatesList').innerHTML =
                    '<div class="text-muted">Ошибка загрузки шаблонов</div>';
            });

        // Загружаем шаблоны экспорта
        fetch(`/api/export/templates/client/${clientId}/summary`)
            .then(response => response.json())
            .then(templates => {
                displayExportTemplates(templates);
            })
            .catch(error => {
                document.getElementById('exportTemplatesList').innerHTML =
                    '<div class="text-muted">Ошибка загрузки шаблонов</div>';
            });
    }

    function displayImportTemplates(templates) {
        const container = document.getElementById('importTemplatesList');
        if (templates.length === 0) {
            container.innerHTML = '<div class="text-muted">Нет шаблонов</div>';
            return;
        }

        const html = templates.slice(0, 3).map(template => `
            <div class="template-item d-flex justify-content-between align-items-center">
                <div>
                    <a href="/import/templates/${template.id}" class="text-decoration-none">
                        <strong>${template.name}</strong>
                    </a>
                    <br><small class="text-muted">${template.entityType}</small>
                </div>
                <a href="/import/templates/${template.id}/edit" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-edit"></i>
                </a>
            </div>
        `).join('');

        container.innerHTML = html;
    }

    function displayExportTemplates(templates) {
        const container = document.getElementById('exportTemplatesList');
        if (templates.length === 0) {
            container.innerHTML = '<div class="text-muted">Нет шаблонов</div>';
            return;
        }

        const html = templates.slice(0, 3).map(template => `
            <div class="template-item d-flex justify-content-between align-items-center">
                <div>
                    <a href="/export/templates/${template.id}" class="text-decoration-none">
                        <strong>${template.name}</strong>
                    </a>
                    <br><small class="text-muted">${template.entityType}</small>
                </div>
                <a href="/export/templates/${template.id}/edit" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-edit"></i>
                </a>
            </div>
        `).join('');

        container.innerHTML = html;
    }

    // Загружаем при переключении на вкладку шаблонов
    document.getElementById('templates-tab').addEventListener('shown.bs.tab', function() {
        loadTemplatesList();
    });

    function getOperationIcon(type) {
        switch(type) {
            case 'IMPORT': return 'file-import';
            case 'EXPORT': return 'file-export';
            case 'PROCESS': return 'cogs';
            default: return 'file';
        }
    }

    function getOperationTypeDisplay(type) {
        switch(type) {
            case 'IMPORT': return 'Импорт';
            case 'EXPORT': return 'Экспорт';
            case 'PROCESS': return 'Обработка';
            default: return type;
        }
    }

    function getStatusDisplay(status) {
        switch(status) {
            case 'PENDING': return 'Ожидание';
            case 'PROCESSING': return 'В процессе';
            case 'COMPLETED': return 'Завершено';
            case 'FAILED': return 'Ошибка';
            default: return status;
        }
    }

    function getStatusClass(status) {
        switch(status) {
            case 'PENDING': return 'status-pending';
            case 'PROCESSING': return 'status-processing';
            case 'COMPLETED': return 'status-success';
            case 'FAILED': return 'status-error';
            default: return 'status-unknown';
        }
    }

    function formatDateTime(dateTime) {
        if (!dateTime) {
            return '-';
        }

        let millis;
        if (Array.isArray(dateTime)) {
            const [y, m, d, h = 0, min = 0, s = 0] = dateTime;
            millis = Date.UTC(y, (m || 1) - 1, d || 1, h, min, s);
        } else if (typeof dateTime === 'number') {
            millis = dateTime < 1e12 ? dateTime * 1000 : dateTime;
        } else if (typeof dateTime === 'string' && /^\d+$/.test(dateTime)) {
            const num = parseInt(dateTime, 10);
            millis = num < 1e12 ? num * 1000 : num;
        } else {
            millis = Date.parse(dateTime);
        }

        if (isNaN(millis)) {
            return '-';
        }

        return new Date(millis).toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    /*]]*/
</script>
</body>
</html>