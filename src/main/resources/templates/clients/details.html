<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        ${client.name + ' - Обзор клиента'},
        ~{::section},
        ~{::script},
        ~{::style},
        ${client.name},
        ~{::.page-actions}
      )}">
<head>
    <title th:text="${client.name + ' - Обзор клиента'}">Клиент - Обзор клиента</title>
    <style>
        .section-card {
            transition: transform 0.2s;
        }
        .section-card:hover {
            transform: translateY(-2px);
        }
        .info-card {
            background-color: #f8f9fa;
            border-left: 4px solid #17a2b8;
        }
        .stats-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #495057;
        }
        .stats-label {
            color: #6c757d;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <a th:href="@{/clients/{id}/edit(id=${client.id})}" class="btn btn-primary btn-primary-action">
        <i class="fas fa-edit me-1"></i>Редактировать
    </a>
    <button type="button" class="btn btn-danger btn-secondary-action" data-bs-toggle="modal" data-bs-target="#deleteClientModal">
        <i class="fas fa-trash-alt me-1"></i>Удалить
    </button>
    <a th:href="@{/clients}" class="btn btn-secondary btn-back">
        <i class="fas fa-arrow-left me-1"></i>К списку
    </a>
</div>

<section>
    <!-- Детали клиента -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><strong>Код региона:</strong>
                        <span th:text="${client.regionCode != null && !client.regionCode.isEmpty() ? client.regionCode : 'Не указан'}">77</span>
                    </p>
                    <p class="mb-1"><strong>Регион:</strong>
                        <span th:text="${client.regionName != null && !client.regionName.isEmpty() ? client.regionName : 'Не указан'}">Москва</span>
                    </p>
                    <p class="mb-1"><strong>Файловые операции:</strong>
                        <span th:text="${client.fileOperationsCount != null ? client.fileOperationsCount : 0}">0</span>
                    </p>
                </div>
                <div class="col-md-6">
                    <p><strong>Описание:</strong></p>
                    <p th:text="${client.description != null && !client.description.isEmpty() ? client.description : 'Описание отсутствует'}">
                        Описание клиента.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Навигация по разделам клиента -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-sitemap me-2"></i>Разделы клиента
                    </h6>
                    <div class="row">
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <a th:href="@{/clients/{id}/import(id=${client.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-import me-1"></i>Импорт
                                </a>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <a th:href="@{/clients/{id}/export(id=${client.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-export me-1"></i>Экспорт
                                </a>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <a th:href="@{/clients/{id}/templates(id=${client.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-cogs me-1"></i>Шаблоны
                                </a>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <a th:href="@{/clients/{id}/operations(id=${client.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-history me-1"></i>История
                                </a>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-2">
                            <div class="d-grid">
                                <a th:href="@{/clients/{id}/statistics(id=${client.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-chart-bar me-1"></i>Статистика
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Краткая статистика -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card section-card text-center">
                <div class="card-body">
                    <div class="stats-value" id="totalOperations">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="stats-label">Всего операций</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card section-card text-center">
                <div class="card-body">
                    <div class="stats-value" id="totalRecords">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="stats-label">Записей обработано</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card section-card text-center">
                <div class="card-body">
                    <div class="stats-value" id="totalTemplates">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="stats-label">Активных шаблонов</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card section-card text-center">
                <div class="card-body">
                    <div class="stats-value text-warning" id="activeOperations">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="stats-label">Активных операций</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Последние операции -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>Последние операции
                    </h5>
                    <a th:href="@{/clients/{id}/operations(id=${client.id})}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-history me-1"></i>Вся история
                    </a>
                </div>
                <div class="card-body">
                    <div id="recentOperations">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <div class="mt-2">Загрузка последних операций...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Информационная панель -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info info-card">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Обзор клиента:</strong>
                Здесь отображается краткая информация о клиенте и его активности. 
                Используйте навигационное меню выше для перехода к конкретным разделам: импорт, экспорт, шаблоны, история операций и подробная статистика.
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div class="modal fade" id="deleteClientModal" tabindex="-1" aria-labelledby="deleteClientModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteClientModalLabel">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить клиента <strong th:text="${client.name}">Имя клиента</strong>?</p>
                    <p class="text-danger"><strong>Внимание:</strong> Это действие нельзя отменить. Все файлы и операции
                        этого клиента будут удалены.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <form th:action="@{/clients/{id}/delete(id=${client.id})}" method="post">
                        <button type="submit" class="btn btn-danger">Удалить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        // Загружаем данные обзора при загрузке страницы
        loadOverviewData();

        // Автообновление каждые 30 секунд
        setInterval(loadOverviewData, 30000);
    });

    function loadOverviewData() {
        const clientId = /*[[${client.id}]]*/ 0;
        
        // Загружаем общую статистику
        loadGeneralStats(clientId);
        
        // Загружаем последние операции
        loadRecentOperations(clientId);
    }

    function loadGeneralStats(clientId) {
        // Загружаем общую статистику операций
        fetch(`/api/clients/${clientId}/operations?page=0&size=1`)
            .then(response => response.ok ? response.json() : null)
            .then(pageData => {
                const totalOps = pageData ? pageData.totalElements : 0;
                document.getElementById('totalOperations').textContent = totalOps;
            })
            .catch(error => {
                console.error('Ошибка загрузки общей статистики:', error);
                document.getElementById('totalOperations').textContent = 'N/A';
            });

        // Загружаем статистику активных операций
        fetch(`/api/clients/${clientId}/operations?status=PROCESSING,PENDING&page=0&size=1`)
            .then(response => response.ok ? response.json() : null)
            .then(pageData => {
                const activeOps = pageData ? pageData.totalElements : 0;
                document.getElementById('activeOperations').textContent = activeOps;
                
                // Если есть активные операции, меняем цвет
                if (activeOps > 0) {
                    document.getElementById('activeOperations').className = 'stats-value text-warning';
                } else {
                    document.getElementById('activeOperations').className = 'stats-value text-success';
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки активных операций:', error);
                document.getElementById('activeOperations').textContent = 'N/A';
            });

        // Загружаем количество шаблонов
        Promise.all([
            fetch(`/api/import/templates/client/${clientId}/summary`).then(r => r.ok ? r.json() : []),
            fetch(`/api/export/templates/client/${clientId}/summary`).then(r => r.ok ? r.json() : [])
        ])
        .then(([importTemplates, exportTemplates]) => {
            const totalTemplates = importTemplates.length + exportTemplates.length;
            document.getElementById('totalTemplates').textContent = totalTemplates;
        })
        .catch(error => {
            console.error('Ошибка загрузки шаблонов:', error);
            document.getElementById('totalTemplates').textContent = 'N/A';
        });

        // Загружаем общую статистику записей (это может потребовать отдельного API)
        // Пока используем заглушку
        document.getElementById('totalRecords').textContent = '0';
    }

    function loadRecentOperations(clientId) {
        fetch(`/api/clients/${clientId}/operations?page=0&size=5`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка загрузки операций');
                }
                return response.json();
            })
            .then(pageData => {
                displayRecentOperations(pageData.operations || []);
            })
            .catch(error => {
                console.error('Ошибка загрузки последних операций:', error);
                document.getElementById('recentOperations').innerHTML = `
                    <div class="text-center py-4">
                        <div class="text-muted">
                            <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                            <div>Ошибка загрузки операций</div>
                        </div>
                    </div>
                `;
            });
    }

    function displayRecentOperations(operations) {
        const container = document.getElementById('recentOperations');
        
        if (!operations || operations.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <h6>Нет операций</h6>
                        <p class="mb-0">Выполните импорт или экспорт данных, чтобы увидеть операции здесь</p>
                        <div class="mt-3">
                            <a href="/clients/${/*[[${client.id}]]*/ 0}/import" class="btn btn-primary btn-sm me-2">
                                <i class="fas fa-file-import me-1"></i>Импорт
                            </a>
                            <a href="/clients/${/*[[${client.id}]]*/ 0}/export" class="btn btn-success btn-sm">
                                <i class="fas fa-file-export me-1"></i>Экспорт
                            </a>
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        const html = operations.map((op, index) => `
            <div class="d-flex justify-content-between align-items-center ${index < operations.length - 1 ? 'border-bottom' : ''} py-3">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${getOperationIcon(op.operationType)} me-2 text-muted"></i>
                        <div>
                            <div class="fw-bold">#${op.id} - ${getOperationTypeDisplay(op.operationType)}</div>
                            <small class="text-muted">
                                <i class="fas fa-file me-1"></i>${op.fileName}
                                ${op.recordCount ? ` • ${op.recordCount} записей` : ''}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="text-end">
                    <div class="mb-1">
                        <span class="badge ${getStatusClass(op.status)}">${getStatusDisplay(op.status)}</span>
                    </div>
                    <small class="text-muted">${formatDateTime(op.startedAt)}</small>
                    ${op.status === 'PROCESSING' ? `
                        <br><div class="progress progress-sm mt-1" style="height: 6px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 style="width: ${op.processingProgress || 0}%"></div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');

        container.innerHTML = html;

        // Добавляем ссылку на полную историю внизу
        if (operations.length === 5) {
            container.innerHTML += `
                <div class="text-center pt-3 border-top">
                    <a href="/clients/${/*[[${client.id}]]*/ 0}/operations" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-history me-1"></i>Посмотреть всю историю операций
                    </a>
                </div>
            `;
        }
    }

    function getOperationIcon(type) {
        switch(type) {
            case 'IMPORT': return 'file-import';
            case 'EXPORT': return 'file-export';
            case 'PROCESS': return 'cogs';
            default: return 'file';
        }
    }

    function getOperationTypeDisplay(type) {
        switch(type) {
            case 'IMPORT': return 'Импорт';
            case 'EXPORT': return 'Экспорт';
            case 'PROCESS': return 'Обработка';
            default: return type;
        }
    }

    function getStatusDisplay(status) {
        switch(status) {
            case 'PENDING': return 'Ожидание';
            case 'PROCESSING': return 'В процессе';
            case 'COMPLETED': return 'Завершено';
            case 'FAILED': return 'Ошибка';
            default: return status;
        }
    }

    function getStatusClass(status) {
        switch(status) {
            case 'PENDING': return 'bg-warning text-dark';
            case 'PROCESSING': return 'bg-primary';
            case 'COMPLETED': return 'bg-success';
            case 'FAILED': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    function formatDateTime(dateTime) {
        if (!dateTime) {
            return 'Неизвестно';
        }

        let millis;
        if (Array.isArray(dateTime)) {
            const [y, m, d, h = 0, min = 0, s = 0] = dateTime;
            millis = Date.UTC(y, (m || 1) - 1, d || 1, h, min, s);
        } else if (typeof dateTime === 'number') {
            millis = dateTime < 1e12 ? dateTime * 1000 : dateTime;
        } else if (typeof dateTime === 'string' && /^\d+$/.test(dateTime)) {
            const num = parseInt(dateTime, 10);
            millis = num < 1e12 ? num * 1000 : num;
        } else {
            millis = Date.parse(dateTime);
        }

        if (isNaN(millis)) {
            return 'Неизвестно';
        }

        return new Date(millis).toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    /*]]*/
</script>
</body>
</html>