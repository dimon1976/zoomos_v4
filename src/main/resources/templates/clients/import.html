<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        ${client.name + ' - Импорт файлов'},
        ~{::section},
        ~{::script},
        ~{::style},
        ${client.name},
        ~{::.page-actions}
      )}">
<head>
    <title th:text="${client.name + ' - Импорт файлов'}">Клиент - Импорт файлов</title>
    <style>
        /* Подключение унифицированных стилей через отдельный CSS файл */
        @import url('/css/upload.css');
        @import url('/css/info-sections.css');
    </style>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <a th:href="@{/clients/{id}(id=${client.id})}" class="btn btn-secondary btn-back">
        <i class="fas fa-arrow-left me-1"></i>К обзору клиента
    </a>
    <a th:href="@{/clients}" class="btn btn-secondary">
        <i class="fas fa-list me-1"></i>К списку клиентов
    </a>
</div>

<section>
    <!-- Заголовок страницы -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-file-import me-2"></i>Импорт файлов для клиента: <span th:text="${client.name}">Клиент</span></h2>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-import me-2"></i>Быстрый импорт файлов
                    </h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/import/{clientId}/upload(clientId=${client.id})}"
                          method="post" enctype="multipart/form-data" id="quickImportForm">

                        <!-- Унифицированная зона загрузки файлов -->
                        <div class="upload-zone" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Перетащите файлы сюда или нажмите для выбора</h5>
                            <p class="text-muted">Поддерживаемые форматы: CSV, Excel (XLS, XLSX), TXT</p>
                            <input type="file" class="d-none upload-input" id="files" name="files"
                                   multiple required accept=".csv,.xlsx,.xls,.txt">
                            <button type="button" class="btn btn-primary mt-3 select-files-btn" id="selectFilesBtn">
                                <i class="fas fa-folder-open me-1"></i>Выбрать файлы
                            </button>
                        </div>
                        <!-- Область предпросмотра файлов -->
                        <div id="selectedFiles" class="file-preview-container mt-3"></div>

                        <div class="mt-3" id="uploadActions" style="display: none;">
                            <button type="submit" class="btn btn-success" id="uploadBtn">
                                <i class="fas fa-upload me-1"></i>Загрузить и анализировать
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="clearFiles()">
                                <i class="fas fa-times me-1"></i>Очистить
                            </button>
                        </div>
                    </form>

                    <div class="mt-4">
                        <!-- Инструкции по работе -->
                        <div class="info-section info-section--instructions info-section--compact">
                            <h6 class="info-section__title">
                                <i class="fas fa-list-ol info-section__icon"></i>
                                Как это работает
                            </h6>
                            <div class="info-section__body">
                                <ol>
                                    <li>Выберите один или несколько файлов для импорта</li>
                                    <li>Система проанализирует структуру файлов</li>
                                    <li>Выберите подходящий шаблон импорта</li>
                                    <li>Запустите процесс импорта</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <!-- Важные заметки -->
                        <div class="info-section info-section--warnings info-section--compact">
                            <h6 class="info-section__title">
                                <i class="fas fa-exclamation-triangle info-section__icon"></i>
                                Важная информация
                            </h6>
                            <div class="info-section__body">
                                <ul class="list-with-icons">
                                    <li class="list-item--info">Вы можете загрузить несколько файлов одновременно</li>
                                    <li class="list-item--info">Максимальный размер каждого файла: 600 МБ</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <!-- Управление шаблонами -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Управление шаблонами
                    </h6>
                </div>
                <div class="card-body">
                    <a th:href="@{/clients/{id}/import/templates(id=${client.id})}"
                       class="btn btn-outline-primary w-100">
                        <i class="fas fa-cog me-1"></i>Настроить шаблоны
                    </a>
                </div>
            </div>

            <div class="mt-3">
                <!-- Возможности системы -->
                <div class="info-section info-section--description">
                    <h6 class="info-section__title">
                        <i class="fas fa-star info-section__icon"></i>
                        Возможности
                    </h6>
                    <div class="info-section__body">
                        <ul class="list-with-icons">
                            <li>Автоматическое определение кодировки</li>
                            <li>Поддержка CSV, Excel (XLS, XLSX)</li>
                            <li>Валидация данных перед импортом</li>
                            <li>Обработка больших файлов</li>
                            <li>Детальные отчеты об ошибках</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Навигация к другим разделам клиента -->
            <div class="mt-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-sitemap me-2"></i>Другие разделы
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a th:href="@{/clients/{id}(id=${client.id})}"
                               class="btn btn-outline-secondary">
                                <i class="fas fa-home me-1"></i>Обзор
                            </a>
                            <a th:href="@{/clients/{id}/export(id=${client.id})}"
                               class="btn btn-outline-secondary">
                                <i class="fas fa-file-export me-1"></i>Экспорт
                            </a>
                            <a th:href="@{/clients/{id}/templates(id=${client.id})}"
                               class="btn btn-outline-secondary">
                                <i class="fas fa-file-alt me-1"></i>Шаблоны
                            </a>
                            <a th:href="@{/clients/{id}/operations(id=${client.id})}"
                               class="btn btn-outline-secondary">
                                <i class="fas fa-history me-1"></i>История операций
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="/js/upload.js"></script>
<script>
    // Инициализация UploadManager для импорта файлов
    let uploadManager;

    document.addEventListener('DOMContentLoaded', function() {
        const uploadActions = document.getElementById('uploadActions');

        // Создаем конфигурацию для импорта
        const config = UploadConfig.importFiles('fileUploadArea', 'files', 'selectedFiles', 'selectFilesBtn');

        // Добавляем обработчики событий
        config.onFileSelect = function(files) {
            if (files.length > 0) {
                uploadActions.style.display = 'block';
            }
        };

        config.onFileRemove = function(file, index) {
            if (uploadManager.getSelectedFiles().length === 0) {
                uploadActions.style.display = 'none';
            }
        };

        // Инициализируем менеджер загрузки
        uploadManager = new UploadManager(config);
    });

    // Функция очистки для обратной совместимости
    function clearFiles() {
        uploadManager.clearFiles();
        document.getElementById('uploadActions').style.display = 'none';
    }

    // Валидация формы перед отправкой
    document.getElementById('quickImportForm').addEventListener('submit', function(e) {
        const files = fileInput.files;
        if (files.length === 0) {
            e.preventDefault();
            alert('Пожалуйста, выберите файлы для загрузки');
            return;
        }

        // Проверка размера файлов
        const maxSize = 600 * 1024 * 1024; // 600MB
        for (let i = 0; i < files.length; i++) {
            if (files[i].size > maxSize) {
                e.preventDefault();
                alert(`Файл "${files[i].name}" превышает максимальный размер 600MB`);
                return;
            }
        }

        // Показываем индикатор загрузки
        const submitBtn = document.getElementById('uploadBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Загружаем...';
    });
</script>
</body>
</html>