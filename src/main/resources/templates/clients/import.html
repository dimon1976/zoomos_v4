<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        ${client.name + ' - Импорт файлов'},
        ~{::section},
        ~{::script},
        ~{::style},
        ${client.name},
        ~{::.page-actions}
      )}">
<head>
    <title th:text="${client.name + ' - Импорт файлов'}">Клиент - Импорт файлов</title>
    <style>
        /* Подключение унифицированных стилей через отдельный CSS файл */
        @import url('/css/upload.css');
        @import url('/css/info-sections.css');
    </style>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <a th:href="@{/clients/{id}(id=${client.id})}" class="btn btn-secondary btn-back">
        <i class="fas fa-arrow-left me-1"></i>К обзору клиента
    </a>
    <a th:href="@{/clients}" class="btn btn-secondary">
        <i class="fas fa-list me-1"></i>К списку клиентов
    </a>
</div>

<section>
    <!-- Заголовок страницы -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-file-import me-2"></i>Импорт файлов для клиента: <span th:text="${client.name}">Клиент</span></h2>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-import me-2"></i>Быстрый импорт файлов
                    </h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/import/{clientId}/upload(clientId=${client.id})}"
                          method="post" enctype="multipart/form-data" id="quickImportForm">

                        <!-- Унифицированная зона загрузки файлов -->
                        <div class="upload-zone" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Перетащите файлы сюда или нажмите для выбора</h5>
                            <p class="text-muted">Поддерживаемые форматы: CSV, Excel (XLS, XLSX), TXT</p>
                            <input type="file" class="d-none upload-input" id="files" name="files"
                                   multiple required accept=".csv,.xlsx,.xls,.txt">
                            <button type="button" class="btn btn-primary mt-3 select-files-btn" id="selectFilesBtn">
                                <i class="fas fa-folder-open me-1"></i>Выбрать файлы
                            </button>
                        </div>
                        <!-- Область предпросмотра файлов -->
                        <div id="selectedFiles" class="file-preview-container mt-3"></div>

                        <div class="mt-3" id="uploadActions" style="display: none;">
                            <button type="submit" class="btn btn-success" id="uploadBtn">
                                <i class="fas fa-upload me-1"></i>Загрузить и анализировать
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="clearFiles()">
                                <i class="fas fa-times me-1"></i>Очистить
                            </button>
                        </div>
                    </form>

                    <div class="mt-4">
                        <th:block th:replace="~{fragments/info-sections :: instructions('Как это работает', '
                            <ol>
                                <li>Выберите один или несколько файлов для импорта</li>
                                <li>Система проанализирует структуру файлов</li>
                                <li>Выберите подходящий шаблон импорта</li>
                                <li>Запустите процесс импорта</li>
                            </ol>
                        ', 'compact')}"></th:block>
                    </div>

                    <div class="mt-3">
                        <th:block th:replace="~{fragments/info-sections :: importantNotes(${{#lists.toList(
                            #maps.toMap('text', 'Вы можете загрузить несколько файлов одновременно', 'type', 'info'),
                            #maps.toMap('text', 'Максимальный размер каждого файла: 600 МБ', 'type', 'info')
                        )}})}"></th:block>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <th:block th:replace="~{fragments/info-sections :: quickNavigation('Управление шаблонами', ${{#lists.toList(
                #maps.toMap('text', 'Настроить шаблоны', 'url', '/clients/' + ${client.id} + '/import/templates', 'icon', 'fas fa-cog', 'buttonClass', 'btn-outline-primary')
            )}})}"></th:block>

            <div class="mt-3">
                <th:block th:replace="~{fragments/info-sections :: features('Возможности', ${{#lists.toList(
                    #maps.toMap('text', 'Автоматическое определение кодировки'),
                    #maps.toMap('text', 'Поддержка CSV, Excel (XLS, XLSX)'),
                    #maps.toMap('text', 'Валидация данных перед импортом'),
                    #maps.toMap('text', 'Обработка больших файлов'),
                    #maps.toMap('text', 'Детальные отчеты об ошибках')
                )}}, 'description')}"></th:block>
            </div>

            <!-- Навигация к другим разделам клиента -->
            <div class="mt-3">
                <th:block th:replace="~{fragments/info-sections :: quickNavigation('Другие разделы', ${{#lists.toList(
                    #maps.toMap('text', 'Обзор', 'url', '/clients/' + ${client.id}, 'icon', 'fas fa-home', 'buttonClass', 'btn-outline-secondary'),
                    #maps.toMap('text', 'Экспорт', 'url', '/clients/' + ${client.id} + '/export', 'icon', 'fas fa-file-export', 'buttonClass', 'btn-outline-secondary'),
                    #maps.toMap('text', 'Шаблоны', 'url', '/clients/' + ${client.id} + '/templates', 'icon', 'fas fa-file-alt', 'buttonClass', 'btn-outline-secondary'),
                    #maps.toMap('text', 'История операций', 'url', '/clients/' + ${client.id} + '/operations', 'icon', 'fas fa-history', 'buttonClass', 'btn-outline-secondary')
                )}})}"></th:block>
            </div>
        </div>
    </div>
</section>

<script src="/js/upload.js"></script>
<script>
    // Инициализация UploadManager для импорта файлов
    let uploadManager;

    document.addEventListener('DOMContentLoaded', function() {
        const uploadActions = document.getElementById('uploadActions');

        // Создаем конфигурацию для импорта
        const config = UploadConfig.importFiles('fileUploadArea', 'files', 'selectedFiles', 'selectFilesBtn');

        // Добавляем обработчики событий
        config.onFileSelect = function(files) {
            if (files.length > 0) {
                uploadActions.style.display = 'block';
            }
        };

        config.onFileRemove = function(file, index) {
            if (uploadManager.getSelectedFiles().length === 0) {
                uploadActions.style.display = 'none';
            }
        };

        // Инициализируем менеджер загрузки
        uploadManager = new UploadManager(config);
    });

    // Функция очистки для обратной совместимости
    function clearFiles() {
        uploadManager.clearFiles();
        document.getElementById('uploadActions').style.display = 'none';
    }

    // Валидация формы перед отправкой
    document.getElementById('quickImportForm').addEventListener('submit', function(e) {
        const files = fileInput.files;
        if (files.length === 0) {
            e.preventDefault();
            alert('Пожалуйста, выберите файлы для загрузки');
            return;
        }

        // Проверка размера файлов
        const maxSize = 600 * 1024 * 1024; // 600MB
        for (let i = 0; i < files.length; i++) {
            if (files[i].size > maxSize) {
                e.preventDefault();
                alert(`Файл "${files[i].name}" превышает максимальный размер 600MB`);
                return;
            }
        }

        // Показываем индикатор загрузки
        const submitBtn = document.getElementById('uploadBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Загружаем...';
    });
</script>
</body>
</html>