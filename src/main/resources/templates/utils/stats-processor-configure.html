<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout/main :: html(
        title='Настройка обработки статистики',
        content=~{::content},
        scripts=~{::scripts},
        styles=~{::styles},
        pageTitle='Настройка обработки статистики',
        pageActions=~{::pageActions}
      )}">
<head>
    <title>Настройка обработки статистики</title>
</head>

<th:block th:fragment="styles">
    <style>
        .checkbox-card {
            transition: all 0.3s ease;
        }
        .checkbox-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .form-check-input:checked ~ .card {
            border-color: #28a745;
            background-color: #f8fff8;
        }
        .file-info-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #28a745;
        }
        .checkbox-option {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .checkbox-option:hover {
            border-color: #28a745;
            background-color: #f8fff8;
        }
        .checkbox-option.checked {
            border-color: #28a745;
            background-color: #f8fff8;
        }
        .preview-section {
            background-color: #f1f3f4;
            border-radius: 8px;
            padding: 1.5rem;
        }
    </style>
</th:block>

<th:block th:fragment="pageActions">
    <div class="d-flex gap-2">
        <form method="post" action="/utils/stats-processor/cancel" class="d-inline">
            <button type="submit" class="btn btn-outline-secondary">
                <i class="fas fa-times"></i> Отменить
            </button>
        </form>
    </div>
</th:block>

<th:block th:fragment="content">
    <div class="container-fluid">
        
        <!-- Информация о файле -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card file-info-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <i class="fas fa-file-excel display-1 text-success"></i>
                            </div>
                            <div class="col-md-10">
                                <h5 class="mb-2">Файл проанализирован</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Имя файла:</strong><br>
                                        <span th:text="${fileMetadata.filename}">filename.xlsx</span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Размер:</strong><br>
                                        <span th:text="${fileMetadata.fileSize}">1.2 MB</span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Строк:</strong><br>
                                        <span th:text="${fileMetadata.totalRows}">1000</span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Колонок:</strong><br>
                                        <span th:text="${fileMetadata.totalColumns}">39</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Кодировка:</strong><br>
                                        <span th:text="${fileMetadata.encoding}">UTF-8</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Форма настройки обработки -->
        <div class="row">
            <div class="col-md-8">
                <!-- Выбор параметров обработки (аналог старых чекбоксов) -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs text-success"></i>
                            Шаг 2: Выберите параметры обработки
                        </h5>
                        <small class="text-muted">Выберите какие дополнительные колонки включить в результат</small>
                    </div>
                    <div class="card-body">
                        <form id="processForm" th:object="${statsProcessDto}" method="post" action="/utils/stats-processor/process">
                            
                            <!-- Чекбоксы как в старой версии -->
                            <div class="checkbox-option" id="sourceOption">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" th:field="*{showSource}" id="showSource">
                                    <label class="form-check-label" for="showSource">
                                        <strong>Кто прописал</strong>
                                        <br>
                                        <small class="text-muted">Добавить колонку с информацией о том, кто добавил запись</small>
                                    </label>
                                </div>
                            </div>

                            <div class="checkbox-option" id="sourceReplaceOption">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" th:field="*{sourceReplace}" id="sourceReplace">
                                    <label class="form-check-label" for="sourceReplace">
                                        <strong>Заменить источник для клиента</strong>
                                        <br>
                                        <small class="text-muted">Заменить неизвестных пользователей на "manager"</small>
                                    </label>
                                </div>
                            </div>

                            <div class="checkbox-option" id="competitorUrlOption">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" th:field="*{showCompetitorUrl}" id="showCompetitorUrl">
                                    <label class="form-check-label" for="showCompetitorUrl">
                                        <strong>URL конкурента</strong>
                                        <br>
                                        <small class="text-muted">Включить колонку с ссылками на страницы конкурентов</small>
                                    </label>
                                </div>
                            </div>

                            <div class="checkbox-option" id="dateAddOption">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" th:field="*{showDateAdd}" id="showDateAdd">
                                    <label class="form-check-label" for="showDateAdd">
                                        <strong>Дата добавления</strong>
                                        <br>
                                        <small class="text-muted">Добавить колонку с датой добавления записи</small>
                                    </label>
                                </div>
                            </div>

                            <!-- Настройки формата -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h6 class="mb-0">Формат результата</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="outputFormat" class="form-label">Формат файла:</label>
                                            <select class="form-select" th:field="*{outputFormat}" id="outputFormat">
                                                <option value="xlsx">Excel (.xlsx)</option>
                                                <option value="csv">CSV (.csv)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="csvDelimiter" class="form-label">Разделитель CSV:</label>
                                            <select class="form-select" th:field="*{csvDelimiter}" id="csvDelimiter">
                                                <option value=";">Точка с запятой (;)</option>
                                                <option value=",">Запятая (,)</option>
                                                <option value="|">Вертикальная черта (|)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-primary btn-lg w-100" id="processAsyncBtn">
                                            <i class="fas fa-clock"></i> Обработать в фоне
                                        </button>
                                        <small class="text-muted">Не блокирует работу, уведомление о готовности</small>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-success btn-lg w-100" id="processBtn">
                                            <i class="fas fa-download"></i> Обработать и скачать
                                        </button>
                                        <small class="text-muted">Прямое скачивание после обработки</small>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Предварительный просмотр настроек -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-eye text-info"></i>
                            Предварительный просмотр
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="preview-section">
                            <h6>Базовые колонки (всегда включены):</h6>
                            <ul class="list-unstyled small mb-3">
                                <li><i class="fas fa-check text-success"></i> Домен</li>
                                <li><i class="fas fa-check text-success"></i> ID сайта</li>
                                <li><i class="fas fa-check text-success"></i> ID товара</li>
                                <li><i class="fas fa-check text-success"></i> Группы и категории товаров</li>
                                <li><i class="fas fa-check text-success"></i> Данные конкурентов</li>
                                <li><i class="fas fa-check text-success"></i> Основные ссылки</li>
                            </ul>
                            
                            <h6>Дополнительные колонки:</h6>
                            <ul class="list-unstyled small" id="additionalColumnsList">
                                <li class="text-muted"><i class="fas fa-info-circle"></i> Выберите параметры слева</li>
                            </ul>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb text-warning"></i>
                                <strong>Совет:</strong> Начните с базовых настроек и добавляйте дополнительные колонки по необходимости.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="scripts">
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.checkbox-option input[type="checkbox"]');
    const additionalColumnsList = document.getElementById('additionalColumnsList');
    const csvDelimiterField = document.getElementById('csvDelimiter');
    const outputFormatField = document.getElementById('outputFormat');
    
    // Колонки соответствующие чекбоксам
    const columnMap = {
        'showSource': 'Кто прописал',
        'sourceReplace': 'Замена источника (обработка данных)',
        'showCompetitorUrl': 'URL конкурента',
        'showDateAdd': 'Дата добавления'
    };
    
    // Обновление предварительного просмотра
    function updatePreview() {
        let additionalColumns = [];
        
        checkboxes.forEach(function(checkbox) {
            const option = checkbox.closest('.checkbox-option');
            if (checkbox.checked) {
                option.classList.add('checked');
                if (columnMap[checkbox.id]) {
                    additionalColumns.push(columnMap[checkbox.id]);
                }
            } else {
                option.classList.remove('checked');
            }
        });
        
        // Обновляем список дополнительных колонок
        if (additionalColumns.length > 0) {
            additionalColumnsList.innerHTML = additionalColumns
                .map(col => `<li><i class="fas fa-plus text-success"></i> ${col}</li>`)
                .join('');
        } else {
            additionalColumnsList.innerHTML = '<li class="text-muted"><i class="fas fa-info-circle"></i> Выберите параметры слева</li>';
        }
    }
    
    // Обработчики событий для чекбоксов
    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', updatePreview);
    });
    
    // Показ/скрытие настроек CSV
    outputFormatField.addEventListener('change', function() {
        csvDelimiterField.closest('.col-md-6').style.display = 
            this.value === 'csv' ? 'block' : 'none';
    });
    
    // Инициализация
    updatePreview();
    csvDelimiterField.closest('.col-md-6').style.display = 
        outputFormatField.value === 'csv' ? 'block' : 'none';
    
    // Показать спиннер при отправке (синхронный режим)
    document.getElementById('processForm').addEventListener('submit', function() {
        const processBtn = document.getElementById('processBtn');
        processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обрабатывается...';
        processBtn.disabled = true;
    });
    
    // Обработка асинхронного режима
    document.getElementById('processAsyncBtn').addEventListener('click', function() {
        const form = document.getElementById('processForm');
        const formData = new FormData(form);
        const asyncBtn = this;
        
        // Показываем спиннер
        asyncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Запускается...';
        asyncBtn.disabled = true;
        
        // Отправляем запрос на асинхронную обработку
        fetch('/utils/stats-processor/process-async', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.text();
            } else {
                throw new Error('Ошибка сервера: ' + response.status);
            }
        })
        .then(message => {
            // Показываем сообщение об успехе
            showNotification('success', 'Обработка запущена', message);
            
            // Перенаправляем на главную страницу утилит через 3 секунды
            setTimeout(() => {
                window.location.href = '/utils';
            }, 3000);
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showNotification('error', 'Ошибка', 'Не удалось запустить обработку: ' + error.message);
            
            // Восстанавливаем кнопку
            asyncBtn.innerHTML = '<i class="fas fa-clock"></i> Обработать в фоне';
            asyncBtn.disabled = false;
        });
    });
    
    // Функция для показа уведомлений
    function showNotification(type, title, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="${icon}"></i>
            <strong>${title}:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Добавляем уведомление в начало страницы
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Автоматически скрываем через 5 секунд
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
});
</script>
</th:block>
</html>