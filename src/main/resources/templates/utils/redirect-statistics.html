<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Статистика редиректов - ZoomOS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container-fluid">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
                <div class="container-fluid">
                    <a class="navbar-brand" href="/">
                        <i class="fas fa-chart-line"></i> ZoomOS - Статистика редиректов
                    </a>
                    <div class="navbar-nav ms-auto">
                        <a class="nav-link" href="/utils">
                            <i class="fas fa-arrow-left"></i> Назад к утилитам
                        </a>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Error Message -->
    <div th:if="${error}" class="row">
        <div class="col-12">
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                <span th:text="${error}"></span>
            </div>
        </div>
    </div>

    <!-- Period Selector -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-calendar-alt"></i> Период анализа
                    </h5>
                    <form method="get" class="d-inline-flex gap-2 align-items-center">
                        <select name="days" class="form-select" style="width: auto;">
                            <option value="1" th:selected="${selectedDays == 1}">Сегодня</option>
                            <option value="3" th:selected="${selectedDays == 3}">3 дня</option>
                            <option value="7" th:selected="${selectedDays == 7}">Неделя</option>
                            <option value="30" th:selected="${selectedDays == 30}">Месяц</option>
                            <option value="90" th:selected="${selectedDays == 90}">3 месяца</option>
                        </select>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> Обновить
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Statistics -->
    <div th:if="${overallStats}" class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Общая статистика
                        <span class="text-muted">за последние [[${selectedDays}]] дней</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-primary" th:text="${overallStats.total_requests ?: 0}">0</h3>
                                <small class="text-muted">Всего запросов</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-success" th:text="${overallStats.success_rate ?: 0} + '%'">0%</h3>
                                <small class="text-muted">Процент успеха</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-warning" th:text="${overallStats.block_rate ?: 0} + '%'">0%</h3>
                                <small class="text-muted">Процент блокировок</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-info" th:text="${overallStats.unique_domains ?: 0}">0</h3>
                                <small class="text-muted">Уникальных доменов</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Effectiveness -->
    <div th:if="${strategyStats}" class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy"></i> Эффективность стратегий
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Стратегия</th>
                                    <th>Всего запросов</th>
                                    <th>Успешных</th>
                                    <th>Процент успеха</th>
                                    <th>Среднее время (мс)</th>
                                    <th>Доменов</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="strategy : ${strategyStats}">
                                    <td>
                                        <span class="badge bg-primary" th:text="${strategy.strategy_name}"></span>
                                    </td>
                                    <td th:text="${strategy.total_requests}"></td>
                                    <td th:text="${strategy.successful_requests}"></td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar" 
                                                 th:classappend="${strategy.success_rate >= 80} ? 'bg-success' : (${strategy.success_rate >= 50} ? 'bg-warning' : 'bg-danger')"
                                                 th:style="'width: ' + ${strategy.success_rate} + '%'"
                                                 th:text="${strategy.success_rate} + '%'">
                                            </div>
                                        </div>
                                    </td>
                                    <td th:text="${#numbers.formatDecimal(strategy.avg_processing_time, 0, 0)}"></td>
                                    <td th:text="${strategy.unique_domains}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blocked Domains -->
    <div th:if="${blockedDomains != null and !blockedDomains.empty}" class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-ban"></i> Проблемные домены
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Домен</th>
                                    <th>Всего попыток</th>
                                    <th>Успешных</th>
                                    <th>Заблокированных</th>
                                    <th>Процент блокировок</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="domain : ${blockedDomains}">
                                    <td>
                                        <code th:text="${domain.domain}"></code>
                                        <button class="btn btn-sm btn-outline-info ms-2" 
                                                th:data-domain="${domain.domain}"
                                                onclick="getRecommendation(this.dataset.domain)">
                                            <i class="fas fa-lightbulb"></i>
                                        </button>
                                    </td>
                                    <td th:text="${domain.total_attempts}"></td>
                                    <td th:text="${domain.successful_attempts}"></td>
                                    <td th:text="${domain.blocked_attempts}"></td>
                                    <td>
                                        <span class="badge" 
                                              th:classappend="${domain.block_rate >= 50} ? 'bg-danger' : (${domain.block_rate >= 25} ? 'bg-warning' : 'bg-success')"
                                              th:text="${domain.block_rate} + '%'">
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Distribution -->
    <div th:if="${statusDistribution}" class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Распределение статусов
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Today Statistics -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-day"></i> Статистика сегодня
                    </h5>
                </div>
                <div class="card-body">
                    <div th:if="${todayStats != null and !todayStats.empty}">
                        <div th:each="stat : ${todayStats}" class="d-flex justify-content-between mb-2">
                            <span th:text="${stat.strategy_name}"></span>
                            <span class="badge bg-success" th:text="${stat.successful_today}"></span>
                        </div>
                    </div>
                    <div th:if="${todayStats == null or todayStats.empty}" class="text-muted text-center">
                        <i class="fas fa-info-circle"></i> Нет данных за сегодня
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search"></i> Поиск статистики
                    </h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchQuery" 
                               placeholder="Введите URL или домен для поиска...">
                        <button class="btn btn-primary" onclick="searchStatistics()">
                            <i class="fas fa-search"></i> Поиск
                        </button>
                    </div>
                    
                    <div id="searchResults" class="mt-3" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>URL</th>
                                        <th>Стратегия</th>
                                        <th>Статус</th>
                                        <th>Время</th>
                                        <th>Дата</th>
                                    </tr>
                                </thead>
                                <tbody id="searchResultsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recommendation Modal -->
<div class="modal fade" id="recommendationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Рекомендация стратегии</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="recommendationBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:if="${statusDistribution}">
// Status Distribution Chart
// Status Distribution Chart
if (document.getElementById('statusChart')) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    const statusLabels = [];
    const statusData = [];
    
    /*[# th:if="${statusDistribution != null and !statusDistribution.isEmpty()}"]*/
    /*[# th:each="status : ${statusDistribution}"]*/
    /*[# th:if="${status != null and status.status != null}"]*/
    statusLabels.push('[[${status.status}]]');
    statusData.push([[${status.count}]]);
    /*[/]*/
    /*[/]*/
    /*[/]*/
    
    const statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusData,
                backgroundColor: [
                    '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6c757d', '#fd7e14'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Functions
function searchStatistics() {
    const query = document.getElementById('searchQuery').value.trim();
    if (!query) return;
    
    fetch(`/utils/redirect-statistics/search?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            displaySearchResults(data);
        })
        .catch(error => {
            console.error('Search error:', error);
            alert('Ошибка поиска');
        });
}

function displaySearchResults(results) {
    const tbody = document.getElementById('searchResultsBody');
    const container = document.getElementById('searchResults');
    
    tbody.innerHTML = '';
    
    if (results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Результаты не найдены</td></tr>';
    } else {
        results.forEach(result => {
            const row = `
                <tr>
                    <td><small>${result.originalUrl.substring(0, 50)}${result.originalUrl.length > 50 ? '...' : ''}</small></td>
                    <td><span class="badge bg-primary">${result.strategyName}</span></td>
                    <td><span class="badge ${getStatusBadgeClass(result.status)}">${result.status}</span></td>
                    <td>${result.processingTimeMs}ms</td>
                    <td><small>${new Date(result.createdAt).toLocaleString('ru-RU')}</small></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
    
    container.style.display = 'block';
}

function getStatusBadgeClass(status) {
    if (status === 'SUCCESS') return 'bg-success';
    if (status.includes('BLOCKED') || status.includes('403') || status.includes('429')) return 'bg-danger';
    if (status.includes('ERROR') || status.includes('TIMEOUT')) return 'bg-warning';
    return 'bg-secondary';
}

function getRecommendation(domain) {
    fetch(`/utils/redirect-statistics/api/recommend?domain=${encodeURIComponent(domain)}`)
        .then(response => response.json())
        .then(data => {
            const body = document.getElementById('recommendationBody');
            if (data.recommendedStrategy) {
                body.innerHTML = `
                    <div class="text-center">
                        <h6>Домен: <code>${data.domain}</code></h6>
                        <p>Рекомендуемая стратегия:</p>
                        <span class="badge bg-success fs-6">${data.recommendedStrategy}</span>
                    </div>
                `;
            } else {
                body.innerHTML = `
                    <div class="text-center text-muted">
                        <h6>Домен: <code>${data.domain}</code></h6>
                        <p>${data.message || 'Недостаточно данных для рекомендации'}</p>
                    </div>
                `;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('recommendationModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Recommendation error:', error);
            alert('Ошибка получения рекомендации');
        });
}

// Allow search on Enter key
document.getElementById('searchQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchStatistics();
    }
});
</script>
</body>
</html>