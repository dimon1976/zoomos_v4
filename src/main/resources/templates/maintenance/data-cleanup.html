<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Очистка данных - Zoomos v4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .warning-box {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .danger-box {
            background-color: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .success-box {
            background-color: #d1e7dd;
            border: 2px solid #198754;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .preview-card {
            border-left: 4px solid #0d6efd;
            background-color: #f8f9fa;
        }
        .settings-card {
            border-left: 4px solid #6c757d;
        }
        .history-table td {
            vertical-align: middle;
        }
        .status-badge {
            font-size: 0.85rem;
            padding: 0.35em 0.65em;
        }
        .confirmation-input {
            font-family: monospace;
            font-weight: bold;
            letter-spacing: 2px;
        }
        #previewResults {
            display: none;
        }
        .spinner-container {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
<div th:replace="~{layout/main :: header}"></div>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-broom"></i> Очистка устаревших данных</h2>
            <p class="text-muted">Безопасное удаление старых записей из базы данных для оптимизации производительности</p>
            <hr>
        </div>
    </div>

    <!-- Предупреждение о безопасности -->
    <div class="row">
        <div class="col-12">
            <div class="danger-box">
                <h5><i class="fas fa-exclamation-triangle"></i> Важная информация о безопасности</h5>
                <ul class="mb-0">
                    <li><strong>Минимальный срок хранения:</strong> Данные моложе 7 дней не могут быть удалены</li>
                    <li><strong>Необратимая операция:</strong> Удаленные данные невозможно восстановить</li>
                    <li><strong>Рекомендация:</strong> Используйте предпросмотр перед выполнением очистки</li>
                    <li><strong>av_handbook:</strong> Справочные данные полностью исключены из очистки</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Форма очистки -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Параметры очистки</h5>
                </div>
                <div class="card-body">
                    <form id="cleanupForm">
                        <!-- Дата отсечки -->
                        <div class="mb-3">
                            <label for="cutoffDate" class="form-label">
                                <i class="fas fa-calendar"></i> Удалить данные до даты (включительно)
                                <span class="text-danger">*</span>
                            </label>
                            <input type="datetime-local"
                                   class="form-control"
                                   id="cutoffDate"
                                   name="cutoffDate"
                                   th:value="${defaultDate}"
                                   th:max="${minDate}"
                                   required>
                            <div class="form-text">
                                Максимально допустимая дата: <span th:text="${minDate}"></span> (7 дней назад).
                                Данные моложе этой даты защищены от удаления.
                            </div>
                        </div>

                        <!-- Типы данных -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-database"></i> Типы данных для очистки
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="entityTypes"
                                       value="AV_DATA" id="typeAvData" checked>
                                <label class="form-check-label" for="typeAvData">
                                    <strong>AV_DATA</strong> - Сырые данные из импорта (основная таблица)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="entityTypes"
                                       value="IMPORT_SESSIONS" id="typeImportSessions">
                                <label class="form-check-label" for="typeImportSessions">
                                    <strong>IMPORT_SESSIONS</strong> - Сессии импорта и метаданные
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="entityTypes"
                                       value="EXPORT_SESSIONS" id="typeExportSessions">
                                <label class="form-check-label" for="typeExportSessions">
                                    <strong>EXPORT_SESSIONS</strong> - Сессии экспорта (статистика хранится отдельно)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="entityTypes"
                                       value="IMPORT_ERRORS" id="typeImportErrors">
                                <label class="form-check-label" for="typeImportErrors">
                                    <strong>IMPORT_ERRORS</strong> - Ошибки импорта
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="entityTypes"
                                       value="FILE_OPERATIONS" id="typeFileOperations">
                                <label class="form-check-label" for="typeFileOperations">
                                    <strong>FILE_OPERATIONS</strong> - Завершенные файловые операции
                                </label>
                            </div>
                        </div>

                        <!-- Исключения по клиентам -->
                        <div class="mb-3">
                            <label for="excludedClients" class="form-label">
                                <i class="fas fa-shield-alt"></i> Исключить клиентов (опционально)
                            </label>
                            <select class="form-select" id="excludedClients" name="excludedClientIds" multiple size="5">
                                <option th:each="client : ${clients}"
                                        th:value="${client.id}"
                                        th:text="${client.name}"></option>
                            </select>
                            <div class="form-text">
                                Данные выбранных клиентов НЕ будут удалены. Удерживайте Ctrl для выбора нескольких.
                            </div>
                        </div>

                        <!-- Размер порции -->
                        <div class="mb-3">
                            <label for="batchSize" class="form-label">
                                <i class="fas fa-layer-group"></i> Размер порции для batch-удаления
                            </label>
                            <input type="number" class="form-control" id="batchSize" name="batchSize"
                                   value="10000" min="1000" max="50000" step="1000">
                            <div class="form-text">
                                Рекомендуется 10000 для баланса скорости и безопасности
                            </div>
                        </div>

                        <!-- Кнопки действий -->
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-info btn-lg" id="previewBtn">
                                <i class="fas fa-eye"></i> Предпросмотр (без удаления)
                            </button>
                            <button type="button" class="btn btn-danger btn-lg" id="executeBtn" disabled>
                                <i class="fas fa-trash-alt"></i> Выполнить очистку
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Настройки хранения -->
        <div class="col-lg-4">
            <div class="card settings-card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-cog"></i> Настройки хранения</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Тип данных</th>
                                    <th class="text-end">Дней</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="setting : ${settings}">
                                    <td>
                                        <small th:text="${setting.entityType}"></small>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-info" th:text="${setting.retentionDays}"></span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="form-text">
                        Настройки хранения определяют рекомендуемый срок хранения для каждого типа данных
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Спиннер загрузки -->
    <div class="spinner-container" id="loadingSpinner">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-2">Обработка запроса...</p>
    </div>

    <!-- Результаты предпросмотра -->
    <div class="row" id="previewResults">
        <div class="col-12">
            <div class="card preview-card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-search"></i> Результаты предпросмотра</h5>
                </div>
                <div class="card-body">
                    <div id="previewContent"></div>

                    <!-- Форма подтверждения -->
                    <div class="mt-4 p-3 border border-danger rounded" id="confirmationBox" style="display: none;">
                        <h6 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Подтверждение удаления</h6>
                        <p>Для подтверждения удаления введите слово <strong>CONFIRM</strong> в поле ниже:</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control confirmation-input" id="confirmationInput"
                                   placeholder="Введите CONFIRM" maxlength="7">
                            <button class="btn btn-danger" type="button" id="confirmExecuteBtn" disabled>
                                <i class="fas fa-check"></i> Подтвердить и выполнить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- История очисток -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> История очисток</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover history-table">
                            <thead>
                                <tr>
                                    <th>Дата очистки</th>
                                    <th>Тип данных</th>
                                    <th>Дата отсечки</th>
                                    <th class="text-end">Удалено записей</th>
                                    <th class="text-end">Время (мс)</th>
                                    <th>Статус</th>
                                    <th>Инициатор</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:if="${#lists.isEmpty(history)}">
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> История очисток пуста
                                    </td>
                                </tr>
                                <tr th:each="record : ${history}">
                                    <td>
                                        <small th:text="${#temporals.format(record.cleanupDate, 'dd.MM.yyyy HH:mm')}"></small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary" th:text="${record.entityType}"></span>
                                    </td>
                                    <td>
                                        <small th:text="${#temporals.format(record.cutoffDate, 'dd.MM.yyyy HH:mm')}"></small>
                                    </td>
                                    <td class="text-end">
                                        <strong th:text="${#numbers.formatInteger(record.recordsDeleted, 0, 'DEFAULT')}"></strong>
                                    </td>
                                    <td class="text-end">
                                        <small th:text="${record.executionTimeMs != null ? record.executionTimeMs : '-'}"></small>
                                    </td>
                                    <td>
                                        <span class="badge status-badge"
                                              th:classappend="${record.status == 'SUCCESS' ? 'bg-success' : (record.status == 'FAILED' ? 'bg-danger' : 'bg-warning')}"
                                              th:text="${record.status}"></span>
                                    </td>
                                    <td>
                                        <small th:text="${record.initiatedBy ?: 'system'}"></small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('cleanupForm');
    const previewBtn = document.getElementById('previewBtn');
    const executeBtn = document.getElementById('executeBtn');
    const confirmExecuteBtn = document.getElementById('confirmExecuteBtn');
    const confirmationInput = document.getElementById('confirmationInput');
    const previewResults = document.getElementById('previewResults');
    const previewContent = document.getElementById('previewContent');
    const confirmationBox = document.getElementById('confirmationBox');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Валидация поля подтверждения
    confirmationInput.addEventListener('input', function() {
        confirmExecuteBtn.disabled = this.value !== 'CONFIRM';
    });

    // Предпросмотр
    previewBtn.addEventListener('click', async function() {
        const formData = new FormData(form);
        const params = new URLSearchParams();

        params.append('cutoffDate', formData.get('cutoffDate'));
        params.append('batchSize', formData.get('batchSize'));

        // Собираем выбранные типы данных
        const entityTypes = formData.getAll('entityTypes');
        entityTypes.forEach(type => params.append('entityTypes', type));

        // Собираем исключенных клиентов
        const excludedClients = Array.from(document.getElementById('excludedClients').selectedOptions)
            .map(opt => opt.value);
        excludedClients.forEach(id => params.append('excludedClientIds', id));

        try {
            loadingSpinner.style.display = 'block';
            previewResults.style.display = 'none';

            const response = await fetch('/maintenance/data-cleanup/preview?' + params.toString(), {
                method: 'POST'
            });

            const data = await response.json();
            loadingSpinner.style.display = 'none';

            displayPreview(data);
            previewResults.style.display = 'block';
            executeBtn.disabled = false;

            // Прокрутка к результатам
            previewResults.scrollIntoView({ behavior: 'smooth', block: 'start' });

        } catch (error) {
            loadingSpinner.style.display = 'none';
            alert('Ошибка при предпросмотре: ' + error.message);
        }
    });

    // Показать форму подтверждения
    executeBtn.addEventListener('click', function() {
        confirmationBox.style.display = 'block';
        confirmationInput.value = '';
        confirmationInput.focus();
        confirmExecuteBtn.disabled = true;
    });

    // Выполнение очистки с подтверждением
    confirmExecuteBtn.addEventListener('click', async function() {
        if (confirmationInput.value !== 'CONFIRM') {
            alert('Необходимо ввести CONFIRM для подтверждения');
            return;
        }

        if (!confirm('Вы уверены? Это действие необратимо!')) {
            return;
        }

        const formData = new FormData(form);
        const params = new URLSearchParams();

        params.append('cutoffDate', formData.get('cutoffDate'));
        params.append('batchSize', formData.get('batchSize'));
        params.append('confirmation', 'CONFIRM');

        const entityTypes = formData.getAll('entityTypes');
        entityTypes.forEach(type => params.append('entityTypes', type));

        const excludedClients = Array.from(document.getElementById('excludedClients').selectedOptions)
            .map(opt => opt.value);
        excludedClients.forEach(id => params.append('excludedClientIds', id));

        try {
            loadingSpinner.style.display = 'block';
            confirmExecuteBtn.disabled = true;

            const response = await fetch('/maintenance/data-cleanup/execute?' + params.toString(), {
                method: 'POST'
            });

            const data = await response.json();
            loadingSpinner.style.display = 'none';

            displayResult(data);

            if (data.success) {
                // Обновляем историю
                setTimeout(() => window.location.reload(), 3000);
            }

        } catch (error) {
            loadingSpinner.style.display = 'none';
            alert('Ошибка при выполнении очистки: ' + error.message);
        }
    });

    // Отображение предпросмотра
    function displayPreview(data) {
        let html = '<h6>Будет удалено записей:</h6>';
        html += '<div class="table-responsive"><table class="table table-bordered">';
        html += '<thead><tr><th>Тип данных</th><th class="text-end">Количество записей</th></tr></thead><tbody>';

        let total = 0;
        for (const [type, count] of Object.entries(data.recordsToDelete || {})) {
            html += `<tr><td><strong>${type}</strong></td><td class="text-end">${count.toLocaleString()}</td></tr>`;
            total += count;
        }

        html += `<tr class="table-info"><td><strong>ИТОГО</strong></td><td class="text-end"><strong>${total.toLocaleString()}</strong></td></tr>`;
        html += '</tbody></table></div>';

        html += `<p><strong>Примерная оценка освобождаемого места:</strong> ${data.formattedEstimatedSpace || '0 B'}</p>`;

        // Предупреждения
        if (data.warnings && data.warnings.length > 0) {
            html += '<div class="alert alert-warning mt-3"><h6>Предупреждения:</h6><ul class="mb-0">';
            data.warnings.forEach(warning => {
                html += `<li>${warning}</li>`;
            });
            html += '</ul></div>';
        }

        previewContent.innerHTML = html;
    }

    // Отображение результата
    function displayResult(data) {
        let html = '';

        if (data.success) {
            html += '<div class="alert alert-success"><h5><i class="fas fa-check-circle"></i> Очистка выполнена успешно!</h5>';
            html += `<p><strong>Удалено записей:</strong> ${data.totalRecordsDeleted.toLocaleString()}</p>`;
            html += `<p><strong>Освобождено места:</strong> ${data.formattedFreedSpace}</p>`;
            html += `<p><strong>Время выполнения:</strong> ${data.executionTimeMs} мс</p>`;

            if (data.deletedRecordsByType) {
                html += '<h6>Детализация по типам:</h6><ul>';
                for (const [type, count] of Object.entries(data.deletedRecordsByType)) {
                    html += `<li><strong>${type}:</strong> ${count.toLocaleString()} записей</li>`;
                }
                html += '</ul>';
            }
            html += '</div>';
        } else {
            html += '<div class="alert alert-danger"><h5><i class="fas fa-times-circle"></i> Ошибка при очистке</h5>';
            html += `<p>${data.errorMessage || 'Неизвестная ошибка'}</p></div>`;
        }

        previewContent.innerHTML = html;
        confirmationBox.style.display = 'none';
    }
});
</script>
</body>
</html>
