# Data Merger Utility - Идея утилиты объединения данных товаров

## Концепция

Утилита для объединения данных из двух источников:
1. **Исходный файл** - товары-оригиналы с их аналогами и коэффициентами
2. **Файл ссылок** - модели аналогов со ссылками на карточки товаров

**Результат**: Развернутый файл где каждая строка содержит полную связку оригинал→аналог→коэффициент→ссылка

## Структуры данных

### DTO исходного файла
```java
class SourceProductDto {
    String id;                              // Уникальный ID товара-оригинала
    String originalModel;                   // Название модели оригинала
    List<AnalogWithCoefficient> analogs;    // Список аналогов с коэффициентами
}

class AnalogWithCoefficient {
    String analogModel;     // Модель аналога (ключ для поиска ссылок)
    Double coefficient;     // Коэффициент для этого конкретного аналога
}
```

### DTO файла ссылок
```java
class ProductLinksDto {
    String analogModel;     // Модель аналога (ключ)
    List<String> links;     // Список ссылок на карточки товара
}
```

### DTO объединенного результата
```java
class MergedProductDto {
    String id;              // ID товара-оригинала
    String originalModel;   // Модель оригинала
    String analogModel;     // Модель аналога
    Double coefficient;     // Коэффициент аналога
    String link;            // Ссылка на карточку товара
}
```

## Пример входных и выходных данных

### Исходный файл (товары-оригиналы с аналогами)
```
ID          | Модель оригинал | Модель аналог | Коэффициент
1001        | Оригинал А      | Аналог1       | 1.2
1001        | Оригинал А      | Аналог2       | 0.8
1001        | Оригинал А      | Аналог3       | 1.0
1002        | Оригинал Б      | Аналог1       | 0.9
1002        | Оригинал Б      | Аналог4       | 1.1
```

### Файл ссылок (аналоги со ссылками)
```
Модель аналог | Ссылка на карточку товара
Аналог1       | https://site1.com/product/analog1
Аналог1       | https://site2.com/item/analog1
Аналог1       | https://site3.com/catalog/analog1
Аналог2       | https://site1.com/product/analog2
Аналог2       | https://site2.com/item/analog2
Аналог3       | https://site1.com/product/analog3
Аналог3       | https://site3.com/catalog/analog3
Аналог3       | https://site4.com/shop/analog3
Аналог4       | https://site2.com/item/analog4
```

### Результат объединения
```
ID   | Товар оригинал | Коэффициент | Модель аналог | Ссылка на карточку товара
1001 | Оригинал А     | 1.2         | Аналог1       | https://site1.com/product/analog1
1001 | Оригинал А     | 1.2         | Аналог1       | https://site2.com/item/analog1
1001 | Оригинал А     | 1.2         | Аналог1       | https://site3.com/catalog/analog1
1001 | Оригинал А     | 0.8         | Аналог2       | https://site1.com/product/analog2
1001 | Оригинал А     | 0.8         | Аналог2       | https://site2.com/item/analog2
1001 | Оригинал А     | 1.0         | Аналог3       | https://site1.com/product/analog3
1001 | Оригинал А     | 1.0         | Аналог3       | https://site3.com/catalog/analog3
1001 | Оригинал А     | 1.0         | Аналог3       | https://site4.com/shop/analog3
1002 | Оригинал Б     | 0.9         | Аналог1       | https://site1.com/product/analog1
1002 | Оригинал Б     | 0.9         | Аналог1       | https://site2.com/item/analog1
1002 | Оригинал Б     | 0.9         | Аналог1       | https://site3.com/catalog/analog1
1002 | Оригинал Б     | 1.1         | Аналог4       | https://site2.com/item/analog4
```

## Алгоритм обработки

1. **Парсинг исходного файла**
   - Загрузка и валидация CSV/Excel файла
   - Группировка аналогов по ID товара-оригинала
   - Создание структуры SourceProductDto

2. **Парсинг файла ссылок**
   - Загрузка и валидация CSV/Excel файла
   - Группировка ссылок по модели аналога
   - Создание структуры ProductLinksDto

3. **Сопоставление и объединение данных**
   - Для каждого товара-оригинала:
     - Перебор всех его аналогов
     - Поиск ссылок по ключу `analogModel`
     - Создание записей для каждой комбинации (оригинал + аналог + коэффициент + ссылка)

4. **Формирование результата**
   - Создание развернутого массива MergedProductDto
   - Экспорт в выбранном формате (CSV/Excel)

## Требования к интерфейсу

### Форма загрузки `/utils/data-merger`
- **Поле 1**: Исходный файл (товары-оригиналы с аналогами)
  - Tooltip: "CSV/Excel файл с товарами-оригиналами и их аналогами с коэффициентами"

- **Поле 2**: Файл ссылок (аналоги со ссылками)
  - Tooltip: "CSV/Excel файл с моделями аналогов и ссылками на карточки товаров"

- **Кнопка**: "Обработать и объединить данные"
  - Действие: парсинг файлов → объединение данных → экспорт результата

### Сопоставление столбцов
- Динамическая форма для указания соответствия столбцов
- Предварительный просмотр первых строк каждого файла
- Валидация обязательных полей

## Техническая реализация

### Интеграция с Zoomos v4
- **Контроллер**: `DataMergerController` в пакете `controller.utils`
- **Сервис**: `DataMergerService` в пакете `service.utils`
- **DTO**: Создание в пакете `dto.utils`

### Использование существующих компонентов
- `FileAnalyzerService` - анализ структуры файлов
- `FileGeneratorService` - экспорт результата
- `AsyncImportService` - асинхронная обработка больших файлов
- WebSocket - прогресс обработки для пользователя

### Обработка ошибок
- Валидация структуры файлов
- Проверка наличия обязательных столбцов
- Обработка несоответствий в данных
- Отчеты о пропущенных аналогах (не найдены ссылки)

## Примеры использования

### Сценарий 1: Автозапчасти
- **Исходный файл**: оригинальные артикулы с совместимыми аналогами
- **Файл ссылок**: аналоги с ссылками на интернет-магазины
- **Результат**: полный каталог для прайс-листов

### Сценарий 2: Электроника
- **Исходный файл**: оригинальные компоненты с заменителями
- **Файл ссылок**: заменители с ссылками на технические характеристики
- **Результат**: справочник совместимости

## Дополнительные возможности

### Фильтрация и настройки
- Исключение аналогов без ссылок
- Ограничение количества ссылок на аналог
- Фильтрация по коэффициенту (например, только >= 1.0)

### Статистика обработки
- Количество обработанных товаров-оригиналов
- Количество найденных соответствий
- Список аналогов без ссылок
- Общее количество сформированных записей

---

**Дата создания**: 2025-09-20
**Статус**: Концепция для разработки
**Приоритет**: Средний
**Сложность**: Средняя (использует существующую архитектуру)