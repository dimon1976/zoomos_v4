# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É VACUUM –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ VACUUM –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ —É—Ç–∏–ª–∏—Ç—É –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö (`DataCleanupService`) –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ PostgreSQL –ø–æ—Å–ª–µ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π.

## –ó–∞—á–µ–º –Ω—É–∂–µ–Ω VACUUM –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏?

### –ü—Ä–æ–±–ª–µ–º–∞: Index Bloat (—Ä–∞–∑–¥—É–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤)

–ö–æ–≥–¥–∞ –≤—ã —É–¥–∞–ª—è–µ—Ç–µ –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ `DELETE FROM`:

1. **–°—Ç—Ä–æ–∫–∏ –ù–ï —É–¥–∞–ª—è—é—Ç—Å—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏** - –æ–Ω–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ "dead tuples" (–º–µ—Ä—Ç–≤—ã–µ –∫–æ—Ä—Ç–µ–∂–∏)
2. **–ò–Ω–¥–µ–∫—Å—ã —Å–æ–¥–µ—Ä–∂–∞—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ dead tuples** - —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ä–∞–∑–¥—É–≤–∞–Ω–∏—é (bloat)
3. **–ó–∞–ø—Ä–æ—Å—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–µ–µ** –Ω–∞ 10-30% –∏–∑-–∑–∞ –ª–∏—à–Ω–∏—Ö —É–∑–ª–æ–≤ –≤ B-tree –∏–Ω–¥–µ–∫—Å–∞—Ö
4. **–ú–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è** - –æ—Å—Ç–∞—é—Ç—Å—è "–¥—ã—Ä–∫–∏" –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö

### –†–µ—à–µ–Ω–∏–µ: VACUUM ANALYZE

- **VACUUM** - –ø–æ–º–µ—á–∞–µ—Ç dead tuples –∫–∞–∫ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **ANALYZE** - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–∞–±–ª–∏—Ü –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É** - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- **–£–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 20-40% –ø–æ—Å–ª–µ –±–æ–ª—å—à–∏—Ö –æ—á–∏—Å—Ç–æ–∫

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –§–∞–π–ª: `application.properties`

```properties
# Auto-VACUUM –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
database.cleanup.auto-vacuum.enabled=true                    # –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å auto-vacuum
database.cleanup.auto-vacuum.threshold-records=1000000       # –ü–æ—Ä–æ–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (1 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π)
database.cleanup.auto-vacuum.run-async=true                  # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------------------|----------|
| `enabled` | `true` | –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π VACUUM –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ |
| `threshold-records` | `1000000` | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∑–∞–ø—É—Å–∫–∞ VACUUM |
| `run-async` | `true` | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ |

## –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

### 1. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```properties
database.cleanup.auto-vacuum.run-async=true
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚úÖ VACUUM –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ `CompletableFuture`
- ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–∏—Å—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö

**–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- –ü—Ä–æ–¥–∞–∫—à–µ–Ω —Å—Ä–µ–¥—ã
- –ë–æ–ª—å—à–∏–µ —Ç–∞–±–ª–∏—Ü—ã (> 10M —Å—Ç—Ä–æ–∫)
- –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–õ–æ–≥–∏:**
```
INFO: –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: —É–¥–∞–ª–µ–Ω–æ 5000000 –∑–∞–ø–∏—Å–µ–π –∑–∞ 120000 –º—Å
INFO: –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ VACUUM ANALYZE –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è 5000000 –∑–∞–ø–∏—Å–µ–π
INFO: VACUUM ANALYZE –∑–∞–ø—É—â–µ–Ω –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
INFO: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ VACUUM ANALYZE –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã: av_data
INFO: VACUUM ANALYZE –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è av_data: 12500 –º—Å
INFO: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π VACUUM ANALYZE –∑–∞–≤–µ—Ä—à–µ–Ω: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ 1 —Ç–∞–±–ª–∏—Ü –∑–∞ 12 —Å–µ–∫
```

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º

```properties
database.cleanup.auto-vacuum.run-async=false
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚è≥ VACUUM –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—á–∏—Å—Ç–∫–∏
- ‚è≥ –ó–∞–Ω–∏–º–∞–µ—Ç ~10-30 –º–∏–Ω—É—Ç –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ VACUUM –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥–µ—Ç –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- –ü–ª–∞–Ω–æ–≤–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –≤ –Ω–æ—á–Ω–æ–µ –≤—Ä–µ–º—è
- –ù–µ–±–æ–ª—å—à–∏–µ —Ç–∞–±–ª–∏—Ü—ã (< 1M —Å—Ç—Ä–æ–∫)
- –ö–æ–≥–¥–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è VACUUM

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ú–∞–ª—ã–µ –æ—á–∏—Å—Ç–∫–∏ (< 1 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π)

**–ü—Ä–∏–º–µ—Ä:** –£–¥–∞–ª–µ–Ω–∏–µ 500 —Ç—ã—Å—è—á —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π

```
–£–¥–∞–ª–µ–Ω–æ: 500,000 –∑–∞–ø–∏—Å–µ–π
–†–µ–∑—É–ª—å—Ç–∞—Ç: VACUUM –ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ü–æ—Ä–æ–≥ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç (`threshold-records=1000000`)
- PostgreSQL AutoVacuum —Å–ø—Ä–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°—Ä–µ–¥–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ (1-10 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π)

**–ü—Ä–∏–º–µ—Ä:** –£–¥–∞–ª–µ–Ω–∏–µ 5 –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∑–∞–ø–∏—Å–µ–π –∏–∑ av_data

```
–£–¥–∞–ª–µ–Ω–æ: 5,000,000 –∑–∞–ø–∏—Å–µ–π
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π VACUUM ANALYZE
–í—Ä–µ–º—è: ~15-20 –º–∏–Ω—É—Ç (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
–¢–∞–±–ª–∏—Ü—ã: av_data
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
- ‚úÖ Dead tuples –æ—á–∏—â–µ–Ω—ã
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
- ‚ö†Ô∏è –ò–Ω–¥–µ–∫—Å—ã –æ—Å—Ç–∞—é—Ç—Å—è —Å–ª–µ–≥–∫–∞ —Ä–∞–∑–¥—É—Ç—ã–º–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è REINDEX —Ä–∞–∑ –≤ –º–µ—Å—è—Ü)

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ë–æ–ª—å—à–∏–µ –æ—á–∏—Å—Ç–∫–∏ (> 10 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π)

**–ü—Ä–∏–º–µ—Ä:** –£–¥–∞–ª–µ–Ω–∏–µ 20 –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∑–∞–ø–∏—Å–µ–π –∏–∑ av_data + import_sessions

```
–£–¥–∞–ª–µ–Ω–æ: 20,000,000 –∑–∞–ø–∏—Å–µ–π
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π VACUUM ANALYZE
–í—Ä–µ–º—è: ~30-40 –º–∏–Ω—É—Ç (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
–¢–∞–±–ª–∏—Ü—ã: av_data, import_sessions
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:**
1. ‚úÖ VACUUM ANALYZE –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. üîß –ó–∞–ø—É—Å—Ç–∏—Ç—å REINDEX —á–µ—Ä–µ–∑ UI `/maintenance/database` –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ
3. üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å bloat —á–µ—Ä–µ–∑ "–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–¥—É–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü"

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ UI

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—á–∏—Å—Ç–∫–∏: `/maintenance/database`

**–®–∞–≥ 1: –í—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –æ—á–∏—Å—Ç–∫–∏**
- –î–∞—Ç–∞ –æ—Ç—Å–µ—á–∫–∏ (cutoff date)
- –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (AV_DATA, IMPORT_SESSIONS, –∏ —Ç.–¥.)
- –ö–ª–∏–µ–Ω—Ç—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è

**–®–∞–≥ 2: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä**
- –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ

**–®–∞–≥ 3: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏**
- –ù–∞–∂–º–∏—Ç–µ "–£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"
- –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ
- –î–æ–∂–¥–∏—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (VACUUM –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ñ–æ–Ω–µ)

**–®–∞–≥ 4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ VACUUM
- –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `data_cleanup_history`

## –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –í—Ä–µ–º—è VACUUM ANALYZE

–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π:

| –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã | –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π | –í—Ä–µ–º—è VACUUM | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|----------------|----------------|--------------|--------------|
| 1M —Å—Ç—Ä–æ–∫ | 100K-500K | 30 —Å–µ–∫ - 2 –º–∏–Ω | Async OK |
| 10M —Å—Ç—Ä–æ–∫ | 1M-5M | 5-10 –º–∏–Ω—É—Ç | Async OK |
| 50M —Å—Ç—Ä–æ–∫ | 5M-10M | 15-25 –º–∏–Ω—É—Ç | Async —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| 100M —Å—Ç—Ä–æ–∫ | 10M-20M | 30-60 –º–∏–Ω—É—Ç | Async –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω |

### –í—Ä–µ–º—è REINDEX (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è bloat > 30%)

| –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–¥–µ–∫—Å–æ–≤ | –í—Ä–µ–º—è REINDEX CONCURRENTLY |
|----------------|--------------------|-----------------------------|
| 10M —Å—Ç—Ä–æ–∫ | 3 –∏–Ω–¥–µ–∫—Å–∞ | 15-30 –º–∏–Ω—É—Ç |
| 50M —Å—Ç—Ä–æ–∫ | 3 –∏–Ω–¥–µ–∫—Å–∞ | 45-90 –º–∏–Ω—É—Ç |
| 100M —Å—Ç—Ä–æ–∫ | 3 –∏–Ω–¥–µ–∫—Å–∞ | 90-180 –º–∏–Ω—É—Ç |

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω (–±–æ–ª—å—à–∏–µ –±–∞–∑—ã > 50M —Å—Ç—Ä–æ–∫)

```properties
# –ü—Ä–æ–¥–∞–∫—à–µ–Ω - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º
database.cleanup.auto-vacuum.enabled=true
database.cleanup.auto-vacuum.threshold-records=1000000
database.cleanup.auto-vacuum.run-async=true
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏

### Staging/Dev (—Å—Ä–µ–¥–Ω–∏–µ –±–∞–∑—ã 10-50M —Å—Ç—Ä–æ–∫)

```properties
# Staging - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º —Å –Ω–∏–∑–∫–∏–º –ø–æ—Ä–æ–≥–æ–º
database.cleanup.auto-vacuum.enabled=true
database.cleanup.auto-vacuum.threshold-records=500000
database.cleanup.auto-vacuum.run-async=true
```

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–º–∞–ª—ã–µ –±–∞–∑—ã < 10M —Å—Ç—Ä–æ–∫)

```properties
# Dev - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω
database.cleanup.auto-vacuum.enabled=false
database.cleanup.auto-vacuum.threshold-records=1000000
database.cleanup.auto-vacuum.run-async=false
```

**–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è:**
- –ú–∞–ª—ã–π –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö
- AutoVacuum PostgreSQL —Å–ø—Ä–∞–≤–∏—Ç—Å—è —Å–∞–º
- –≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ VACUUM

**1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–∞–±–ª–∏—Ü:**

```sql
SELECT
    schemaname,
    relname,
    n_live_tup AS live_tuples,
    n_dead_tup AS dead_tuples,
    round(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_pct,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY n_dead_tup DESC;
```

**–•–æ—Ä–æ—à–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:**
- `dead_pct < 10%` - —Ç–∞–±–ª–∏—Ü–∞ –≤ –æ—Ç–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- `last_vacuum` - –Ω–µ–¥–∞–≤–Ω—è—è –¥–∞—Ç–∞

**2. –ü—Ä–æ–≤–µ—Ä–∫–∞ bloat (—Ä–∞–∑–¥—É–≤–∞–Ω–∏—è):**

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ UI `/maintenance/database` ‚Üí —Ä–∞–∑–¥–µ–ª "–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–¥—É–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü"

**–ö—Ä–∏—Ç–µ—Ä–∏–∏:**
- `bloat < 20%` - –Ω–æ—Ä–º–∞
- `bloat 20-30%` - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- `bloat > 30%` - —Ç—Ä–µ–±—É–µ—Ç—Å—è REINDEX

### –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:**
```
[DataCleanupService] –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: —É–¥–∞–ª–µ–Ω–æ 5000000 –∑–∞–ø–∏—Å–µ–π –∑–∞ 120000 –º—Å
[DataCleanupService] –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ VACUUM ANALYZE –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è 5000000 –∑–∞–ø–∏—Å–µ–π
[DataCleanupService] VACUUM ANALYZE –∑–∞–ø—É—â–µ–Ω –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
[DataCleanupService] –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ VACUUM ANALYZE –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã: av_data
[DataCleanupService] VACUUM ANALYZE –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è av_data: 12500 –º—Å
[DataCleanupService] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π VACUUM ANALYZE –∑–∞–≤–µ—Ä—à–µ–Ω: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ 1 —Ç–∞–±–ª–∏—Ü –∑–∞ 12 —Å–µ–∫
```

**–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
```
[DataCleanupService] –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å VACUUM ANALYZE –¥–ª—è av_data: connection timeout
[DataCleanupService] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ VACUUM ANALYZE
```

### –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—Å—Ç–∫–∏

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `data_cleanup_history`:

```sql
SELECT
    id,
    entity_type,
    cleanup_date,
    cutoff_date,
    records_deleted,
    execution_time_ms / 1000.0 AS execution_time_sec,
    status,
    initiated_by
FROM data_cleanup_history
ORDER BY cleanup_date DESC
LIMIT 10;
```

## REINDEX –ø–æ—Å–ª–µ –±–æ–ª—å—à–∏—Ö –æ—á–∏—Å—Ç–æ–∫

### –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω REINDEX?

**–ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ > 10 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π (> 20% –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã):**

1. ‚úÖ VACUUM ANALYZE –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. ‚ö†Ô∏è –ò–Ω–¥–µ–∫—Å—ã –æ—Å—Ç–∞—é—Ç—Å—è —Ä–∞–∑–¥—É—Ç—ã–º–∏ –Ω–∞ 15-25%
3. üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è REINDEX CONCURRENTLY —Ä–∞–∑ –≤ –º–µ—Å—è—Ü

### –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å REINDEX?

**–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ UI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

1. –û—Ç–∫—Ä–æ–π—Ç–µ `/maintenance/database`
2. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –¥–æ —Ä–∞–∑–¥–µ–ª–∞ "–ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è"
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "REINDEX –≤—Å–µ—Ö –∏–Ω–¥–µ–∫—Å–æ–≤"
4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ
5. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (~45-90 –º–∏–Ω—É—Ç –¥–ª—è av_data —Å 50M —Å—Ç—Ä–æ–∫)

**–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ psql (–¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö)**

```sql
-- REINDEX CONCURRENTLY –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É
REINDEX INDEX CONCURRENTLY idx_av_data_client_created;
REINDEX INDEX CONCURRENTLY idx_av_data_operation_created;
REINDEX INDEX CONCURRENTLY idx_av_data_created_at_brin;
```

**–°–ø–æ—Å–æ–± 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫)**

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫:

```properties
# –ï–∂–µ–º–µ—Å—è—á–Ω–æ–µ –ø–æ–ª–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —Å REINDEX
maintenance.scheduler.full-maintenance.cron=0 0 4 1 * *
maintenance.scheduler.enabled=true
```

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≥—Ä–∞—Ñ–∏–∫ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

```properties
maintenance.scheduler.database-cleanup.cron=0 0 3 * * SUN
```

- ‚úÖ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π VACUUM ANALYZE (–µ—Å–ª–∏ > 1M –∑–∞–ø–∏—Å–µ–π)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã

### –ï–∂–µ–º–µ—Å—è—á–Ω–æ (—Ä—É—á–Ω–æ–µ –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ)

- üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ bloat —á–µ—Ä–µ–∑ UI
- üîß REINDEX –ø—Ä–∏ bloat > 30%
- üìä –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ë–î

### –†–∞–∑ –≤ –∫–≤–∞—Ä—Ç–∞–ª

- üîç –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ (–Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã)
- üîç –ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- üîç –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ capacity (—Ä–æ—Å—Ç –¥–∞–Ω–Ω—ã—Ö)

## –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã (FAQ)

### 1. –ë—É–¥–µ—Ç –ª–∏ VACUUM –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?

**–ù–µ—Ç!** `VACUUM ANALYZE` –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É:
- ‚úÖ –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚úÖ –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚ö†Ô∏è –¢–æ–ª—å–∫–æ `VACUUM FULL` –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É (–º—ã –µ–≥–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º)

### 2. –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å auto-vacuum?

**–î–∞**, –µ—Å–ª–∏ –≤–∞—à–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–±–æ–ª—å—à–∞—è (< 10M —Å—Ç—Ä–æ–∫):

```properties
database.cleanup.auto-vacuum.enabled=false
```

PostgreSQL AutoVacuum —Å–ø—Ä–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

### 3. –°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ –æ—Å–≤–æ–±–æ–¥–∏—Ç VACUUM?

**VACUUM –ù–ï –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ!**
- ‚ùå –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º
- ‚úÖ Dead tuples –ø–æ–º–µ—á–∞—é—Ç—Å—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –ù–æ–≤—ã–µ INSERT –∑–∞–π–º—É—Ç –º–µ—Å—Ç–æ dead tuples

**–î–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –Ω—É–∂–µ–Ω:**
- `VACUUM FULL` (–±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É, 30-60 –º–∏–Ω—É—Ç)
- –ò–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç ‚Üí —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã ‚Üí –∏–º–ø–æ—Ä—Ç (downtime)

### 4. –ö–∞–∫ —á–∞—Å—Ç–æ –Ω—É–∂–µ–Ω REINDEX?

**–ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏–π:**
- –ú–∞–ª—ã–µ –æ—á–∏—Å—Ç–∫–∏ (< 5% –¥–∞–Ω–Ω—ã—Ö) ‚Üí REINDEX —Ä–∞–∑ –≤ 3-6 –º–µ—Å—è—Ü–µ–≤
- –°—Ä–µ–¥–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ (5-20% –¥–∞–Ω–Ω—ã—Ö) ‚Üí REINDEX —Ä–∞–∑ –≤ 1-2 –º–µ—Å—è—Ü–∞
- –ë–æ–ª—å—à–∏–µ –æ—á–∏—Å—Ç–∫–∏ (> 20% –¥–∞–Ω–Ω—ã—Ö) ‚Üí REINDEX –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü

**–û—Ä–∏–µ–Ω—Ç–∏—Ä:** –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ bloat —á–µ—Ä–µ–∑ UI, –ø—Ä–∏ > 30% –¥–µ–ª–∞–π—Ç–µ REINDEX.

### 5. –ü–æ—á–µ–º—É VACUUM –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ > 1M –∑–∞–ø–∏—Å–µ–π?

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:**
- VACUUM –∑–∞–Ω–∏–º–∞–µ—Ç 10-30 –º–∏–Ω—É—Ç –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü
- –î–ª—è –º–∞–ª—ã—Ö –æ—á–∏—Å—Ç–æ–∫ (< 1M) AutoVacuum PostgreSQL —Å–ø—Ä–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ü–æ—Ä–æ–≥ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ `threshold-records`

### 6. –ß—Ç–æ –µ—Å–ª–∏ VACUUM –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π?

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
```
[DataCleanupService] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ VACUUM ANALYZE
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤** ‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î
2. **Timeout –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** ‚Üí –£–≤–µ–ª–∏—á—å—Ç–µ `spring.datasource.hikari.connection-timeout`
3. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã** ‚Üí –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. **–ù–µ—Ö–≤–∞—Ç–∫–∞ –º–µ—Å—Ç–∞** ‚Üí –û—Å–≤–æ–±–æ–¥–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ (PostgreSQL —Ç—Ä–µ–±—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ)

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ VACUUM –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ UI `/maintenance/database`

## Troubleshooting (–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º)

### –ü—Ä–æ–±–ª–µ–º–∞ 1: VACUUM –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
- –£–¥–∞–ª–µ–Ω–æ > 1M –∑–∞–ø–∏—Å–µ–π
- –í –ª–æ–≥–∞—Ö –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ VACUUM

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
```properties
database.cleanup.auto-vacuum.enabled=true  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å true
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä–æ–≥:
```properties
database.cleanup.auto-vacuum.threshold-records=1000000  # –£–¥–∞–ª–µ–Ω–æ –±–æ–ª—å—à–µ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è?
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –æ—á–∏—Å—Ç–∫–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å SUCCESS):
```sql
SELECT * FROM data_cleanup_history ORDER BY cleanup_date DESC LIMIT 1;
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: VACUUM —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ

**–°–∏–º–ø—Ç–æ–º—ã:**
- VACUUM –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è > 60 –º–∏–Ω—É—Ç
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–æ—Ä–º–æ–∑–∏—Ç

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã:
```sql
SELECT pg_size_pretty(pg_total_relation_size('av_data'));
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ dead tuples:
```sql
SELECT n_dead_tup FROM pg_stat_user_tables WHERE relname = 'av_data';
```

3. **–ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –æ–≥—Ä–æ–º–Ω–∞—è (> 100M —Å—Ç—Ä–æ–∫):**
   - –£–≤–µ–ª–∏—á—å—Ç–µ `maintenance_work_mem` –≤ PostgreSQL
   - –ò–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ü–æ—Å–ª–µ VACUUM –∑–∞–ø—Ä–æ—Å—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –º–µ–¥–ª–µ–Ω–Ω—ã–µ

**–ü—Ä–∏—á–∏–Ω–∞:** Index bloat > 30%

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ bloat —á–µ—Ä–µ–∑ UI `/maintenance/database`
2. –ï—Å–ª–∏ bloat > 30% ‚Üí –ó–∞–ø—É—Å—Ç–∏—Ç–µ REINDEX
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
```sql
ANALYZE av_data;
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –§–∞–π–ª—ã –∏ –∫–ª–∞—Å—Å—ã

**1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- `application.properties` - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã auto-vacuum

**2. –°–µ—Ä–≤–∏—Å—ã:**
- `DataCleanupService.java:155-157` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ executeCleanup()
- `DataCleanupService.java:599-677` - –º–µ—Ç–æ–¥—ã VACUUM

**3. –ú–µ—Ç–æ–¥—ã:**
- `performAutoVacuum()` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ async/sync
- `executeVacuumAnalyze()` - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ VACUUM –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
- `getTableNameForEntityType()` - –º–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–∞ –Ω–∞ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã

### –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ—á–∏—Å—Ç–∫—É —á–µ—Ä–µ–∑ UI
   ‚Üì
2. DataCleanupService.executeCleanup() —É–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏
   ‚Üì
3. –ü—Ä–æ–≤–µ—Ä–∫–∞: deletedRecords >= threshold?
   ‚Üì –î–∞
4. performAutoVacuum() ‚Üí –∑–∞–ø—É—Å–∫ –≤ async/sync —Ä–µ–∂–∏–º–µ
   ‚Üì
5. executeVacuumAnalyze() ‚Üí –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã
   ‚Üì
6. VACUUM ANALYZE table_name (—á–µ—Ä–µ–∑ JDBC)
   ‚Üì
7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è PostgreSQL

- [VACUUM](https://www.postgresql.org/docs/current/sql-vacuum.html)
- [ANALYZE](https://www.postgresql.org/docs/current/sql-analyze.html)
- [REINDEX](https://www.postgresql.org/docs/current/sql-reindex.html)
- [Routine Vacuuming](https://www.postgresql.org/docs/current/routine-vacuuming.html)

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ Zoomos v4

- UI –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –ë–î: `http://localhost:8081/maintenance/database`
- –ê–Ω–∞–ª–∏–∑ bloat: —Ä–∞–∑–¥–µ–ª "–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–¥—É–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü"
- –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—Å—Ç–∫–∏: `SELECT * FROM data_cleanup_history`
- –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: `logs/spring.log`

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
**–î–∞—Ç–∞:** 2025-10-16
**–ü—Ä–æ–µ–∫—Ç:** Zoomos v4
**–ê–≤—Ç–æ—Ä:** Claude Code
